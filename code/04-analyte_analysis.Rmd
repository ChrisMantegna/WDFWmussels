---
title: "04- Analyte Analysis"
output:
  pdf_document: 
    fig_width: 20
    fig_height: 9
  html_document: 
    toc: true
    toc_float:
        collapsed: false
        smooth_scroll: true
    fig_width: 20
---

# Directory and doc rules

```{r, setup, eval=TRUE, include=TRUE}

knitr::opts_chunk$set(
  root.dir = here::here(),
  echo = TRUE,         # Display code chunks
  eval = TRUE,         # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  #fig.width = 15,       # Set plot width in inches
  #fig.height = 9,      # Set plot height in inches
  fig.align = "center" # Align plots to the center
)

```

# Load & Check Data
```{r}

# double check where you are
# *NOTE* see 00-data_cleaned for directory issue
getwd()

# load data
# complete df
data<- read.csv("../data/cleaned/avg_all_analytes_individual.csv")
hch<- read.csv("../data/cleaned/avg_all_chlordanesHch.csv")
pest<-read.csv("../data/cleaned/avg_all_ddtPesticide.csv")
hmw<- read.csv("../data/cleaned/avg_all_hmw.csv")
lmw<- read.csv("../data/cleaned/avg_all_lmw.csv")
metal<- read.csv("../data/cleaned/avg_all_metal.csv")
pbde<- read.csv("../data/cleaned/avg_all_pbde.csv")
pcb<- read.csv("../data/cleaned/avg_all_pcb.csv")
summed<- read.csv("../data/cleaned/avg_all_summed.csv")

# check it out
#str(data) # checking df structure
# note that sample_id and site_number are integers and may need to be adjusted to characters for analysis

#summary(data) #checking df contents

#colnames(data) <- tolower(colnames(data)) # if needed

```

# Spearman Correlations
## Individual Analytes
### All metrics, looped
```{r}
# Load required libraries
library(ggplot2)
library(dplyr)

# Load your dataset
data<- read.csv("../data/cleaned/avg_all_analytes_individual.csv")

# Create an empty results data frame
results_df <- data.frame()

# Metrics of interest (Columns 9-14)
metrics_of_interest <- colnames(data)[9:14]

# Columns to analyze against (Columns 15-144)
analysis_columns <- colnames(data)[15:144]

# Loop through each metric of interest
for (metric in metrics_of_interest) {
  
  for (compare_col in analysis_columns) {
    
    # Perform Spearman correlation test
    correlation_result <- cor.test(data[[metric]], data[[compare_col]], method = "spearman")
    
    # Append to results data frame
    results_df <- rbind(results_df, 
      data.frame(
        Metric = metric,
        Compared_With = compare_col,
        Spearman_Rho = correlation_result$estimate,
        P_Value = correlation_result$p.value
      ))
  }
}

# Print summary of correlation results
print(results_df)

# Save results to CSV
write.csv(results_df, "/Users/cmantegna/Documents/GitHub/WDFWmussels/output/spearman_results_individual_analytes.csv", row.names = FALSE)

# ðŸ” Filter significant correlations (p < 0.05)
significant_results <- results_df %>% filter(P_Value < 0.05)

# ðŸŽ¨ Plot each significant correlation as scatter plot with trendline and save as PNG
for (i in 1:nrow(significant_results)) {
  
  metric <- significant_results$Metric[i]
  compared_with <- significant_results$Compared_With[i]
  
  # Generate scatter plot with trendline
  plot <- ggplot(data, aes_string(x = compared_with, y = metric)) +
    geom_point(color = "blue", alpha = 0.6) +
    geom_smooth(method = "lm", color = "red", se = FALSE) +  # Trendline (linear model)
    labs(
      title = paste("Significant Spearman Correlation:", metric, "vs", compared_with),
      subtitle = paste("Spearman Rho:", round(significant_results$Spearman_Rho[i], 2), "| p =", round(significant_results$P_Value[i], 4)),
      x = compared_with,
      y = metric
    ) +
    theme_minimal()
  
  # Save plot to "output" folder
  plot_filename <- paste0("/Users/cmantegna/Documents/GitHub/WDFWmussels/output/", metric, "_vs_", compared_with, ".png")
  ggsave(plot_filename, plot, width = 8, height = 6, dpi = 300)
  
  # Display plot in R
  print(plot)
}


```

# Spearman Correlations
## Summed & Grouped Analytes
### All metrics, looped
```{r}

# Load required libraries
library(ggplot2)
library(dplyr)

# Assume 8 datasets stored in a list
datasets <- list(hch, hmw, lmw, metal, pbde, pcb, pest, summed)

# Create an empty results data frame
all_results_df <- data.frame()

# Loop through datasets
for (d in seq_along(datasets)) {
  
  data <- datasets[[d]]  # Get current dataset
  dataset_name <- paste0("Dataset_", d)  # Naming for tracking
  
  # Metrics of interest (Columns 9-14)
  metrics_of_interest <- colnames(data)[9:14]
  
  for (metric in metrics_of_interest) {
    
    # Identify columns to compare against (excluding latitude, longitude, and metric itself)
    comparison_cols <- setdiff(colnames(data), c("site_name", "site_number", "reporting_area", "pcb_group", "pah_group",  "latitude", "longitude", "geo_group", metric))
    
    for (compare_col in comparison_cols) {
      
      # Perform Spearman correlation test
      correlation_result <- cor.test(data[[metric]], data[[compare_col]], method = "spearman")

      # Append to results data frame
      all_results_df <- rbind(all_results_df, 
        data.frame(
          Dataset = dataset_name,
          Metric = metric,
          Compared_With = compare_col,
          Spearman_Rho = correlation_result$estimate,
          P_Value = correlation_result$p.value
        ))
    }
  }
}

# Print summary of correlation results
print(all_results_df)

# Save to CSV if needed
write.csv(all_results_df, "spearman_results_grouped_analytes.csv", row.names = FALSE)

# ðŸ” Filter significant correlations (p < 0.05)
significant_results <- all_results_df %>% filter(P_Value < 0.05)

# ðŸŽ¨ Plot each significant correlation as scatter plot with trendline
for (i in 1:nrow(significant_results)) {
  
  dataset_name <- significant_results$Dataset[i]
  metric <- significant_results$Metric[i]
  compared_with <- significant_results$Compared_With[i]
  
  # Get the relevant dataset
  data <- datasets[[as.numeric(gsub("Dataset_", "", dataset_name))]]
  
  # Generate scatter plot with trendline
  plot <- ggplot(data, aes_string(x = compared_with, y = metric)) +
    geom_point(color = "blue", alpha = 0.6) +
    geom_smooth(method = "lm", color = "red", se = FALSE) +  # Trendline (linear model)
    labs(
      title = paste("Significant Spearman Correlation:", metric, "vs", compared_with),
      subtitle = paste("Dataset:", dataset_name, "| Spearman Rho:", round(significant_results$Spearman_Rho[i], 2), "| p =", round(significant_results$P_Value[i], 4)),
      x = compared_with,
      y = metric
    ) +
    theme_minimal()
  
  # Save plot to "output" folder
  plot_filename <- paste0("/Users/cmantegna/Documents/GitHub/WDFWmussels/output/", dataset_name, "_", metric, "_vs_", compared_with, ".png")
  ggsave(plot_filename, plot, width = 8, height = 6, dpi = 300)
  
  # Display plot
  print(plot)
}

```

# Kruskal- Wallis + Post Hoc
## Individual analytes
### Analysis groups
```{r}

# Load required libraries
library(dplyr)
library(ggplot2)

# Convert group columns to factors
groups <- c("geo_group", "reporting_area", "pah_group", "pcb_group", "site_number")

data <- data %>%
  mutate(across(all_of(groups), as.factor))  # Convert groups to factors

# Verify conversion
str(data[groups])  # Check that the groups are now factors

```

```{r}

# Create an empty results dataframe
kruskal_results <- data.frame()

# Loop through each metric and categorical group
for (metric in colnames(data)[9:14]) {
  
  for (group in groups) {
    
    # Perform Kruskal-Wallis test
    kruskal_test <- kruskal.test(data[[metric]] ~ data[[group]])
    
    # Store results
    kruskal_results <- rbind(kruskal_results, 
      data.frame(
        Metric = metric,
        Group = group,
        Chi_Square = kruskal_test$statistic,
        P_Value = kruskal_test$p.value
      ))
  }
}

# Save Kruskal-Wallis results
write.csv(kruskal_results, "/Users/cmantegna/Documents/GitHub/WDFWmussels/output/kw_results_individual_analytes.csv", row.names = FALSE)

# Print significant results
significant_kruskal <- kruskal_results %>% filter(P_Value < 0.05)
print(significant_kruskal)

```

# Spearman Correlations
## Individual analytes
### Analysis groups
```{r}

```

