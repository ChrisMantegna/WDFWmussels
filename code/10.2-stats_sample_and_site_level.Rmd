---
title: "10.2- Running Stats at the Sample and Site Levels"
output:
  pdf_document: 
    fig_width: 20
    fig_height: 9
  html_document: 
    toc: true
    toc_float:
        collapsed: false
        smooth_scroll: true
    fig_width: 20
---

# Directory and doc rules

```{r, setup, eval=TRUE, include=TRUE, echo=FALSE}

# libraries
library(knitr) # output formatting
library(tidyr) # data wrangling
library(tidyverse) # data wrangling
library(dplyr) # data wrangling
library(vegan) # ecological stats 
library(cluster) # grouping metrics - VERIFY still needed
library(pgirmess) # stats - KW
library(ggplot2) # plots
library(factoextra) # pca/ nmds/ tweaking radars
library(FactoMineR) # pca/ nmds/ tweaking radars
library(FSA) # post hoc test - Dunn's Test       
library(rstatix) # VERIFY what this is for      
library(car) # VERIFY what this is for  
library(RVAideMemoire) # post hoc test for permanova
library(rcompanion) # for annotation of permanova
library(scales) # scaling data for IBR - works with data wrangling packages
library(fmsb) # polygon calculations for the radars
library(devtools)

knitr::opts_chunk$set(
  root.dir = here::here(),
  echo = TRUE,         # show code chunks
  eval = TRUE,         # evaluate code chunks
  warning = FALSE,     # hide warnings
  message = FALSE,     # hide messages
  #fig.width = 15,       # set plot width in inches
  #fig.height = 9,      # set plot height in inches
  fig.align = "center" # slign plots to the center in output doc/ slide/ whatever
)

```

# Load & Check Data
```{r}

getwd()
#setwd("/Users/cmantegna/Documents/GitHub/WDFWmussels") # something here isn't working right - check out why

all_data<- read.csv("../data/index_df/ibr_for_averaging.csv")
avg_data<- read.csv("../data/index_df/avg_metrics_ibr_indices_for_correlations.csv")   

```

# Data prep
```{r}

# make site_number & reporting area a factor in both dfs

all_data$reporting_area <- as.factor(all_data$reporting_area)
avg_data$reporting_area <- as.factor(avg_data$reporting_area)

all_data$site_number <- as.factor(all_data$site_number)
avg_data$site_number <- as.factor(avg_data$site_number)

```

## add contaminant indices to sample- level df
```{r}

site_df<- read.csv("../data/index_df/contaminant_indices_only.csv")

all_data_complete_indices <- all_data %>%
  left_join(site_df, by = "site_name")

head(all_data_complete_indices)

# write it out
#write.csv(all_data_complete_indices, "/Users/cmantegna/Documents/Github/WDFWmussels/data/index_df/complete_sample_level.csv", row.names = FALSE) 

```

# Normality, similarity and variance all tested in 10.1 to validate groupings

# KW 
## individual sample - level
```{r}

#KW
#kruskal.test(p450 ~ site_name, data = df1) # p-value = 4.219e-06
#kruskal.test(p450 ~ reporting_area, data = df1) # p-value = 4.09e-05

kruskal.test(sod ~ site_name, data = df1) # p-value = 0.002259
kruskal.test(sod ~ reporting_area, data = df1) # p-value = 0.3136

kruskal.test(ci1 ~ site_name, data = df1) # p-value = 0.0006876
kruskal.test(ci1 ~ reporting_area, data = df1) # p-value = 0.7855

kruskal.test(ci2 ~ site_name, data = df1) # p-value = 3.173e-08
kruskal.test(ci2 ~ reporting_area, data = df1) # p-value = 0.3396

kruskal.test(ci3 ~ site_name, data = df1) # p-value = 0.0001327
kruskal.test(ci3 ~ reporting_area, data = df1) # p-value = 0.02201

kruskal.test(ibr_bio ~ site_name, data = df1) # p-value = 0.002612
kruskal.test(ibr_bio ~ reporting_area, data = df1) # p-value = 0.0001853

kruskal.test(ibr_morph ~ site_name, data = df1) # p-value = 0.08877
kruskal.test(ibr_morph ~ reporting_area, data = df1) # p-value = 0.02514

kruskal.test(ibr_overall ~ site_name, data = df1) # p-value = 0.0134
kruskal.test(ibr_overall ~ reporting_area, data = df1) # p-value = 0.001949

```



## p450
```{r}

#p450 - site is not significant
dunn_result <- dunnTest(p450 ~ site_name, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/p450site.csv", row.names = FALSE) # write it out

#p450 - reporting area is significant
dunn_result <- dunnTest(p450 ~ reporting_area, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/p450ra.csv", row.names = FALSE) # write it out

groups <- unique(c(dunn_df$Group1, dunn_df$Group2))

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/p450ra.csv", row.names = FALSE) # write it out

#p450 - geo_6 is significant
dunn_result <- dunnTest(p450 ~ geo_cluster_6, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
library(multcompView)

groups <- unique(c(dunn_df$Group1, dunn_df$Group2))

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/p450geo6.csv", row.names = FALSE) # write it out

#p450 - geo_9 is significant
dunn_result <- dunnTest(p450 ~ geo_cluster_9, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2))

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/p450geo9.csv", row.names = FALSE) # write it out
```

## sod
```{r}

#sod - site is not significant
dunn_result <- dunnTest(sod ~ site_name, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/sodsite.csv", row.names = FALSE) # write it out

#sod - geo6 is not significant
dunn_result <- dunnTest(sod ~ geo_cluster_6, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view



```

## ci1
```{r}

#ci1 - site is significant
dunn_result <- dunnTest(ci1 ~ site_name, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ci1site.csv", row.names = FALSE) # write it out

```

## ci2
```{r}

#ci2 - site is not significant
dunn_result <- dunnTest(ci2 ~ site_name, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/sodsite.csv", row.names = FALSE) # write it out


```

## ci3
```{r}

#ci3 - site is not significant
dunn_result <- dunnTest(ci3 ~ site_name, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/sodsite.csv", row.names = FALSE) # write it out

#ci3 - reporting area is significant
dunn_result <- dunnTest(ci3 ~ reporting_area, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ci3ra.csv", row.names = FALSE) # write it out

#ci3 - geo6 is significant
dunn_result <- dunnTest(ci3 ~ geo_cluster_6, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ci3geo6.csv", row.names = FALSE) # write it out

#ci3 - geo9 is significant
dunn_result <- dunnTest(ci3 ~ geo_cluster_9, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ci3geo9.csv", row.names = FALSE) # write it out

```

## ibr_bio
```{r}

#ibrbio - site is not significant
dunn_result <- dunnTest(ibr1bio ~ site_name, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/sodsite.csv", row.names = FALSE) # write it out

#ibrbio - reporting area is significant
dunn_result <- dunnTest(ibr1bio ~ reporting_area, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ibr1biora.csv", row.names = FALSE) # write it out

#ibrbio - geo6 is significant
dunn_result <- dunnTest(ibr1bio ~ geo_cluster_6, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ibr1biogeo6.csv", row.names = FALSE) # write it out

#ibrbio - geo9 is significant
dunn_result <- dunnTest(ibr1bio ~ geo_cluster_9, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ibr1biogeo9.csv", row.names = FALSE) # write it out

```

## ibr_morph 
```{r}

data$reporting_area <- as.factor(data$reporting_area)

#ibrmorph - reporting area is significant
dunn_result <- dunnTest(ibr1morph ~ reporting_area, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/morphra.csv", row.names = FALSE) # write it out

#ibrmorph - geo2 will not run
dunn_result <- dunnTest(ibr1morph ~ geo_cluster, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/morphgeo2.csv", row.names = FALSE) # write it out

#ibrmorph - geo6 is significant
dunn_result <- dunnTest(ibr1morph ~ geo_cluster_6, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/morphgeo6.csv", row.names = FALSE) # write it out

#ibrmorph - geo9 is not significant
dunn_result <- dunnTest(ibr1morph ~ geo_cluster_9, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/morphgeo9.csv", row.names = FALSE) # write it out

```

## ibr_overall
```{r}

#ibroverall - site
dunn_result <- dunnTest(ibr1overall ~ site_name, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/sodsite.csv", row.names = FALSE) # write it out

#ibrall - reporting area is significant
dunn_result <- dunnTest(ibr1overall ~ reporting_area, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ibroverallra.csv", row.names = FALSE) # write it out

#ibrall - geo6
dunn_result <- dunnTest(ibr1overall ~ geo_cluster_6, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ibroverallgeo6.csv", row.names = FALSE) # write it out

#ibrall - geo9
dunn_result <- dunnTest(ibr1overall ~ geo_cluster_9, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ibroverallgeo9.csv", row.names = FALSE) # write it out

```

# ANOVA + post hoc
## individual sample - level
## shell
```{r}

anova_site <- aov(shell ~ site_name, data = df1) # p=5.84e-16 ***
anova_ra <- aov(shell ~ reporting_area, data = df1) # p= 1.09e-06 ***
anova_6 <- aov(shell ~ geo_cluster_6, data = data) # p= 1.19e-06 ***
anova_9 <- aov(shell ~ geo_cluster_9, data = data) # p= 3.08e-06 ***
summary(anova_site)
summary(anova_ra)
summary(anova_6)
summary(anova_9)

#post - site is significant
tukey_site <- TukeyHSD(anova_site, "site_name")
tukey_df <- as.data.frame(tukey_site$site_name)

tukey_df <- tukey_df %>%
  tibble::rownames_to_column("Comparison") %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = "-") %>%
  rename(Diff = diff, Lower = lwr, Upper = upr, P.adj = `p adj`) %>%
  mutate(across(everything(), ~trimws(as.character(.)))) %>%  
  mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

groups <- unique(c(tukey_df$Group1, tukey_df$Group2))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(tukey_df)) {
  g1 <- tukey_df$Group1[i]
  g2 <- tukey_df$Group2[i]
  pval <- as.numeric(tukey_df$P.adj[i])
  pval_matrix[g1, g2] <- pval
  pval_matrix[g2, g1] <- pval
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters

cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

tukey_table_with_cld <- tukey_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld) #view
write.csv(tukey_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/shellsite.csv", row.names = FALSE) #save

#post - reporting area
tukey_ra <- TukeyHSD(anova_ra, "reporting_area")
tukey_df <- as.data.frame(tukey_ra$reporting_area)

tukey_df <- tukey_df %>%
  tibble::rownames_to_column("Comparison") %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = "-") %>%
  rename(Diff = diff, Lower = lwr, Upper = upr, P.adj = `p adj`) %>%
  mutate(across(everything(), ~trimws(as.character(.)))) %>%  
  mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

groups <- unique(c(tukey_df$Group1, tukey_df$Group2))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(tukey_df)) {
  g1 <- tukey_df$Group1[i]
  g2 <- tukey_df$Group2[i]
  pval <- as.numeric(tukey_df$P.adj[i])
  pval_matrix[g1, g2] <- pval
  pval_matrix[g2, g1] <- pval
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters

cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

tukey_table_with_cld <- tukey_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld) #view
write.csv(tukey_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/shellra.csv", row.names = FALSE) #save

#post - geo6
tukey_6 <- TukeyHSD(anova_6, "geo_cluster_6")
tukey_df <- as.data.frame(tukey_6$geo_cluster_6)

tukey_df <- tukey_df %>%
  tibble::rownames_to_column("Comparison") %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = "-") %>%
  rename(Diff = diff, Lower = lwr, Upper = upr, P.adj = `p adj`) %>%
  mutate(across(everything(), ~trimws(as.character(.)))) %>%  
  mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

groups <- unique(c(tukey_df$Group1, tukey_df$Group2))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(tukey_df)) {
  g1 <- tukey_df$Group1[i]
  g2 <- tukey_df$Group2[i]
  pval <- as.numeric(tukey_df$P.adj[i])
  pval_matrix[g1, g2] <- pval
  pval_matrix[g2, g1] <- pval
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters

cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

tukey_table_with_cld <- tukey_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld) #view
write.csv(tukey_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/shellgeo6.csv", row.names = FALSE) #save

#post - geo9
tukey_9 <- TukeyHSD(anova_9, "geo_cluster_9")
tukey_df <- as.data.frame(tukey_9$geo_cluster_9)

tukey_df <- tukey_df %>%
  tibble::rownames_to_column("Comparison") %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = "-") %>%
  rename(Diff = diff, Lower = lwr, Upper = upr, P.adj = `p adj`) %>%
  mutate(across(everything(), ~trimws(as.character(.)))) %>%  
  mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

groups <- unique(c(tukey_df$Group1, tukey_df$Group2))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(tukey_df)) {
  g1 <- tukey_df$Group1[i]
  g2 <- tukey_df$Group2[i]
  pval <- as.numeric(tukey_df$P.adj[i])
  pval_matrix[g1, g2] <- pval
  pval_matrix[g2, g1] <- pval
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters

cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

tukey_table_with_cld <- tukey_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld) #view
write.csv(tukey_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/shellgeo9.csv", row.names = FALSE) #save

```

# Correlations, Spearman & Kendalls
## site-level
## data prep
```{r}

# cleaning up site names and then averaging by site for new df
data$site_name <- trimws(data$site_name)
data <- data %>%
  filter(!is.na(site_name), site_name != "")

df_sites <- data %>%
  group_by(site_name, reporting_area) %>% 
  summarise(
    latitude= first(latitude),
    longitude= first(longitude),
    geo_cluster_6= first(geo_cluster_6),
    geo_cluster_9= first(geo_cluster_9),
    p450 = mean(p450, na.rm = TRUE),
    sod = mean(sod, na.rm = TRUE),
    shell = mean(shell, na.rm = TRUE),
    ci1 = mean(ci1, na.rm = TRUE),
    ci2 = mean(ci2, na.rm = TRUE),
    ci3 = mean(ci3, na.rm = TRUE),
    ibr1bio = mean(ibr1bio, na.rm = TRUE),  # or whatever your IBR column is called
    ibr1morph = mean(ibr1morph, na.rm = TRUE),
    ibr1overall = mean(ibr1overall, na.rm = TRUE),
    n_samples = n()
  ) %>%
  ungroup()

head(df_sites)
write.csv(df_sites, "/Users/cmantegna/Documents/Github/WDFWmussels/data/cleaned/avg_ibr1_geo_groups.csv", row.names = FALSE)

# pivoting analyte and metal table to match the format of the biomarker table
# remove trailing white spaces from the site names before pivoting
df4$analyte <- as.character(df4$analyte)
df4$analyte <- trimws(df4$analyte)
df4 <- df4 %>%
  filter(!is.na(analyte), analyte != "")

analytes <- df4 %>%
  select(site_name, analyte, dry_value) %>%
  pivot_wider(
    names_from = analyte,
    values_from = dry_value
  )

# join to df1
df1_analytes <- df_sites %>%
  left_join(analytes, by = c("site_name"))

# metals
metals <- metal_long %>%
  select(site_name, latitude, longitude, analyte, dry_value) %>%
  pivot_wider(
    names_from = analyte,
    values_from = dry_value
  )

# join to df1
df1_metal <- df_sites %>%
  left_join(metals, by = c("site_name"))

#write.csv(df1_analytes, "/Users/cmantegna/Documents/Github/WDFWmussels/data/cleaned/avg_ibr1_analytess.csv", row.names = FALSE)

```

## metrics + ibr
```{r}

# Define your variable sets
metrics_vars <- c("p450", "sod", "shell", "ci1", "ci2", "ci3")

# List any ID columns to exclude here
id_columns <- c("site_name", "reporting_area", "latitude", "longitude", "n_samples")

# Build analyte_vars by excluding both metrics and IDs
analyte_vars <- c("ibr1bio", "ibr1morph", "ibr1overall")

# set p-value & initialize empty list
alpha <- 0.05
results_list <- list()

# Loop over metric–analyte pairs across sites
for (metric in metrics_vars) {
  for (analyte in analyte_vars) {
    
    x <- df_sites[[metric]]
    y <- df_sites[[analyte]]
    
    valid_idx <- complete.cases(x, y)
    x_valid <- x[valid_idx]
    y_valid <- y[valid_idx]
    
    if (length(x_valid) < 4) next  # Skip if too few values
    
    spearman <- cor.test(x_valid, y_valid, method = "spearman")
    kendall <- cor.test(x_valid, y_valid, method = "kendall")
    
    results_list[[paste(metric, analyte, sep = "_")]] <- data.frame(
      Metric = metric,
      Analyte = analyte,
      Spearman_r = as.numeric(spearman$estimate),
      Spearman_p = as.numeric(spearman$p.value),
      Kendall_tau = as.numeric(kendall$estimate),
      Kendall_p = as.numeric(kendall$p.value)
    )
  }
}

# Combine results
corr_full <- bind_rows(results_list)

# Add significance stars
corr_full <- corr_full %>%
  mutate(
    Spearman_sig = case_when(
      Spearman_p <= 0.001 ~ "***",
      Spearman_p <= 0.01  ~ "**",
      Spearman_p <= 0.05  ~ "*",
      TRUE ~ ""
    ),
    Kendall_sig = case_when(
      Kendall_p <= 0.001 ~ "***",
      Kendall_p <= 0.01  ~ "**",
      Kendall_p <= 0.05  ~ "*",
      TRUE ~ ""
    )
  )


View(corr_full)
write.csv(corr_full, "/Users/cmantegna/Documents/Github/WDFWmussels/output/correlation_ibr_biomarkers.csv", row.names = FALSE)


```


## analytes
```{r}

# Define your variable sets
metrics_vars <- c("p450", "sod", "shell", "ci1", "ci2", "ci3", 
                  "ibr1bio", "ibr1morph", "ibr1overall")
# List any ID columns to exclude here
id_columns <- c("site_name", "reporting_area", "latitude", "longitude")

# Build analyte_vars by excluding both metrics and IDs
analyte_vars <- colnames(df1_analytes)[!(colnames(df1_analytes) %in% c(metrics_vars, id_columns))]

# set p-value & initialize empty list
alpha <- 0.05
results_list <- list()

# Loop over metric–analyte pairs across sites
for (metric in metrics_vars) {
  for (analyte in analyte_vars) {
    
    x <- df1_analytes[[metric]]
    y <- df1_analytes[[analyte]]
    
    valid_idx <- complete.cases(x, y)
    x_valid <- x[valid_idx]
    y_valid <- y[valid_idx]
    
    if (length(x_valid) < 4) next  # Skip if too few values
    
    spearman <- cor.test(x_valid, y_valid, method = "spearman")
    kendall <- cor.test(x_valid, y_valid, method = "kendall")
    
    results_list[[paste(metric, analyte, sep = "_")]] <- data.frame(
      Metric = metric,
      Analyte = analyte,
      Spearman_r = as.numeric(spearman$estimate),
      Spearman_p = as.numeric(spearman$p.value),
      Kendall_tau = as.numeric(kendall$estimate),
      Kendall_p = as.numeric(kendall$p.value)
    )
  }
}

# Combine results
corr_full <- bind_rows(results_list)

# Add significance stars
corr_full <- corr_full %>%
  mutate(
    Spearman_sig = case_when(
      Spearman_p <= 0.001 ~ "***",
      Spearman_p <= 0.01  ~ "**",
      Spearman_p <= 0.05  ~ "*",
      TRUE ~ ""
    ),
    Kendall_sig = case_when(
      Kendall_p <= 0.001 ~ "***",
      Kendall_p <= 0.01  ~ "**",
      Kendall_p <= 0.05  ~ "*",
      TRUE ~ ""
    )
  )


View(corr_full)
#write.csv(corr_full, "/Users/cmantegna/Documents/Github/WDFWmussels/output/correlation_analytes.csv", row.names = FALSE)

# adding the chemical class to the correlation table
df4$analyte <- tolower(df4$analyte)
corr_full$Analyte <- tolower(corr_full$Analyte) 

# find unique analytes & merge
df4_clean <- df4 %>%
  distinct(analyte, .keep_all = TRUE)  # Keep only one row per analyte

corr_full <- merge(corr_full, df4_clean[, c("analyte", "class")],
                   by = "analyte", all.x = TRUE)

# save again
#write.csv(corr_full, "/Users/cmantegna/Documents/Github/WDFWmussels/output/correlation_analytes.csv", row.names = FALSE)

```

## metals
```{r}

# Define your variable sets
metrics_vars <- c("p450", "sod", "shell", "ci1", "ci2", "ci3", 
                  "ibr1bio", "ibr1morph", "ibr1overall")
# List any ID columns to exclude here
id_columns <- c("site_name", "reporting_area", "latitude", "longitude")

# Build analyte_vars by excluding both metrics and IDs
analyte_vars <- c("arsenic", "cadmium", "copper", "lead", "mercury", "zinc")


results_list <- list()

# Loop over metric–analyte pairs across sites
for (metric in metrics_vars) {
  for (analyte in analyte_vars) {
    
    x <- df6[[metric]]
    y <- df6[[analyte]]
    
    valid_idx <- complete.cases(x, y)
    x_valid <- x[valid_idx]
    y_valid <- y[valid_idx]
    
    if (length(x_valid) < 4) next  # Skip if too few values
    
    spearman <- cor.test(x_valid, y_valid, method = "spearman")
    kendall <- cor.test(x_valid, y_valid, method = "kendall")
    
    results_list[[paste(metric, analyte, sep = "_")]] <- data.frame(
      Metric = metric,
      Analyte = analyte,
      Spearman_r = as.numeric(spearman$estimate),
      Spearman_p = as.numeric(spearman$p.value),
      Kendall_tau = as.numeric(kendall$estimate),
      Kendall_p = as.numeric(kendall$p.value)
    )
  }
}

# Combine results
corr_full <- bind_rows(results_list)

# Add significance stars
corr_full <- corr_full %>%
  mutate(
    Spearman_sig = case_when(
      Spearman_p <= 0.001 ~ "***",
      Spearman_p <= 0.01  ~ "**",
      Spearman_p <= 0.05  ~ "*",
      TRUE ~ ""
    ),
    Kendall_sig = case_when(
      Kendall_p <= 0.001 ~ "***",
      Kendall_p <= 0.01  ~ "**",
      Kendall_p <= 0.05  ~ "*",
      TRUE ~ ""
    )
  )

# View result
view(corr_full)

#write.csv(corr_full, "/Users/cmantegna/Documents/Github/WDFWmussels/output/correlation_metals.csv", row.names = FALSE)

```


# Interaction Assessment
## test name
```{r}



```


# Spatial Autocorrelation - redo this whole workflow, something is wrong
## Moran's I and Spearman
```{r}

ibr_analytes<- read.csv("../data/cleaned/avg_ibr1_analytess.csv")
analytes_long<- read.csv("../data/cleaned/analytes_long.csv")
metals_long<- read.csv("../data/cleaned/metals_long.csv")

# Moran's: ibr - analytes
ibr_sf <- st_as_sf(ibr_analytes, coords = c("longitude", "latitude"), crs = 4326)

coords <- st_coordinates(ibr_sf)
nb <- knn2nb(knearneigh(coords, k = 4))   # adjust k if needed
lw <- nb2listw(nb, style = "W")

bio_vars <- c("p450", "sod", "shell", "ci1", "ci2", "ci3", "ibr1bio", "ibr1morph", "ibr1overall")

bio_moran_results <- lapply(bio_vars, function(var) {
  vals <- ibr_sf[[var]]
  if (sum(!is.na(vals)) >= 4 && length(unique(vals[!is.na(vals)])) > 1) {
    m <- moran.test(vals, lw)
    data.frame(
      metric = var,
      moran_i = m$estimate[["Moran I statistic"]],
      expected_i = m$estimate[["Expectation"]],
      sd = if ("Standard deviate" %in% names(m$estimate)) m$estimate[["Standard deviate"]] else NA,
      p_value = m$p.value
    )
  } else {
    NULL
  }
}) %>% bind_rows()

# add significance stars
bio_moran_results <- bio_moran_results %>%
  mutate(
    sig = case_when(
      p_value <= 0.001 ~ "***",
      p_value <= 0.01 ~ "**",
      p_value <= 0.05 ~ "*",
      TRUE ~ ""
    )
  )

# results
print(bio_moran_results)
#write.csv(bio_moran_results, "/Users/cmantegna/Documents/Github/WDFWmussels/output/moran_metrics.csv", row.names = FALSE)


# Moran's: ibr - metals
ibr_sf <- st_as_sf(ibr_metal, coords = c("longitude", "latitude"), crs = 4326)

coords <- st_coordinates(ibr_sf)
nb <- knn2nb(knearneigh(coords, k = 4))   # adjust k if needed
lw <- nb2listw(nb, style = "W")

bio_vars <- c("p450", "sod", "shell", "ci1", "ci2", "ci3", "ibr1bio", "ibr1morph", "ibr1overall")

bio_moran_results <- lapply(bio_vars, function(var) {
  vals <- ibr_sf[[var]]
  if (sum(!is.na(vals)) >= 4 && length(unique(vals[!is.na(vals)])) > 1) {
    m <- moran.test(vals, lw)
    data.frame(
      metric = var,
      moran_i = m$estimate[["Moran I statistic"]],
      expected_i = m$estimate[["Expectation"]],
      sd = if ("Standard deviate" %in% names(m$estimate)) m$estimate[["Standard deviate"]] else NA,
      p_value = m$p.value
    )
  } else {
    NULL
  }
}) %>% bind_rows()

# add significance stars
bio_moran_results <- bio_moran_results %>%
  mutate(
    sig = case_when(
      p_value <= 0.001 ~ "***",
      p_value <= 0.01 ~ "**",
      p_value <= 0.05 ~ "*",
      TRUE ~ ""
    )
  )

# results
print(bio_moran_results)
write.csv(bio_moran_results, "/Users/cmantegna/Documents/Github/WDFWmussels/output/moran_metals.csv", row.names = FALSE)

# Spearman - analytes
results_latlong <- analytes_long %>%
  group_by(analyte) %>%
  summarise(
    corr_lat = cor(dry_value, latitude, method = "spearman", use = "complete.obs"),
    p_lat = cor.test(dry_value, latitude, method = "spearman")$p.value,
    corr_long = cor(dry_value, longitude, method = "spearman", use = "complete.obs"),
    p_long = cor.test(dry_value, longitude, method = "spearman")$p.value,
    .groups = "drop"
  )

# add significance stars
results_latlong <- results_latlong %>%
  mutate(
    lat_sig = case_when(
      p_lat <= 0.001 ~ "***",
      p_lat <= 0.01 ~ "**",
      p_lat <= 0.05 ~ "*",
      TRUE ~ ""
    ),
    long_sig = case_when(
      p_long <= 0.001 ~ "***",
      p_long <= 0.01 ~ "**",
      p_long <= 0.05 ~ "*",
      TRUE ~ ""
    )
  )

view(results_latlong)
#write.csv(results_latlong, "/Users/cmantegna/Documents/Github/WDFWmussels/output/spatial_correlation_analytes.csv", row.names = FALSE)


# Spearman's - metals
results_latlong <- metals_long %>%
  group_by(analyte) %>%
  summarise(
    corr_lat = cor(dry_value, latitude, method = "spearman", use = "complete.obs"),
    p_lat = cor.test(dry_value, latitude, method = "spearman")$p.value,
    corr_long = cor(dry_value, longitude, method = "spearman", use = "complete.obs"),
    p_long = cor.test(dry_value, longitude, method = "spearman")$p.value,
    .groups = "drop"
  )

# add significance stars
results_latlong <- results_latlong %>%
  mutate(
    lat_sig = case_when(
      p_lat <= 0.001 ~ "***",
      p_lat <= 0.01 ~ "**",
      p_lat <= 0.05 ~ "*",
      TRUE ~ ""
    ),
    long_sig = case_when(
      p_long <= 0.001 ~ "***",
      p_long <= 0.01 ~ "**",
      p_long <= 0.05 ~ "*",
      TRUE ~ ""
    )
  )

view(results_latlong)
#write.csv(results_latlong, "/Users/cmantegna/Documents/Github/WDFWmussels/output/spatial_correlation_metals.csv", row.names = FALSE)

```

## Morans I
```{r}

# biomarkers & ibr's
bio_vars <- c("p450", "sod", "ibr1bio", "ibr1morph", "ibr1overall")

bio_moran_results <- lapply(bio_vars, function(var) {
  vals <- df_sf[[var]]
  if (sum(!is.na(vals)) >= 4 && length(unique(vals[!is.na(vals)])) > 1) {
    m <- moran.test(vals, lw)
    data.frame(
      metric = var,
      moran_i = m$estimate[["Moran I statistic"]],
      expected_i = m$estimate[["Expectation"]],
      sd = if ("Standard deviate" %in% names(m$estimate)) m$estimate[["Standard deviate"]] else NA,
      p_value = m$p.value
    )
  } else {
    NULL
  }
}) %>% bind_rows()


# analytes
df_class_summary <- analytes_long %>%
  group_by(site_name, latitude, longitude, class) %>%
  summarise(class_value = mean(dry_value, na.rm = TRUE), .groups = "drop")

library(sf)
df_sf <- st_as_sf(df_class_summary, coords = c("longitude", "latitude"), crs = 4326)

library(spdep)
moran_results <- list()

for (cl in unique(df_sf$class)) {
  sub_sf <- df_sf %>% filter(class == cl)
  
  # Create spatial neighbors (e.g., 4-nearest)
  coords <- st_coordinates(sub_sf)
  nb <- knn2nb(knearneigh(coords, k = 4))
  lw <- nb2listw(nb, style = "W")

  # Run Moran's I on the class_value
  moran <- moran.test(sub_sf$class_value, lw)

  moran_results[[cl]] <- data.frame(
    class = cl,
    moran_i = moran$estimate[["Moran I statistic"]],
    expected_i = moran$estimate[["Expectation"]],
    p_value = moran$p.value
  )
}

moran_results_df <- bind_rows(moran_results)

view(moran_results_df)
write.csv(moran_results_df, "/Users/cmantegna/Documents/Github/WDFWmussels/output/moran_analyte.csv", row.names = FALSE)

# metals
metals_wide <- metals_long %>%
  select(site_name, latitude, longitude, analyte, dry_value) %>%
  pivot_wider(names_from = analyte, values_from = dry_value)

df_sf <- st_as_sf(metals_wide, coords = c("longitude", "latitude"), crs = 4326)

# List of metals
metals <- colnames(df_sf)[!(colnames(df_sf) %in% c("site_name", "geometry"))]

# Create neighbor list
coords <- st_coordinates(df_sf)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")

moran_results <- list()

for (metal in metals) {
  values <- df_sf[[metal]]
  
  if (sum(!is.na(values)) >= 4 && length(unique(values[!is.na(values)])) > 1) {
    moran <- moran.test(values, lw)
    
    moran_results[[metal]] <- data.frame(
      metal = metal,
      moran_i = moran$estimate[["Moran I statistic"]],
      expected_i = moran$estimate[["Expectation"]],
      sd = if ("Standard deviate" %in% names(moran$estimate)) moran$estimate[["Standard deviate"]] else NA,
      p_value = moran$p.value
    )
  } else {
    message(paste("Skipping", metal, "- not enough variation or data."))
  }
}

moran_metals_df <- bind_rows(moran_results) %>%
  mutate(
    sig = case_when(
      p_value <= 0.001 ~ "***",
      p_value <= 0.01 ~ "**",
      p_value <= 0.05 ~ "*",
      TRUE ~ ""
    )
  )
view(moran_metals_df)
write.csv(moran_results_df, "/Users/cmantegna/Documents/Github/WDFWmussels/output/moran_metal.csv", row.names = FALSE)

```
