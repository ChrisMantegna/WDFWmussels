---
title: "11- Creating Analysis Groups and Running Stats"
output:
  pdf_document: 
    fig_width: 20
    fig_height: 9
  html_document: 
    toc: true
    toc_float:
        collapsed: false
        smooth_scroll: true
    fig_width: 20
---

# Directory and doc rules

```{r, setup, eval=TRUE, include=TRUE, echo=FALSE}

# libraries
library(knitr) # output fotmatting
library(tidyr) # data wrangling
library(tidyverse) # data wrangling
library(dplyr) # data wrangling
library(vegan) # ecological stats 
library(cluster) # grouping metrics - VERIFY still needed
library(pgirmess) # stats - KW
library(ggplot2) # plots
library(factoextra) # pca/ nmds/ tweaking radars
library(FactoMineR) # pca/ nmds/ tweaking radars
library(FSA) # post hoc test - Dunn's Test       
library(rstatix) # VERIFY what this is for      
library(car) # VERIFY what this is for  
library(RVAideMemoire) # post hoc test for permanova
library(rcompanion) # for annotation of permanova
library(scales) # scaling data for IBR - works with data wrangling packages
library(fmsb) # polygon calculations for the radars
library(devtools)

knitr::opts_chunk$set(
  root.dir = here::here(),
  echo = TRUE,         # show code chunks
  eval = TRUE,         # evaluate code chunks
  warning = FALSE,     # hide warnings
  message = FALSE,     # hide messages
  #fig.width = 15,       # set plot width in inches
  #fig.height = 9,      # set plot height in inches
  fig.align = "center" # slign plots to the center in output doc/ slide/ whatever
)

```

# Load & Check Data
```{r}

getwd()
#setwd("/Users/cmantegna/Documents/GitHub/WDFWmussels") # something here isn't working right - check out why

df1<- read.csv("../data/cleaned/ibr_1.csv") # penn cove reference site only
df2<- read.csv("../data/cleaned/ibr_2.csv")
#df3<- read.csv("../data/cleaned/ibr_3.csv")
df4<- read.csv("../data/cleaned/analytes_long.csv")
#df5<- read.csv("../data/cleaned/metals_long.csv")
df6<- read.csv("../data/cleaned/avg_ibr1_metals.csv")
ibr_analyte<- read.csv("../data/cleaned/avg_ibr1_analytess.csv")

# clean up names if needed
#df1 <- df1 %>%
#  mutate(across(where(is.character), trimws))


```

```{r}

# make categorical columns factors
df1$site_number <- as.factor(df1$site_number)
df1$sample_id <- as.factor(df1$sample_id)
df1$reporting_area <- as.factor(df1$reporting_area)

```

# Normality - Shapiro-Wilkes
```{r}

shapiro.test(df1$p450) # Not Normal
shapiro.test(df1$sod) # Not Normal
shapiro.test(df1$shell) # Normal - ANOVA for this one
shapiro.test(df1$ci1) # Not Normal
shapiro.test(df1$ci2) # Not Normal
shapiro.test(df1$ci3) # Not Normal
shapiro.test(df1$ibr1bio) # Not Normal
shapiro.test(df1$ibr1morph) # Not Normal
shapiro.test(df1$ibr1overall) # Not Normal

```

# Add groups to match WDFW reporting style
Groups
1. Biomarker- driven grouping - K-means clustering
2. Impervious Surface Percentage (0-10, 10-20, 20-40, 40-100)
3. Concentration Thresholds by contaminant - sketch this out to see if this is something I really need
4. Quantiles - same comment as above

## Create biomarker- driven grouping
### DO NOT rerun
```{r}

# ibr overall yields the same result as the kmeans below - no need to rerun
# Use only rows with non-missing biomarker data
bio_clust_df <- data %>%
  select(sample_id, ibr1overall)

wss <- vector()

# Try values of k from 1 to 10
for (k in 1:10) {
  set.seed(42)
  wss[k] <- kmeans(bio_clust_df, centers = k, nstart = 25)$tot.withinss
}

# Plot the elbow
plot(1:10, wss, type = "b",
     pch = 19, frame = FALSE,
     xlab = "Number of clusters (k)",
     ylab = "Total within-cluster sum of squares",
     main = "Elbow Method for Choosing k")

set.seed(42)
k_opt <- 3  # elbow is distinctly at 2 with 3 close by, I have checked both with no real resolution

kmeans_result <- kmeans(bio_clust_df, centers = k_opt, nstart = 25)

# Add cluster assignment to your working df
bio_clust_df$cluster3 <- as.factor(kmeans_result$cluster)

data <- data %>%
  left_join(bio_clust_df[, c("sample_id", "cluster3")], by = "sample_id")

# saving ibrv2i df
#write.csv(ibrv2i_df, "/Users/cmantegna/Documents/GitHub/WDFWmussels/data/cleaned/ibrv2i_all_scaled_indices_groups.csv", row.names = FALSE)

```

## PCA plot to check clusters
```{r}

# Define variables for PCA
pca_vars <- c("p450", "sod", "shell", "ci1")

# Remove rows with any NA in the selected variables
pca_df <- data %>%
  filter(if_all(all_of(pca_vars), ~ !is.na(.))) %>%
  select(sample_id, geo_cluster_2, all_of(pca_vars))

# Keep only the scaled numeric matrix for PCA
pca_matrix <- pca_df %>%
  select(all_of(pca_vars)) %>%
  as.matrix()

pca_res <- prcomp(pca_matrix, center = TRUE, scale. = FALSE)  # already scaled relative to reference

# Create a scores dataframe
scores_df <- as.data.frame(pca_res$x)
scores_df$sample_id <- pca_df$sample_id
scores_df$geo_cluster_2 <- pca_df$geo_cluster_2

# Plot the first two PCs
ggplot(scores_df, aes(x = PC1, y = PC2, color = geo_cluster_2)) +
  geom_point(size = 3, alpha = 0.8) +
  labs(title = "PCA of Scaled Biomarkers + Morphometrics",
       x = paste0("PC1 (", round(summary(pca_res)$importance[2, 1] * 100, 1), "% variance)"),
       y = paste0("PC2 (", round(summary(pca_res)$importance[2, 2] * 100, 1), "% variance)"),
       color = "Cluster") +
  theme_minimal() +
  theme(legend.position = "right")

```

## Create geographic grouping
### K-Means for Geographic Groups

```{r}

## 2,6, and 9 clusters are optimal using this method - test with anosim

geo_data <- data.frame(lat = data$latitude, lon = data$longitude) # pulling out lat/ long

fviz_nbclust(geo_data, kmeans, method = "wss") +
  ggtitle("Elbow Method for Optimal Geographic Clusters") # Compute within-cluster sum of squares for different k values

fviz_nbclust(geo_data, kmeans, method = "silhouette") +
  ggtitle("Silhouette Method for Geographic Clustering") # visual check cluster quality

set.seed(123)  # Ensure reproducibility

gap_stat <- clusGap(geo_data, FUN = kmeans, K.max = 10, B = 50)
fviz_gap_stat(gap_stat) # statistical test for cluster quality

# plot to see that the optimal cluster count is a reliable metric in real life
set.seed(123)  # Ensure consistent results
k_optimal <- 2  # Choose based on elbow/silhouette/gap methods

# Run k-means
km <- kmeans(geo_data, centers = k_optimal, nstart = 25)

# Add cluster assignments to dataset
data$geo_cluster <- as.factor(km$cluster)

ggplot(data, aes(x = longitude, y = latitude, color = geo_cluster)) +
  geom_point(size = 3) +
  ggtitle("Geographic Clusters of Sampling Sites") +
  xlab("Longitude") + ylab("Latitude")


```

# ANOSIM, Analysis of similarity
```{r}

df_anosim <- data

# Create a new distance matrix
dist_matrix <- vegdist(df_anosim %>%
                         select(p450, sod, shell, ci1, ci2, ci3, ibr1bio, ibr1morph, ibr1overall) %>%
                         scale(), method = "euclidean")

# Run ANOSIM
anosim_results <- anosim(dist_matrix, grouping = df_anosim$site_name)
print(anosim_results)

#Interpretation:
#If R > 0.5 and p < 0.05, group differences are meaningful.
#If R < 0.2, groups are not well-separated.

```

# Verifying K-Means Cluster Counts - MOVE to 12-viz
```{r}

set.seed(123)
km2 <- kmeans(geo_data, centers = 2, nstart = 25)
km6 <- kmeans(geo_data, centers = 6, nstart = 25)
km9 <- kmeans(geo_data, centers = 9, nstart = 25)


# Add new clusters
data$geo_cluster_2 <- as.factor(km2$cluster)
data$geo_cluster_6 <- as.factor(km6$cluster)
data$geo_cluster_9 <- as.factor(km9$cluster)

# Plot- map without the map underlay
ggplot(data, aes(x = longitude, y = latitude, color = geo_cluster_2)) +
  geom_point(size = 3) + ggtitle("Geographic Clusters (k=4)") +
  xlab("Longitude") + ylab("Latitude")

ggplot(data, aes(x = longitude, y = latitude, color = geo_cluster_6)) +
  geom_point(size = 3) + ggtitle("Geographic Clusters (k=4)") +
  xlab("Longitude") + ylab("Latitude")

ggplot(data, aes(x = longitude, y = latitude, color = geo_cluster_9)) +
  geom_point(size = 3) + ggtitle("Geographic Clusters (k=5)") +
  xlab("Longitude") + ylab("Latitude")


```

# Mapping Clusters - MOVE this to 12-viz
## moving forward with K-Means 4 & 5 + Hierarchical 4 & 5
```{r}

library(sf)
library(ggmap, 'maps')
library("cowplot")

usa <- map_data("usa")
gg1 <-ggplot() + geom_polygon(data = usa, aes(x=long, y = lat, group = group)) + 
  coord_fixed(1.3) 

states <- map_data("state")
head(states)

wa_df <- subset(states, region== "washington")
head(wa_df)

counties <- map_data("county")
wa_county <- subset(counties, region== "washington")
head(wa_county)

#### troubleshooting why the combined plot is not working
str(wa_df)      # Ensure 'group' is numeric or factor
summary(wa_df)
str(data)  # Ensure 'longitude', 'latitude', and 'geo_hclust3' exist
summary(data)  # Check for missing values
"group" %in% colnames(data)  # Should return FALSE
class(data)  # Should return "data.frame"

print(wa_base + geom_point(data = data, aes(x = longitude, y = latitude, color = geo_hclust3), size = 3))


#data$geo_hclust3<- as.factor(data$geo_hclust3) 
#### end of troubleshooting

wa_base <- ggplot(data = wa_df, mapping = aes(x = long, y = lat, group = as.factor(group))) + 
  coord_fixed(1.3) + 
  geom_polygon(color = "black", fill = "gray")
wa_base + theme_nothing()

print(wa_base)

#hc 3
wa_base + 
  geom_point(data = data, aes(x = longitude, y = latitude, color = as.factor(geo_hclust3)), size = 3, inherit.aes = FALSE) +
  ggtitle("Geographic Clusters of Sampling Sites")

#hc 4
wa_base + 
  geom_point(data = data, aes(x = longitude, y = latitude, color = as.factor(geo_hclust4)), size = 3, inherit.aes = FALSE) +
  ggtitle("Geographic Clusters of Sampling Sites")

#group 4
wa_base + 
  geom_point(data = data, aes(x = longitude, y = latitude, color = as.factor(geo_cluster_4)), size = 3, inherit.aes = FALSE) +
  ggtitle("Geographic Clusters of Sampling Sites")

#group 5
wa_base + 
  geom_point(data = data, aes(x = longitude, y = latitude, color = as.factor(geo_cluster_5)), size = 3, inherit.aes = FALSE) +
  ggtitle("Geographic Clusters of Sampling Sites")

# group 6
wa_base + 
  geom_point(data = data, aes(x = longitude, y = latitude, color = as.factor(geo_cluster_6)), size = 3, inherit.aes = FALSE) +
  ggtitle("Geographic Clusters of Sampling Sites")

```

# Write out the data df with all of the geo groups
```{r}

getwd()

write.csv(data, "/Users/cmantegna/Documents/GitHub/WDFWmussels/data/cleaned/full_data_all_geo_groups.csv")

```

# KW + post hoc
```{r}

#KW
kruskal.test(p450 ~ site_name, data = df1) # p-value = 4.219e-06
kruskal.test(p450 ~ reporting_area, data = df1) # p-value = 4.09e-05

kruskal.test(sod ~ site_name, data = df1) # p-value = 0.002259
kruskal.test(sod ~ reporting_area, data = df1) # p-value = 0.3136

kruskal.test(ci1 ~ site_name, data = df1) # p-value = 0.0006876
kruskal.test(ci1 ~ reporting_area, data = df1) # p-value = 0.7855

kruskal.test(ci2 ~ site_name, data = df1) # p-value = 3.173e-08
kruskal.test(ci2 ~ reporting_area, data = df1) # p-value = 0.3396

kruskal.test(ci3 ~ site_name, data = df1) # p-value = 0.0001327
kruskal.test(ci3 ~ reporting_area, data = df1) # p-value = 0.02201

kruskal.test(ibr1bio ~ site_name, data = df1) # p-value = 0.002612
kruskal.test(ibr1bio ~ reporting_area, data = df1) # p-value = 0.0001853

kruskal.test(ibr1morph ~ site_name, data = df1) # p-value = 0.08877
kruskal.test(ibr1morph ~ reporting_area, data = df1) # p-value = 0.02514

kruskal.test(ibr1overall ~ site_name, data = df1) # p-value = 0.0134
kruskal.test(ibr1overall ~ reporting_area, data = df1) # p-value = 0.001949

```

## KW for geo groups
```{r}

kruskal.test(p450 ~ geo_cluster_2, data = data) # p-value = 0.2814
kruskal.test(p450 ~ geo_cluster_6, data = data) # p-value = 3.835e-05
kruskal.test(p450 ~ geo_cluster_9, data = data) # p-value = 6.706e-05

kruskal.test(sod ~ geo_cluster_2, data = data) # p-value = 0.5036
kruskal.test(sod ~ geo_cluster_6, data = data) # p-value = 0.03536
kruskal.test(sod ~ geo_cluster_9, data = data) # p-value = 0.2201

kruskal.test(ci1 ~ geo_cluster_2, data = data) # p-value = 0.564
kruskal.test(ci1 ~ geo_cluster_6, data = data) # p-value = 0.9201
kruskal.test(ci1 ~ geo_cluster_9, data = data) # p-value = 0.7431

kruskal.test(ci2 ~ geo_cluster_2, data = data) # p-value = 0.298
kruskal.test(ci2 ~ geo_cluster_6, data = data) # p-value = 0.2699
kruskal.test(ci2 ~ geo_cluster_9, data = data) # p-value = 0.216

kruskal.test(ci3 ~ geo_cluster_2, data = data) # p-value = 0.604
kruskal.test(ci3 ~ geo_cluster_6, data = data) # p-value = 0.004109
kruskal.test(ci3 ~ geo_cluster_9, data = data) # p-value = 0.0002141

kruskal.test(ibr1bio ~ geo_cluster_2, data = data) # p-value = 0.1652
kruskal.test(ibr1bio ~ geo_cluster_6, data = data) # p-value = 0.001753
kruskal.test(ibr1bio ~ geo_cluster_9, data = data) # p-value = 0.0002042

kruskal.test(ibr1morph ~ geo_cluster_2, data = data) # p-value = 0.01938
kruskal.test(ibr1morph ~ geo_cluster_6, data = data) # p-value = 0.008425
kruskal.test(ibr1morph ~ geo_cluster_9, data = data) # p-value = 0.02912

kruskal.test(ibr1overall ~ geo_cluster_2, data = data) # p-value = 0.008378
kruskal.test(ibr1overall ~ geo_cluster_6, data = data) # p-value = 0.002645
kruskal.test(ibr1overall ~ geo_cluster_9, data = data) # p-value = 0.003296

```


## p450
```{r}

#p450 - site is not significant
dunn_result <- dunnTest(p450 ~ site_name, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/p450site.csv", row.names = FALSE) # write it out

#p450 - reporting area is significant
dunn_result <- dunnTest(p450 ~ reporting_area, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/p450ra.csv", row.names = FALSE) # write it out

groups <- unique(c(dunn_df$Group1, dunn_df$Group2))

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/p450ra.csv", row.names = FALSE) # write it out

#p450 - geo_6 is significant
dunn_result <- dunnTest(p450 ~ geo_cluster_6, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
library(multcompView)

groups <- unique(c(dunn_df$Group1, dunn_df$Group2))

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/p450geo6.csv", row.names = FALSE) # write it out

#p450 - geo_9 is significant
dunn_result <- dunnTest(p450 ~ geo_cluster_9, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2))

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/p450geo9.csv", row.names = FALSE) # write it out
```

## sod
```{r}

#sod - site is not significant
dunn_result <- dunnTest(sod ~ site_name, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/sodsite.csv", row.names = FALSE) # write it out

#sod - geo6 is not significant
dunn_result <- dunnTest(sod ~ geo_cluster_6, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view



```

## ci1
```{r}

#ci1 - site is significant
dunn_result <- dunnTest(ci1 ~ site_name, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ci1site.csv", row.names = FALSE) # write it out

```

## ci2
```{r}

#ci2 - site is not significant
dunn_result <- dunnTest(ci2 ~ site_name, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/sodsite.csv", row.names = FALSE) # write it out


```

## ci3
```{r}

#ci3 - site is not significant
dunn_result <- dunnTest(ci3 ~ site_name, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/sodsite.csv", row.names = FALSE) # write it out

#ci3 - reporting area is significant
dunn_result <- dunnTest(ci3 ~ reporting_area, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ci3ra.csv", row.names = FALSE) # write it out

#ci3 - geo6 is significant
dunn_result <- dunnTest(ci3 ~ geo_cluster_6, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ci3geo6.csv", row.names = FALSE) # write it out

#ci3 - geo9 is significant
dunn_result <- dunnTest(ci3 ~ geo_cluster_9, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ci3geo9.csv", row.names = FALSE) # write it out

```

## ibr_bio
```{r}

#ibrbio - site is not significant
dunn_result <- dunnTest(ibr1bio ~ site_name, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/sodsite.csv", row.names = FALSE) # write it out

#ibrbio - reporting area is significant
dunn_result <- dunnTest(ibr1bio ~ reporting_area, data = df1, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ibr1biora.csv", row.names = FALSE) # write it out

#ibrbio - geo6 is significant
dunn_result <- dunnTest(ibr1bio ~ geo_cluster_6, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ibr1biogeo6.csv", row.names = FALSE) # write it out

#ibrbio - geo9 is significant
dunn_result <- dunnTest(ibr1bio ~ geo_cluster_9, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ibr1biogeo9.csv", row.names = FALSE) # write it out

```

## ibr_morph 
```{r}

data$reporting_area <- as.factor(data$reporting_area)

#ibrmorph - reporting area is significant
dunn_result <- dunnTest(ibr1morph ~ reporting_area, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/morphra.csv", row.names = FALSE) # write it out

#ibrmorph - geo2 will not run
dunn_result <- dunnTest(ibr1morph ~ geo_cluster, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/morphgeo2.csv", row.names = FALSE) # write it out

#ibrmorph - geo6 is significant
dunn_result <- dunnTest(ibr1morph ~ geo_cluster_6, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/morphgeo6.csv", row.names = FALSE) # write it out

#ibrmorph - geo9 is not significant
dunn_result <- dunnTest(ibr1morph ~ geo_cluster_9, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/morphgeo9.csv", row.names = FALSE) # write it out

```

## ibr_overall
```{r}

#ibroverall - site
dunn_result <- dunnTest(ibr1overall ~ site_name, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
#write.csv(dunn_table, "/Users/cmantegna/Documents/Github/WDFWmussels/output/sodsite.csv", row.names = FALSE) # write it out

#ibrall - reporting area is significant
dunn_result <- dunnTest(ibr1overall ~ reporting_area, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

#write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ibroverallra.csv", row.names = FALSE) # write it out

#ibrall - geo6
dunn_result <- dunnTest(ibr1overall ~ geo_cluster_6, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ibroverallgeo6.csv", row.names = FALSE) # write it out

#ibrall - geo9
dunn_result <- dunnTest(ibr1overall ~ geo_cluster_9, data = data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letters

pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

write.csv(dunn_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/ibroverallgeo9.csv", row.names = FALSE) # write it out

```

# ANOVA + post hoc
## shell
```{r}

anova_site <- aov(shell ~ site_name, data = df1) # p=5.84e-16 ***
anova_ra <- aov(shell ~ reporting_area, data = df1) # p= 1.09e-06 ***
anova_6 <- aov(shell ~ geo_cluster_6, data = data) # p= 1.19e-06 ***
anova_9 <- aov(shell ~ geo_cluster_9, data = data) # p= 3.08e-06 ***
summary(anova_site)
summary(anova_ra)
summary(anova_6)
summary(anova_9)

#post - site is significant
tukey_site <- TukeyHSD(anova_site, "site_name")
tukey_df <- as.data.frame(tukey_site$site_name)

tukey_df <- tukey_df %>%
  tibble::rownames_to_column("Comparison") %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = "-") %>%
  rename(Diff = diff, Lower = lwr, Upper = upr, P.adj = `p adj`) %>%
  mutate(across(everything(), ~trimws(as.character(.)))) %>%  
  mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

groups <- unique(c(tukey_df$Group1, tukey_df$Group2))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(tukey_df)) {
  g1 <- tukey_df$Group1[i]
  g2 <- tukey_df$Group2[i]
  pval <- as.numeric(tukey_df$P.adj[i])
  pval_matrix[g1, g2] <- pval
  pval_matrix[g2, g1] <- pval
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters

cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

tukey_table_with_cld <- tukey_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld) #view
write.csv(tukey_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/shellsite.csv", row.names = FALSE) #save

#post - reporting area
tukey_ra <- TukeyHSD(anova_ra, "reporting_area")
tukey_df <- as.data.frame(tukey_ra$reporting_area)

tukey_df <- tukey_df %>%
  tibble::rownames_to_column("Comparison") %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = "-") %>%
  rename(Diff = diff, Lower = lwr, Upper = upr, P.adj = `p adj`) %>%
  mutate(across(everything(), ~trimws(as.character(.)))) %>%  
  mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

groups <- unique(c(tukey_df$Group1, tukey_df$Group2))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(tukey_df)) {
  g1 <- tukey_df$Group1[i]
  g2 <- tukey_df$Group2[i]
  pval <- as.numeric(tukey_df$P.adj[i])
  pval_matrix[g1, g2] <- pval
  pval_matrix[g2, g1] <- pval
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters

cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

tukey_table_with_cld <- tukey_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld) #view
write.csv(tukey_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/shellra.csv", row.names = FALSE) #save

#post - geo6
tukey_6 <- TukeyHSD(anova_6, "geo_cluster_6")
tukey_df <- as.data.frame(tukey_6$geo_cluster_6)

tukey_df <- tukey_df %>%
  tibble::rownames_to_column("Comparison") %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = "-") %>%
  rename(Diff = diff, Lower = lwr, Upper = upr, P.adj = `p adj`) %>%
  mutate(across(everything(), ~trimws(as.character(.)))) %>%  
  mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

groups <- unique(c(tukey_df$Group1, tukey_df$Group2))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(tukey_df)) {
  g1 <- tukey_df$Group1[i]
  g2 <- tukey_df$Group2[i]
  pval <- as.numeric(tukey_df$P.adj[i])
  pval_matrix[g1, g2] <- pval
  pval_matrix[g2, g1] <- pval
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters

cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

tukey_table_with_cld <- tukey_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld) #view
write.csv(tukey_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/shellgeo6.csv", row.names = FALSE) #save

#post - geo9
tukey_9 <- TukeyHSD(anova_9, "geo_cluster_9")
tukey_df <- as.data.frame(tukey_9$geo_cluster_9)

tukey_df <- tukey_df %>%
  tibble::rownames_to_column("Comparison") %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = "-") %>%
  rename(Diff = diff, Lower = lwr, Upper = upr, P.adj = `p adj`) %>%
  mutate(across(everything(), ~trimws(as.character(.)))) %>%  
  mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

groups <- unique(c(tukey_df$Group1, tukey_df$Group2))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in 1:nrow(tukey_df)) {
  g1 <- tukey_df$Group1[i]
  g2 <- tukey_df$Group2[i]
  pval <- as.numeric(tukey_df$P.adj[i])
  pval_matrix[g1, g2] <- pval
  pval_matrix[g2, g1] <- pval
}

cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters

cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)

tukey_table_with_cld <- tukey_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld) #view
write.csv(tukey_table_with_cld, "/Users/cmantegna/Documents/Github/WDFWmussels/output/shellgeo9.csv", row.names = FALSE) #save

```

# Correlations, Spearman & Kendalls
## data prep
```{r}

# cleaning up site names and then averaging by site for new df
data$site_name <- trimws(data$site_name)
data <- data %>%
  filter(!is.na(site_name), site_name != "")

df_sites <- data %>%
  group_by(site_name, reporting_area) %>% 
  summarise(
    latitude= first(latitude),
    longitude= first(longitude),
    geo_cluster_6= first(geo_cluster_6),
    geo_cluster_9= first(geo_cluster_9),
    p450 = mean(p450, na.rm = TRUE),
    sod = mean(sod, na.rm = TRUE),
    shell = mean(shell, na.rm = TRUE),
    ci1 = mean(ci1, na.rm = TRUE),
    ci2 = mean(ci2, na.rm = TRUE),
    ci3 = mean(ci3, na.rm = TRUE),
    ibr1bio = mean(ibr1bio, na.rm = TRUE),  # or whatever your IBR column is called
    ibr1morph = mean(ibr1morph, na.rm = TRUE),
    ibr1overall = mean(ibr1overall, na.rm = TRUE),
    n_samples = n()
  ) %>%
  ungroup()

head(df_sites)
write.csv(df_sites, "/Users/cmantegna/Documents/Github/WDFWmussels/data/cleaned/avg_ibr1_geo_groups.csv", row.names = FALSE)

# pivoting analyte and metal table to match the format of the biomarker table
# remove trailing white spaces from the site names before pivoting
df4$analyte <- as.character(df4$analyte)
df4$analyte <- trimws(df4$analyte)
df4 <- df4 %>%
  filter(!is.na(analyte), analyte != "")

analytes <- df4 %>%
  select(site_name, analyte, dry_value) %>%
  pivot_wider(
    names_from = analyte,
    values_from = dry_value
  )

# join to df1
df1_analytes <- df_sites %>%
  left_join(analytes, by = c("site_name"))

# metals
metals <- metal_long %>%
  select(site_name, latitude, longitude, analyte, dry_value) %>%
  pivot_wider(
    names_from = analyte,
    values_from = dry_value
  )

# join to df1
df1_metal <- df_sites %>%
  left_join(metals, by = c("site_name"))

#write.csv(df1_analytes, "/Users/cmantegna/Documents/Github/WDFWmussels/data/cleaned/avg_ibr1_analytess.csv", row.names = FALSE)

```

## metrics + ibr
```{r}

# Define your variable sets
metrics_vars <- c("p450", "sod", "shell", "ci1", "ci2", "ci3")

# List any ID columns to exclude here
id_columns <- c("site_name", "reporting_area", "latitude", "longitude", "n_samples")

# Build analyte_vars by excluding both metrics and IDs
analyte_vars <- c("ibr1bio", "ibr1morph", "ibr1overall")

# set p-value & initialize empty list
alpha <- 0.05
results_list <- list()

# Loop over metric–analyte pairs across sites
for (metric in metrics_vars) {
  for (analyte in analyte_vars) {
    
    x <- df_sites[[metric]]
    y <- df_sites[[analyte]]
    
    valid_idx <- complete.cases(x, y)
    x_valid <- x[valid_idx]
    y_valid <- y[valid_idx]
    
    if (length(x_valid) < 4) next  # Skip if too few values
    
    spearman <- cor.test(x_valid, y_valid, method = "spearman")
    kendall <- cor.test(x_valid, y_valid, method = "kendall")
    
    results_list[[paste(metric, analyte, sep = "_")]] <- data.frame(
      Metric = metric,
      Analyte = analyte,
      Spearman_r = as.numeric(spearman$estimate),
      Spearman_p = as.numeric(spearman$p.value),
      Kendall_tau = as.numeric(kendall$estimate),
      Kendall_p = as.numeric(kendall$p.value)
    )
  }
}

# Combine results
corr_full <- bind_rows(results_list)

# Add significance stars
corr_full <- corr_full %>%
  mutate(
    Spearman_sig = case_when(
      Spearman_p <= 0.001 ~ "***",
      Spearman_p <= 0.01  ~ "**",
      Spearman_p <= 0.05  ~ "*",
      TRUE ~ ""
    ),
    Kendall_sig = case_when(
      Kendall_p <= 0.001 ~ "***",
      Kendall_p <= 0.01  ~ "**",
      Kendall_p <= 0.05  ~ "*",
      TRUE ~ ""
    )
  )


View(corr_full)
write.csv(corr_full, "/Users/cmantegna/Documents/Github/WDFWmussels/output/correlation_ibr_biomarkers.csv", row.names = FALSE)


```


## analytes
```{r}

# Define your variable sets
metrics_vars <- c("p450", "sod", "shell", "ci1", "ci2", "ci3", 
                  "ibr1bio", "ibr1morph", "ibr1overall")
# List any ID columns to exclude here
id_columns <- c("site_name", "reporting_area", "latitude", "longitude")

# Build analyte_vars by excluding both metrics and IDs
analyte_vars <- colnames(df1_analytes)[!(colnames(df1_analytes) %in% c(metrics_vars, id_columns))]

# set p-value & initialize empty list
alpha <- 0.05
results_list <- list()

# Loop over metric–analyte pairs across sites
for (metric in metrics_vars) {
  for (analyte in analyte_vars) {
    
    x <- df1_analytes[[metric]]
    y <- df1_analytes[[analyte]]
    
    valid_idx <- complete.cases(x, y)
    x_valid <- x[valid_idx]
    y_valid <- y[valid_idx]
    
    if (length(x_valid) < 4) next  # Skip if too few values
    
    spearman <- cor.test(x_valid, y_valid, method = "spearman")
    kendall <- cor.test(x_valid, y_valid, method = "kendall")
    
    results_list[[paste(metric, analyte, sep = "_")]] <- data.frame(
      Metric = metric,
      Analyte = analyte,
      Spearman_r = as.numeric(spearman$estimate),
      Spearman_p = as.numeric(spearman$p.value),
      Kendall_tau = as.numeric(kendall$estimate),
      Kendall_p = as.numeric(kendall$p.value)
    )
  }
}

# Combine results
corr_full <- bind_rows(results_list)

# Add significance stars
corr_full <- corr_full %>%
  mutate(
    Spearman_sig = case_when(
      Spearman_p <= 0.001 ~ "***",
      Spearman_p <= 0.01  ~ "**",
      Spearman_p <= 0.05  ~ "*",
      TRUE ~ ""
    ),
    Kendall_sig = case_when(
      Kendall_p <= 0.001 ~ "***",
      Kendall_p <= 0.01  ~ "**",
      Kendall_p <= 0.05  ~ "*",
      TRUE ~ ""
    )
  )


View(corr_full)
#write.csv(corr_full, "/Users/cmantegna/Documents/Github/WDFWmussels/output/correlation_analytes.csv", row.names = FALSE)

# adding the chemical class to the correlation table
df4$analyte <- tolower(df4$analyte)
corr_full$Analyte <- tolower(corr_full$Analyte) 

# find unique analytes & merge
df4_clean <- df4 %>%
  distinct(analyte, .keep_all = TRUE)  # Keep only one row per analyte

corr_full <- merge(corr_full, df4_clean[, c("analyte", "class")],
                   by = "analyte", all.x = TRUE)

# save again
#write.csv(corr_full, "/Users/cmantegna/Documents/Github/WDFWmussels/output/correlation_analytes.csv", row.names = FALSE)

```

## metals
```{r}

# Define your variable sets
metrics_vars <- c("p450", "sod", "shell", "ci1", "ci2", "ci3", 
                  "ibr1bio", "ibr1morph", "ibr1overall")
# List any ID columns to exclude here
id_columns <- c("site_name", "reporting_area", "latitude", "longitude")

# Build analyte_vars by excluding both metrics and IDs
analyte_vars <- c("arsenic", "cadmium", "copper", "lead", "mercury", "zinc")


results_list <- list()

# Loop over metric–analyte pairs across sites
for (metric in metrics_vars) {
  for (analyte in analyte_vars) {
    
    x <- df6[[metric]]
    y <- df6[[analyte]]
    
    valid_idx <- complete.cases(x, y)
    x_valid <- x[valid_idx]
    y_valid <- y[valid_idx]
    
    if (length(x_valid) < 4) next  # Skip if too few values
    
    spearman <- cor.test(x_valid, y_valid, method = "spearman")
    kendall <- cor.test(x_valid, y_valid, method = "kendall")
    
    results_list[[paste(metric, analyte, sep = "_")]] <- data.frame(
      Metric = metric,
      Analyte = analyte,
      Spearman_r = as.numeric(spearman$estimate),
      Spearman_p = as.numeric(spearman$p.value),
      Kendall_tau = as.numeric(kendall$estimate),
      Kendall_p = as.numeric(kendall$p.value)
    )
  }
}

# Combine results
corr_full <- bind_rows(results_list)

# Add significance stars
corr_full <- corr_full %>%
  mutate(
    Spearman_sig = case_when(
      Spearman_p <= 0.001 ~ "***",
      Spearman_p <= 0.01  ~ "**",
      Spearman_p <= 0.05  ~ "*",
      TRUE ~ ""
    ),
    Kendall_sig = case_when(
      Kendall_p <= 0.001 ~ "***",
      Kendall_p <= 0.01  ~ "**",
      Kendall_p <= 0.05  ~ "*",
      TRUE ~ ""
    )
  )

# View result
view(corr_full)

#write.csv(corr_full, "/Users/cmantegna/Documents/Github/WDFWmussels/output/correlation_metals.csv", row.names = FALSE)

```


# Interaction Assessment
## test name
```{r}



```


# Spatial Autocorrelation - redo this whole workflow, something is wrong
## Moran's I and Spearman
```{r}

ibr_analytes<- read.csv("../data/cleaned/avg_ibr1_analytess.csv")
analytes_long<- read.csv("../data/cleaned/analytes_long.csv")
metals_long<- read.csv("../data/cleaned/metals_long.csv")

# Moran's: ibr - analytes
ibr_sf <- st_as_sf(ibr_analytes, coords = c("longitude", "latitude"), crs = 4326)

coords <- st_coordinates(ibr_sf)
nb <- knn2nb(knearneigh(coords, k = 4))   # adjust k if needed
lw <- nb2listw(nb, style = "W")

bio_vars <- c("p450", "sod", "shell", "ci1", "ci2", "ci3", "ibr1bio", "ibr1morph", "ibr1overall")

bio_moran_results <- lapply(bio_vars, function(var) {
  vals <- ibr_sf[[var]]
  if (sum(!is.na(vals)) >= 4 && length(unique(vals[!is.na(vals)])) > 1) {
    m <- moran.test(vals, lw)
    data.frame(
      metric = var,
      moran_i = m$estimate[["Moran I statistic"]],
      expected_i = m$estimate[["Expectation"]],
      sd = if ("Standard deviate" %in% names(m$estimate)) m$estimate[["Standard deviate"]] else NA,
      p_value = m$p.value
    )
  } else {
    NULL
  }
}) %>% bind_rows()

# add significance stars
bio_moran_results <- bio_moran_results %>%
  mutate(
    sig = case_when(
      p_value <= 0.001 ~ "***",
      p_value <= 0.01 ~ "**",
      p_value <= 0.05 ~ "*",
      TRUE ~ ""
    )
  )

# results
print(bio_moran_results)
#write.csv(bio_moran_results, "/Users/cmantegna/Documents/Github/WDFWmussels/output/moran_metrics.csv", row.names = FALSE)


# Moran's: ibr - metals
ibr_sf <- st_as_sf(ibr_metal, coords = c("longitude", "latitude"), crs = 4326)

coords <- st_coordinates(ibr_sf)
nb <- knn2nb(knearneigh(coords, k = 4))   # adjust k if needed
lw <- nb2listw(nb, style = "W")

bio_vars <- c("p450", "sod", "shell", "ci1", "ci2", "ci3", "ibr1bio", "ibr1morph", "ibr1overall")

bio_moran_results <- lapply(bio_vars, function(var) {
  vals <- ibr_sf[[var]]
  if (sum(!is.na(vals)) >= 4 && length(unique(vals[!is.na(vals)])) > 1) {
    m <- moran.test(vals, lw)
    data.frame(
      metric = var,
      moran_i = m$estimate[["Moran I statistic"]],
      expected_i = m$estimate[["Expectation"]],
      sd = if ("Standard deviate" %in% names(m$estimate)) m$estimate[["Standard deviate"]] else NA,
      p_value = m$p.value
    )
  } else {
    NULL
  }
}) %>% bind_rows()

# add significance stars
bio_moran_results <- bio_moran_results %>%
  mutate(
    sig = case_when(
      p_value <= 0.001 ~ "***",
      p_value <= 0.01 ~ "**",
      p_value <= 0.05 ~ "*",
      TRUE ~ ""
    )
  )

# results
print(bio_moran_results)
write.csv(bio_moran_results, "/Users/cmantegna/Documents/Github/WDFWmussels/output/moran_metals.csv", row.names = FALSE)

# Spearman - analytes
results_latlong <- analytes_long %>%
  group_by(analyte) %>%
  summarise(
    corr_lat = cor(dry_value, latitude, method = "spearman", use = "complete.obs"),
    p_lat = cor.test(dry_value, latitude, method = "spearman")$p.value,
    corr_long = cor(dry_value, longitude, method = "spearman", use = "complete.obs"),
    p_long = cor.test(dry_value, longitude, method = "spearman")$p.value,
    .groups = "drop"
  )

# add significance stars
results_latlong <- results_latlong %>%
  mutate(
    lat_sig = case_when(
      p_lat <= 0.001 ~ "***",
      p_lat <= 0.01 ~ "**",
      p_lat <= 0.05 ~ "*",
      TRUE ~ ""
    ),
    long_sig = case_when(
      p_long <= 0.001 ~ "***",
      p_long <= 0.01 ~ "**",
      p_long <= 0.05 ~ "*",
      TRUE ~ ""
    )
  )

view(results_latlong)
#write.csv(results_latlong, "/Users/cmantegna/Documents/Github/WDFWmussels/output/spatial_correlation_analytes.csv", row.names = FALSE)


# Spearman's - metals
results_latlong <- metals_long %>%
  group_by(analyte) %>%
  summarise(
    corr_lat = cor(dry_value, latitude, method = "spearman", use = "complete.obs"),
    p_lat = cor.test(dry_value, latitude, method = "spearman")$p.value,
    corr_long = cor(dry_value, longitude, method = "spearman", use = "complete.obs"),
    p_long = cor.test(dry_value, longitude, method = "spearman")$p.value,
    .groups = "drop"
  )

# add significance stars
results_latlong <- results_latlong %>%
  mutate(
    lat_sig = case_when(
      p_lat <= 0.001 ~ "***",
      p_lat <= 0.01 ~ "**",
      p_lat <= 0.05 ~ "*",
      TRUE ~ ""
    ),
    long_sig = case_when(
      p_long <= 0.001 ~ "***",
      p_long <= 0.01 ~ "**",
      p_long <= 0.05 ~ "*",
      TRUE ~ ""
    )
  )

view(results_latlong)
#write.csv(results_latlong, "/Users/cmantegna/Documents/Github/WDFWmussels/output/spatial_correlation_metals.csv", row.names = FALSE)

```

## Morans I
```{r}

# biomarkers & ibr's
bio_vars <- c("p450", "sod", "ibr1bio", "ibr1morph", "ibr1overall")

bio_moran_results <- lapply(bio_vars, function(var) {
  vals <- df_sf[[var]]
  if (sum(!is.na(vals)) >= 4 && length(unique(vals[!is.na(vals)])) > 1) {
    m <- moran.test(vals, lw)
    data.frame(
      metric = var,
      moran_i = m$estimate[["Moran I statistic"]],
      expected_i = m$estimate[["Expectation"]],
      sd = if ("Standard deviate" %in% names(m$estimate)) m$estimate[["Standard deviate"]] else NA,
      p_value = m$p.value
    )
  } else {
    NULL
  }
}) %>% bind_rows()


# analytes
df_class_summary <- analytes_long %>%
  group_by(site_name, latitude, longitude, class) %>%
  summarise(class_value = mean(dry_value, na.rm = TRUE), .groups = "drop")

library(sf)
df_sf <- st_as_sf(df_class_summary, coords = c("longitude", "latitude"), crs = 4326)

library(spdep)
moran_results <- list()

for (cl in unique(df_sf$class)) {
  sub_sf <- df_sf %>% filter(class == cl)
  
  # Create spatial neighbors (e.g., 4-nearest)
  coords <- st_coordinates(sub_sf)
  nb <- knn2nb(knearneigh(coords, k = 4))
  lw <- nb2listw(nb, style = "W")

  # Run Moran's I on the class_value
  moran <- moran.test(sub_sf$class_value, lw)

  moran_results[[cl]] <- data.frame(
    class = cl,
    moran_i = moran$estimate[["Moran I statistic"]],
    expected_i = moran$estimate[["Expectation"]],
    p_value = moran$p.value
  )
}

moran_results_df <- bind_rows(moran_results)

view(moran_results_df)
write.csv(moran_results_df, "/Users/cmantegna/Documents/Github/WDFWmussels/output/moran_analyte.csv", row.names = FALSE)

# metals
metals_wide <- metals_long %>%
  select(site_name, latitude, longitude, analyte, dry_value) %>%
  pivot_wider(names_from = analyte, values_from = dry_value)

df_sf <- st_as_sf(metals_wide, coords = c("longitude", "latitude"), crs = 4326)

# List of metals
metals <- colnames(df_sf)[!(colnames(df_sf) %in% c("site_name", "geometry"))]

# Create neighbor list
coords <- st_coordinates(df_sf)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")

moran_results <- list()

for (metal in metals) {
  values <- df_sf[[metal]]
  
  if (sum(!is.na(values)) >= 4 && length(unique(values[!is.na(values)])) > 1) {
    moran <- moran.test(values, lw)
    
    moran_results[[metal]] <- data.frame(
      metal = metal,
      moran_i = moran$estimate[["Moran I statistic"]],
      expected_i = moran$estimate[["Expectation"]],
      sd = if ("Standard deviate" %in% names(moran$estimate)) moran$estimate[["Standard deviate"]] else NA,
      p_value = moran$p.value
    )
  } else {
    message(paste("Skipping", metal, "- not enough variation or data."))
  }
}

moran_metals_df <- bind_rows(moran_results) %>%
  mutate(
    sig = case_when(
      p_value <= 0.001 ~ "***",
      p_value <= 0.01 ~ "**",
      p_value <= 0.05 ~ "*",
      TRUE ~ ""
    )
  )
view(moran_metals_df)
write.csv(moran_results_df, "/Users/cmantegna/Documents/Github/WDFWmussels/output/moran_metal.csv", row.names = FALSE)

```
