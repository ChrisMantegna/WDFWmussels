---
title: "3.2- Data Analysis with transformed and scaled metrics, IBRs and contaminant indices"
output:
  pdf_document: 
    fig_width: 20
    fig_height: 9
  html_document: 
    toc: true
    toc_float:
        collapsed: false
        smooth_scroll: true
    fig_width: 20
---

# Directory and doc rules

```{r, setup, eval=TRUE, include=TRUE, echo=FALSE}

knitr::opts_chunk$set(
  root.dir = here::here(),
  echo = TRUE,         # show code chunks
  eval = TRUE,         # evaluate code chunks
  warning = FALSE,     # hide warnings
  message = FALSE,     # hide messages
  #fig.width = 15,       # set plot width in inches
  #fig.height = 9,      # set plot height in inches
  fig.align = "center" # slign plots to the center in output doc/ slide/ whatever
)

# libraries
library(broom) # converting output tables to tidy tables for saving or easy view
library(cluster) # grouping metrics - VERIFY still needed
library(devtools) # installing bespoke packages
library(dplyr) # data wrangling
library(factoextra) # pca/ nmds/ tweaking radars
library(FactoMineR) # pca/ nmds/ tweaking radars
library(fmsb) # polygon calculations for the radars
library(FSA) # post hoc test - Dunn's Test   
library(ggplot2) # plots
library(knitr) # output formatting
library(multcompView) # used for the letter assignment
library(pgirmess) # stats - KW
library(rcompanion) # for annotation of permanova
library(rstatix) # VERIFY what this is for      
library(RVAideMemoire) # post hoc test for permanova
library(scales) # scaling data for IBR - works with data wrangling packages
library(sf) # mapping - needed for converting to spatial data
library(spdep) # building spatial geometric components for analysis
library(tidyr) # data wrangling
library(tidyverse) # data wrangling
library(vegan) # ecological stats 

```

# Load & Check Data
```{r}

# working from the clean data folder
getwd()

site_data<- read.csv("../data/cleaned/site_level_complete_indices_10012025.csv") # for reporting area comparisons
sample_data<- read.csv("../data/interim_df/sample_level_scaling_09292025.csv") # for site comparisons for the metrics
sample_ibr<- read.csv("../data/interim_df/sample_level_ibr_09292025.csv") # for the reporting area comparisons for the ibrs

```

# Data prep
```{r}

# make ID columns factors 
site_data$reporting_area <- as.factor(site_data$reporting_area)
site_data$site_name <- as.factor(site_data$site_name)
site_data$site_number <- as.factor(site_data$site_number)

sample_data$reporting_area <- as.factor(sample_data$reporting_area)
sample_data$site_name <- as.factor(sample_data$site_name)
sample_data$site_number <- as.factor(sample_data$site_number)

sample_ibr$reporting_area <- as.factor(sample_ibr$reporting_area)
sample_ibr$site_name <- as.factor(sample_ibr$site_name)
sample_ibr$site_number <- as.factor(sample_ibr$site_number)

```

# Asking: What is the distribution of my transformed and scaled metrics, my created IBRs, and the scaled contaminant indices?
## Shapiro- Wilks 
```{r}

# shapiro-wilks on scaled metrics and indices

shapiro_results <- site_data %>%
  select(6:34) %>%
  map_df(~ broom::tidy(shapiro.test(.x)), .id = "variable")

shapiro_results

# save
#write.csv(shapiro_results, "../output/tables/shapiro_scaled_and_indices_10042025.csv", row.names = FALSE)

```

# Asking: Are there differences between these values at the site and reporting area level?
## ANOVA 
### p450, weight_change, ci3, ibr_morph, length, width, height, weight_initial, weight_final
```{r}

#NOTE: RA comparisons using site_data, Site comparisons using sample_data for non-ibr metrics, the tc value since it is the transformed and scaled value

#p450 - significant p-value for both 
p450_anova_site <- aov(tc_p450 ~ site_number, data = sample_data) # p-value= 1.25e-7
p450_anova_ra <- aov(p450 ~ reporting_area, data = site_data) # p-value= 0.0116
summary(p450_anova_site)
summary(p450_anova_ra)

#weight_change - non-significant p-value for both
wc_anova_site <- aov(tc_weight_change ~ site_number, data = sample_data) # p-value= 0.0674
wc_anova_ra <- aov(weight_change ~ reporting_area, data = site_data) # p-value= 0.177
summary(wc_anova_site)
summary(wc_anova_ra)

#ci3 - non-significant p-value for both. Note significance for site is at the edge, will posthoc for piece of mind
ci3_anova_site <- aov(tc_ci3 ~ site_number, data = sample_data) # p-value= 0.0507
ci3_anova_ra <- aov(ci3 ~ reporting_area, data = site_data) # p-value= 0.422
summary(ci3_anova_site)
summary(ci3_anova_ra)

#ibr_morph - significant p-value for both
morph_anova_site <- aov(ibr_morphometric ~ site_number, data = sample_ibr) # p-value= 2.65e-10
morph_anova_ra <- aov(ibr_morph ~ reporting_area, data = site_data) # p-value= 0.048
summary(morph_anova_site)
summary(morph_anova_ra)

# these may not be consequential in what I need, but running just in case
#length - significant p-value for site, non-significant p=value for reporting area
len_anova_site <- aov(tc_length ~ site_number, data = sample_data) # p-value= 0.0128
len_anova_ra <- aov(length ~ reporting_area, data = site_data) # p-value= 0.594
summary(len_anova_site)
summary(len_anova_ra)

#width - significant p-value for site, non-significant p=value for reporting area
wid_anova_site <- aov(tc_width ~ site_number, data = sample_data) # p-value= 0.000336
wid_anova_ra <- aov(width ~ reporting_area, data = site_data) # p-value= 0.214
summary(wid_anova_site)
summary(wid_anova_ra)

#height - significant p-value for site, non-significant p=value for reporting area
hei_anova_site <- aov(tc_height ~ site_number, data = sample_data) # p-value= 0.00987
hei_anova_ra <- aov(height ~ reporting_area, data = site_data) # p-value= 0.22
summary(hei_anova_site)
summary(hei_anova_ra)

#weight initial - non-significant p-value for both.
wi_anova_site <- aov(tc_weight_initial ~ site_number, data = sample_data) # p-value= 0.0954
wi_anova_ra <- aov(weight_initial ~ reporting_area, data = site_data) # p-value= 0.0519
summary(wi_anova_site)
summary(wi_anova_ra)

#weight final - significant p-value for site, non-significant p=value for reporting area
wf_anova_site <- aov(tc_weight_final ~ site_number, data = sample_data) # p-value= 0.00101
wf_anova_ra <- aov(weight_final ~ reporting_area, data = site_data) # p-value= 0.0767
summary(wf_anova_site)
summary(wf_anova_ra)

```

## Tukey's
### p450   
```{r}

#### p450, site: significant values returned
tuk <- TukeyHSD(p450_anova_site, "site_number")
tuk_df <- broom::tidy(tuk) %>%
  filter(term == "site_number") %>%
  separate(contrast, into = c("Group1", "Group2"), sep = "-") %>%
  mutate(Significant = ifelse(adj.p.value < 0.05, "Yes", "No"))
# cld letters
groups <- sort(unique(c(tuk_df$Group1, tuk_df$Group2)))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in seq_len(nrow(tuk_df))) {
  g1 <- tuk_df$Group1[i]; g2 <- tuk_df$Group2[i]
  p  <- as.numeric(tuk_df$adj.p.value[i])
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(Group = names(cld_letters), CLD = cld_letters, 
                     stringsAsFactors = FALSE)

tukey_table_with_cld <- tuk_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld)
#write.csv(tukey_table_with_cld, "../output/tukey_p450_site_10012025.csv", row.names = FALSE) 

#### p450 - reporting area: significant values returned
tuk <- TukeyHSD(p450_anova_ra, "reporting_area")
tuk_df <- broom::tidy(tuk) %>%
  filter(term == "reporting_area") %>%
  separate(contrast, into = c("Group1", "Group2"), sep = "-") %>%
  mutate(Significant = ifelse(adj.p.value < 0.05, "Yes", "No"))
# cld letters
groups <- sort(unique(c(tuk_df$Group1, tuk_df$Group2)))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in seq_len(nrow(tuk_df))) {
  g1 <- tuk_df$Group1[i]; g2 <- tuk_df$Group2[i]
  p  <- as.numeric(tuk_df$adj.p.value[i])
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(Group = names(cld_letters), CLD = cld_letters, 
                     stringsAsFactors = FALSE)

tukey_table_with_cld <- tuk_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld)
#write.csv(tukey_table_with_cld, "../output/tables/anova_kw_results/tukey_p450_ra_10012025.csv", row.names = FALSE) 

```

### ci3
```{r}

# ci3, site: no significant values returned
tuk <- TukeyHSD(ci3_anova_site, "site_number")
tuk_df <- broom::tidy(tuk) %>%
  filter(term == "site_number") %>%
  separate(contrast, into = c("Group1", "Group2"), sep = "-") %>%
  mutate(Significant = ifelse(adj.p.value < 0.05, "Yes", "No"))
# cld letters
groups <- sort(unique(c(tuk_df$Group1, tuk_df$Group2)))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in seq_len(nrow(tuk_df))) {
  g1 <- tuk_df$Group1[i]; g2 <- tuk_df$Group2[i]
  p  <- as.numeric(tuk_df$adj.p.value[i])
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(Group = names(cld_letters), CLD = cld_letters, 
                     stringsAsFactors = FALSE)

tukey_table_with_cld <- tuk_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld)
#write.csv(tukey_table_with_cld, "../output/tables/anova_kw_results/tukey_ci3_site_10032025.csv", row.names = FALSE) 

```

### ibr_morph
```{r}

#### ibr_morph, site: significant values returned
tuk <- TukeyHSD(morph_anova_site, "site_number")
tuk_df <- broom::tidy(tuk) %>%
  filter(term == "site_number") %>%
  separate(contrast, into = c("Group1", "Group2"), sep = "-") %>%
  mutate(Significant = ifelse(adj.p.value < 0.05, "Yes", "No"))
# cld letters
groups <- sort(unique(c(tuk_df$Group1, tuk_df$Group2)))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in seq_len(nrow(tuk_df))) {
  g1 <- tuk_df$Group1[i]; g2 <- tuk_df$Group2[i]
  p  <- as.numeric(tuk_df$adj.p.value[i])
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(Group = names(cld_letters), CLD = cld_letters, 
                     stringsAsFactors = FALSE)

tukey_table_with_cld <- tuk_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld)
#write.csv(tukey_table_with_cld, "../output/tables/anova_kw_results/tukey_morph_site_10022025.csv", row.names = FALSE) 

#### ibr_morphometrics, reporting area: no significant result
tuk <- TukeyHSD(morph_anova_ra, "reporting_area")
tuk_df <- broom::tidy(tuk) %>%
  filter(term == "reporting_area") %>%
  separate(contrast, into = c("Group1", "Group2"), sep = "-") %>%
  mutate(Significant = ifelse(adj.p.value < 0.05, "Yes", "No"))
# cld letters
groups <- sort(unique(c(tuk_df$Group1, tuk_df$Group2)))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in seq_len(nrow(tuk_df))) {
  g1 <- tuk_df$Group1[i]; g2 <- tuk_df$Group2[i]
  p  <- as.numeric(tuk_df$adj.p.value[i])
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(Group = names(cld_letters), CLD = cld_letters, 
                     stringsAsFactors = FALSE)

tukey_table_with_cld <- tuk_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld)
#write.csv(tukey_table_with_cld, "../output/tables/anova_kw_results/tukey_ibr_morph_ra_10012025.csv", row.names = FALSE)

```

### length
```{r}

# length, site: no significant result
tuk <- TukeyHSD(len_anova_site, "site_number")
tuk_df <- broom::tidy(tuk) %>%
  filter(term == "site_number") %>%
  separate(contrast, into = c("Group1", "Group2"), sep = "-") %>%
  mutate(Significant = ifelse(adj.p.value < 0.05, "Yes", "No"))
# cld letters
groups <- sort(unique(c(tuk_df$Group1, tuk_df$Group2)))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in seq_len(nrow(tuk_df))) {
  g1 <- tuk_df$Group1[i]; g2 <- tuk_df$Group2[i]
  p  <- as.numeric(tuk_df$adj.p.value[i])
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(Group = names(cld_letters), CLD = cld_letters, 
                     stringsAsFactors = FALSE)

tukey_table_with_cld <- tuk_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld)
#write.csv(tukey_table_with_cld, "../output/tables/anova_kw_results/tukey_length_site_10012025.csv", row.names = FALSE) 

```

### width
```{r}

# width, site: significant results returned
tuk <- TukeyHSD(wid_anova_site, "site_number")
tuk_df <- broom::tidy(tuk) %>%
  filter(term == "site_number") %>%
  separate(contrast, into = c("Group1", "Group2"), sep = "-") %>%
  mutate(Significant = ifelse(adj.p.value < 0.05, "Yes", "No"))
# cld letters
groups <- sort(unique(c(tuk_df$Group1, tuk_df$Group2)))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in seq_len(nrow(tuk_df))) {
  g1 <- tuk_df$Group1[i]; g2 <- tuk_df$Group2[i]
  p  <- as.numeric(tuk_df$adj.p.value[i])
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(Group = names(cld_letters), CLD = cld_letters, 
                     stringsAsFactors = FALSE)

tukey_table_with_cld <- tuk_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld)
#write.csv(tukey_table_with_cld, "../output/tables/anova_kw_results/tukey_width_site_10012025.csv", row.names = FALSE) 

```

### height
```{r}

# height, site: significant result returned
tuk <- TukeyHSD(hei_anova_site, "site_number")
tuk_df <- broom::tidy(tuk) %>%
  filter(term == "site_number") %>%
  separate(contrast, into = c("Group1", "Group2"), sep = "-") %>%
  mutate(Significant = ifelse(adj.p.value < 0.05, "Yes", "No"))
# cld letters
groups <- sort(unique(c(tuk_df$Group1, tuk_df$Group2)))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in seq_len(nrow(tuk_df))) {
  g1 <- tuk_df$Group1[i]; g2 <- tuk_df$Group2[i]
  p  <- as.numeric(tuk_df$adj.p.value[i])
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(Group = names(cld_letters), CLD = cld_letters, 
                     stringsAsFactors = FALSE)

tukey_table_with_cld <- tuk_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld)
#write.csv(tukey_table_with_cld, "../output/tables/anova_kw_results/tukey_height_site_10022025.csv", row.names = FALSE) 

```

### weight_final
```{r}

# weight_final, site: significant result returned
tuk <- TukeyHSD(wf_anova_site, "site_number")
tuk_df <- broom::tidy(tuk) %>%
  filter(term == "site_number") %>%
  separate(contrast, into = c("Group1", "Group2"), sep = "-") %>%
  mutate(Significant = ifelse(adj.p.value < 0.05, "Yes", "No"))
# cld letters
groups <- sort(unique(c(tuk_df$Group1, tuk_df$Group2)))
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))

for (i in seq_len(nrow(tuk_df))) {
  g1 <- tuk_df$Group1[i]; g2 <- tuk_df$Group2[i]
  p  <- as.numeric(tuk_df$adj.p.value[i])
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(Group = names(cld_letters), CLD = cld_letters, 
                     stringsAsFactors = FALSE)

tukey_table_with_cld <- tuk_df %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(tukey_table_with_cld)
#write.csv(tukey_table_with_cld, "../output/tables/anova_kw_results/tukey_weight_final_site_10012025.csv", row.names = FALSE) 

```

## Kruskal-Wallis
### both biomarkers, sod, ci1, ci2, shell, ibr_bio, ibr_combined, and all of the contaminant indices
```{r}

# both biomarkers - no significant result
kruskal.test(tc_p450 ~ tc_sod, data = sample_data) # p-value = 0.478 at site-level, p-value = 0.5131 at sample-level

# sod - significant p-value for site, non-significant p=value for reporting area
kruskal.test(tc_sod ~ site_number, data = sample_data) # p-value = 0.001777
kruskal.test(sod ~ reporting_area, data = site_data) # p-value = 0.7705

# ci1 - significant p-value for site, non-significant p=value for reporting area
kruskal.test(tc_ci1 ~ site_number, data = sample_data) # p-value = 0.001056
kruskal.test(ci1 ~ reporting_area, data = site_data) # p-value = 0.991

# ci2 - significant p-value for site, non-significant p=value for reporting area
kruskal.test(tc_ci2 ~ site_number, data = sample_data) # p-value = 2.191e-8
kruskal.test(ci2 ~ reporting_area, data = site_data) # p-value = 0.8179

# shell - significant p=value for both
kruskal.test(tc_shell ~ site_number, data = sample_data) # p-value = 1.092e-08
kruskal.test(shell ~ reporting_area, data = site_data) # p-value = 0.0204

# ibr_bio - significant p-value for site, non-significant p=value for reporting area
kruskal.test(ibr_biomarker ~ site_number, data = sample_ibr) # p-value = 0.000902
kruskal.test(ibr_bio ~ reporting_area, data = site_data) # p-value = 0.6185

# ibr_combined - significant p-value for site, non-significant p=value for reporting area
kruskal.test(ibr_total ~ site_number, data = sample_ibr) # p-value = 0.0001618
kruskal.test(ibr_combined ~ reporting_area, data = site_data) # p-value = 0.4618

# chlordane_index - significant
kruskal.test(chlordane_index ~ reporting_area, data = site_data) # p-value = 0.0001187

# ddt_index - significant
kruskal.test(ddt_index ~ reporting_area, data = site_data) # p-value = 6.389e-06

# hch_index - not significant
kruskal.test(hch_index ~ reporting_area, data = site_data) # p-value = 0.1796

# heavy_metal_index - not significant
kruskal.test(heavy_metal_index ~ reporting_area, data = site_data) # p-value = 0.07802

# nutrient_metal_index - significant
kruskal.test(nutrient_metal_index ~ reporting_area, data = site_data) # p-value = 0.02028

# total_metal_index - significant
kruskal.test(total_metal_index ~ reporting_area, data = site_data) # p-value = 0.01076

# pah_lmw_index - significant
kruskal.test(pah_lmw_index ~ reporting_area, data = site_data) # p-value = 0.005112

# pah_hmw_index - significant
kruskal.test(pah_hmw_index ~ reporting_area, data = site_data) # p-value = 7.555e-05

# pah_add_index - not significant
kruskal.test(pah_add_index ~ reporting_area, data = site_data) # p-value =0.1179

# total_pah_index - significant
kruskal.test(total_pah_index ~ reporting_area, data = site_data) # p-value = 0.001526

# pbde_index - significant
kruskal.test(pbde_index ~ reporting_area, data = site_data) # p-value = 0.0002848

# pcb_index - significant
kruskal.test(pcb_index ~ reporting_area, data = site_data) # p-value = 0.01909

# pesticide_index - not significant
kruskal.test(pesticide_index ~ reporting_area, data = site_data) # p-value = 0.1069

# total_contaminants_index - significant
kruskal.test(total_con_index ~ reporting_area, data = site_data) # p-value = 0.0006062

```

## Dunn's Test - 'bh' method
### sod
```{r}

# sod, site - no significant result
dunn_result <- dunnTest(tc_sod ~ site_name, data = sample_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))
dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)
print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_sod_site_10022025.csv", row.names = FALSE) 

```

### ci1
```{r}

# ci1, site: significant results returned
dunn_result <- dunnTest(tc_ci1 ~ site_name, data = sample_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))
dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)
print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_ci1_site_10022025.csv", row.names = FALSE) 

```

### ci2
```{r}

# ci2, site - no significant result
dunn_result <- dunnTest(tc_ci2 ~ site_name, data = sample_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))
dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)
print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_ci2_site_10022025.csv", row.names = FALSE) 

```

### shell
```{r}

#### shell, site: significant results returned
dunn_result <- dunnTest(tc_shell ~ site_name, data = sample_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))
dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)
print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_shell_site_10032025.csv", row.names = FALSE) 

#### shell, reporting area: no significant result returned
dunn_result <- dunnTest(shell ~ reporting_area, data = site_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))
dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)
print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_shell_ra_10022025.csv", row.names = FALSE) 

```

### ibr_bio
```{r}

# ibr_bio, site: no significant results
dunn_result <- dunnTest(ibr_biomarker ~ site_number, data = sample_ibr, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))
dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)
print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_ibr_bio_site_10022025.csv", row.names = FALSE) 

```

### ibr_combined (ibr_total)
```{r}

# ibr_combined (total), site: no significant result
dunn_result <- dunnTest(ibr_total ~ site_name, data = sample_ibr, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))
dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)
print(dunn_table) # view

groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_ibr_total_site_10022025.csv", row.names = FALSE) 

```

## Note: all contaminants are at the reporting area level only because site values are singular and will be used in correlations
### chlordane
```{r}

# chlordane: significant results returned
dunn_result <- dunnTest(chlordane_index ~ reporting_area, data = site_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_chlordane_ra.csv", row.names = FALSE) 

```

### ddt
```{r}

# ddt: significant results returned
dunn_result <- dunnTest(ddt_index ~ reporting_area, data = site_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_ddt_ra.csv", row.names = FALSE) 

```

### nutrient_metals
```{r}

# nutrient metals: significant result returned
dunn_result <- dunnTest(nutrient_metal_index ~ reporting_area, data = site_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_nutrient_metal_ra.csv", row.names = FALSE) 

```

### total_metals
```{r}

# total metal: no significant results
dunn_result <- dunnTest(total_metal_index ~ reporting_area, data = site_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_total_metal_ra.csv", row.names = FALSE) 

```

### lmw_pah
```{r}

# low pah: significant results returned
dunn_result <- dunnTest(pah_lmw_index ~ reporting_area, data = site_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_low_pah_ra.csv", row.names = FALSE) 

```

### hmw_pah
```{r}

# high pah: signficant results returned
dunn_result <- dunnTest(pah_hmw_index ~ reporting_area, data = site_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_high_pah_ra.csv", row.names = FALSE) 


```

### total_pah
```{r}

# total pah: significant results returned
dunn_result <- dunnTest(total_pah_index ~ reporting_area, data = site_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_total_pah_ra.csv", row.names = FALSE) 

```

### pbde
```{r}

# pbde: signficant results returned
dunn_result <- dunnTest(pbde_index ~ reporting_area, data = site_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_pbde_ra.csv", row.names = FALSE) 


```

### pcb
```{r}

# pcb: no significant results
dunn_result <- dunnTest(pcb_index ~ reporting_area, data = site_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_pcb_ra.csv", row.names = FALSE) 

```

### total_contaminants
```{r}

# total_con: significant results returned
dunn_result <- dunnTest(total_con_index ~ reporting_area, data = site_data, method = "bh") 
dunn_df <- dunn_result$res %>%
  dplyr::select(Comparison, Z, P.unadj, P.adj) %>%
  tidyr::separate(Comparison, into = c("Group1", "Group2"), sep = " - ") %>%
  dplyr::mutate(Significant = ifelse(P.adj < 0.05, "Yes", "No"))

dunn_table <- dunn_df %>%
  dplyr::mutate(across(c(P.unadj, P.adj), round, digits = 4)) %>%
  dplyr::arrange(P.adj)

print(dunn_table) # view
groups <- unique(c(dunn_df$Group1, dunn_df$Group2)) # add letter designation
pval_matrix <- matrix(1, nrow = length(groups), ncol = length(groups),
                      dimnames = list(groups, groups))
for (i in 1:nrow(dunn_df)) {
  g1 <- dunn_df$Group1[i]
  g2 <- dunn_df$Group2[i]
  p <- dunn_df$P.adj[i]
  pval_matrix[g1, g2] <- p
  pval_matrix[g2, g1] <- p
}
cld_letters <- multcompLetters(pval_matrix < 0.05)$Letters
cld_df <- data.frame(
  Group = names(cld_letters),
  CLD = cld_letters,
  stringsAsFactors = FALSE
)
dunn_table_with_cld <- dunn_table %>%
  left_join(cld_df, by = c("Group1" = "Group")) %>%
  rename(Group1_CLD = CLD) %>%
  left_join(cld_df, by = c("Group2" = "Group")) %>%
  rename(Group2_CLD = CLD)

view(dunn_table_with_cld)
#write.csv(dunn_table_with_cld, "../output/tables/anova_kw_results/dunn_total_con_ra.csv", row.names = FALSE) 

```

# Asking: Are there correlations between the contaminants indices and the metrics(Spearman)? Is there a relationship between the contaminants indices and metrics that could indicate dependence or independence (Kendall's) in the Spearman results?
## Spearman & Kendall's
### metrics & all indices
```{r}

# define variables
metrics_vars <- c("p450", "sod", "shell", "ci1", "ci2", "ci3",
                  "weight_initial", "weight_change", "weight_final",
                  "length", "width", "height", "ibr_bio", "ibr_morph", "ibr_combined")

# define id columns
id_columns <- c("site_name", "site_number", "reporting_area", "latitude", "longitude")

analyte_vars <- c("chlordane_index", "ddt_index", "hch_index", "heavy_metal_index", "nutrient_metal_index", "total_metal_index",
"pah_lmw_index", "pah_hmw_index", "pah_add_index", "total_pah_index", "pbde_index", "pcb_index", "pesticide_index", "total_con_index")  

# make sure these are plain character vectors (not factors)
metrics_vars <- as.character(metrics_vars)
analyte_vars <- as.character(analyte_vars)

needed <- c(metrics_vars, analyte_vars)

# check for missing columns (common cause: typos)
missing_cols <- setdiff(needed, names(site_data))
if (length(missing_cols) > 0) {
  warning("These columns are missing from site_data: ",
          paste(missing_cols, collapse = ", "))
}

# coerce just the needed columns to numeric (safe conversion)
to_numeric <- function(v) {
  if (is.numeric(v)) return(v)
  if (is.factor(v)) return(as.numeric(as.character(v)))
  if (is.character(v)) return(suppressWarnings(as.numeric(v)))
  suppressWarnings(as.numeric(v))
}

site_data <- site_data |>
  dplyr::mutate(dplyr::across(dplyr::all_of(intersect(needed, names(site_data))), to_numeric))

# --- correlation loop --------------------------------------------------
results_list <- list()
k <- 1L

for (metric in metrics_vars) {
  if (!metric %in% names(site_data)) next
  x <- site_data[[metric]]
  if (!is.numeric(x)) next

  for (analyte in analyte_vars) {
    if (!analyte %in% names(site_data)) next
    y <- site_data[[analyte]]
    if (!is.numeric(y)) next

    valid <- is.finite(x) & is.finite(y)
    x_valid <- x[valid]
    y_valid <- y[valid]

    
    spearman <- try(stats::cor.test(x_valid, y_valid, method = "spearman", exact = FALSE), silent = TRUE)
    kendall  <- try(stats::cor.test(x_valid, y_valid, method = "kendall"), silent = TRUE)

    if (inherits(spearman, "try-error") || inherits(kendall, "try-error")) next

    results_list[[k]] <- data.frame(
      Metric = metric,
      Analyte = analyte,
      Spearman_r = unname(spearman$estimate),
      Spearman_p = unname(spearman$p.value),
      Kendall_tau = unname(kendall$estimate),
      Kendall_p = unname(kendall$p.value),
      stringsAsFactors = FALSE
    )
    k <- k + 1L
  }
}

# --- combine + significance stars -------------------------------------
corr_full <- dplyr::bind_rows(results_list)

corr_full <- corr_full |>
  dplyr::mutate(
    Spearman_sig = dplyr::case_when(
      Spearman_p <= 0.001 ~ "***",
      Spearman_p <= 0.01  ~ "**",
      Spearman_p <= 0.05  ~ "*",
      TRUE ~ ""
    ),
    Kendall_sig = dplyr::case_when(
      Kendall_p <= 0.001 ~ "***",
      Kendall_p <= 0.01  ~ "**",
      Kendall_p <= 0.05  ~ "*",
      TRUE ~ ""
    )
  ) |>
  dplyr::arrange(Spearman_p, Kendall_p)

view(corr_full)
#write.csv(corr_full, "../output/tables/spearman_kendall_results/correlation_all_indices_10042025.csv", row.names = FALSE)

```

############################### OLD Code######################################
### individual analytes
```{r}

# this may actually need avg_ibr_analytess - double s is the file name - as the df for the analysis
#correlation_data<- read.csv("../data/index_df/site_level_all_analytes_scaled.csv")

metrics_vars <- c("p450", "sod", "shell", "ci1", "ci2", "ci3", "weight_initial", "weight_change", "weight_final", "length", "width", "height", "ibr_bio", "ibr_morph", "ibr_combined")

# identifying columns to exclude from analysis
id_columns <- c("site_name", "site_number",  "reporting_area", "latitude", "longitude", "ai_z_arsenic", "ai_z_cadmium", "ai_z_copper", "ai_z_lead", "ai_z_mercury", "ai_z_zinc")

# converting metals to match other contaminants - metals are reported in mg/kg and all others are ng/g
# 1 mg/kg = 1,000 ng/g
correlation_data$ai_z_arsenic_ng <- correlation_data$ai_z_arsenic * 1000
correlation_data$ai_z_cadmium_ng <- correlation_data$ai_z_cadmium * 1000
correlation_data$ai_z_copper_ng <- correlation_data$ai_z_copper * 1000
correlation_data$ai_z_lead_ng <- correlation_data$ai_z_lead * 1000
correlation_data$ai_z_mercury_ng <- correlation_data$ai_z_mercury * 1000
correlation_data$ai_z_zinc_ng <- correlation_data$ai_z_zinc * 1000

#write.csv(correlation_data, "/Users/cmantegna/Documents/Github/WDFWmussels/data/site_level_corrected_metals_all_analytes.csv", row.names = FALSE)

# Build analyte_vars by excluding both metrics and IDs
analyte_vars <- colnames(correlation_data)[!(colnames(correlation_data) %in% c(metrics_vars, id_columns))]

# set p-value & initialize empty list
alpha <- 0.05
results_list <- list()

# Loop over metricâ€“analyte pairs across sites
for (metric in metrics_vars) {
  for (analyte in analyte_vars) {
    
    x <- correlation_data[[metric]]
    y <- correlation_data[[analyte]]
    
    valid_idx <- complete.cases(x, y)
    x_valid <- x[valid_idx]
    y_valid <- y[valid_idx]
    
    if (length(x_valid) < 4) next  # Skip if too few values
    
    spearman <- cor.test(x_valid, y_valid, method = "spearman")
    kendall <- cor.test(x_valid, y_valid, method = "kendall")
    
    results_list[[paste(metric, analyte, sep = "_")]] <- data.frame(
      Metric = metric,
      Analyte = analyte,
      Spearman_r = as.numeric(spearman$estimate),
      Spearman_p = as.numeric(spearman$p.value),
      Kendall_tau = as.numeric(kendall$estimate),
      Kendall_p = as.numeric(kendall$p.value)
    )
  }
}

# Combine results
corr_full <- bind_rows(results_list)

# Add significance stars
corr_full <- corr_full %>%
  mutate(
    Spearman_sig = case_when(
      Spearman_p <= 0.001 ~ "***",
      Spearman_p <= 0.01  ~ "**",
      Spearman_p <= 0.05  ~ "*",
      TRUE ~ ""
    ),
    Kendall_sig = case_when(
      Kendall_p <= 0.001 ~ "***",
      Kendall_p <= 0.01  ~ "**",
      Kendall_p <= 0.05  ~ "*",
      TRUE ~ ""
    )
  )

View(corr_full)
#write.csv(corr_full, "/Users/cmantegna/Documents/Github/WDFWmussels/output/correlation_individual_analytes.csv", row.names = FALSE)

```

# Spatial Analysis
## Global Moran's I
```{r}

# fix this in post - this can be a loop, but I will need help making it work properly; this is why it is manually done

# all measured metrics
# p450
site_data <- site_sf %>% filter(!is.na(p450)) # filter out any NAs
summary(site_data$p450) # check for variance and more than 3 rows for analysis
coords <- st_coordinates(site_data) # get coordinated from included sites
nb <- knn2nb(knearneigh(coords, k = 4)) # build neighbor list and weights
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$p450)[, 1] # scale results and run morans
moran.test(x_scaled, lw)

# sod
site_data <- site_sf %>% filter(!is.na(sod))
summary(site_data$sod)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$sod)[, 1]
moran.test(x_scaled, lw)

# shell
site_data <- site_sf %>% filter(!is.na(shell))
summary(site_data$shell)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$shell)[, 1]
moran.test(x_scaled, lw)

# ci1
site_data <- site_sf %>% filter(!is.na(ci1))
summary(site_data$ci1)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$ci1)[, 1]
moran.test(x_scaled, lw)

# ci2
site_data <- site_sf %>% filter(!is.na(ci2))
summary(site_data$ci2)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$ci2)[, 1]
moran.test(x_scaled, lw)

# ci3
site_data <- site_sf %>% filter(!is.na(ci3))
summary(site_data$ci3)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$ci3)[, 1]
moran.test(x_scaled, lw)


# ibr_bio
site_data <- site_sf %>% filter(!is.na(ibr_bio))
summary(site_data$ibr_bio)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$ibr_bio)[, 1]
moran.test(x_scaled, lw)

# ibr_morph
site_data <- site_sf %>% filter(!is.na(ibr_morph))
summary(site_data$ibr_morph)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$ibr_morph)[, 1]
moran.test(x_scaled, lw)

# ibr_combined
site_data <- site_sf %>% filter(!is.na(ibr_combined))
summary(site_data$ibr_combined)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$ibr_combined)[, 1]
moran.test(x_scaled, lw)

# All contaminant indices
# mixture index, sum
site_data <- site_sf %>% filter(!is.na(mixture_index_sum))
summary(site_data$mixture_index_sum)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$mixture_index_sum)[, 1]
moran.test(x_scaled, lw)

# mixture index, pca
site_data <- site_sf %>% filter(!is.na(mixture_index_pca))
summary(site_data$mixture_index_pca)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$mixture_index_pca)[, 1]
moran.test(x_scaled, lw)

#chlordane
site_data <- site_sf %>% filter(!is.na(chlordane))
summary(site_data$chlordane)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$chlordane)[, 1]
moran.test(x_scaled, lw)

# UPDATE the CODE from HERE
#ddt
site_data <- site_sf %>% filter(!is.na(ddt))
summary(site_data$ddt)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$ddt)[, 1]
moran.test(x_scaled, lw)

#hch
site_data <- site_sf %>% filter(!is.na(hch))
summary(site_data$hch)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$hch)[, 1]
moran.test(x_scaled, lw)

#metal - nutrients
site_data <- site_sf %>% filter(!is.na(nutrient_metal_ng))
summary(site_data$nutrient_metal_ng)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$nutrient_metal_ng)[, 1]
moran.test(x_scaled, lw)

#metal - heavy
site_data <- site_sf %>% filter(!is.na(heavy_metal_ng))
summary(site_data$heavy_metal_ng)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$heavy_metal_ng)[, 1]
moran.test(x_scaled, lw)

#pah_lmw
site_data <- site_sf %>% filter(!is.na(pah_lmw))
summary(site_data$pah_lmw)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$pah_lmw)[, 1]
moran.test(x_scaled, lw)

#pah_hmw
site_data <- site_sf %>% filter(!is.na(pah_hmw))
summary(site_data$pah_hmw)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$pah_hmw)[, 1]
moran.test(x_scaled, lw)

#pah_add
site_data <- site_sf %>% filter(!is.na(pah_add))
summary(site_data$pah_add)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$pah_add)[, 1]
moran.test(x_scaled, lw)

#pbde
site_data <- site_sf %>% filter(!is.na(pbde))
summary(site_data$pbde)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$pbde)[, 1]
moran.test(x_scaled, lw)

#pcb
site_data <- site_sf %>% filter(!is.na(pcb))
summary(site_data$pcb)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$pcb)[, 1]
moran.test(x_scaled, lw)

#pesticides
site_data <- site_sf %>% filter(!is.na(pesticide))
summary(site_data$pesticide)
coords <- st_coordinates(site_data)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")
x_scaled <- scale(site_data$pesticide)[, 1]
moran.test(x_scaled, lw)

```

## LISA - Local Indicators of Spatial Association
```{r}

library(sf)
library(spdep)

# convert df to a spatial object
site_sf <- st_as_sf(site_data, coords = c("longitude", "latitude"), crs = 4326)
site_sf <- st_transform(site_sf, crs = 3857)  # projected CRS for distance-based neighbors

# create spatial neighbors and weights (4 nearest neighbors)
coords <- st_coordinates(site_sf)
nb <- knn2nb(knearneigh(coords, k = 4))
lw <- nb2listw(nb, style = "W")

# response variables to test
bio_vars <- c("p450", "sod", "shell", "ci1", "ci2", "ci3", "weight_initial", "weight_change", "weight_final", "length", "width", "height", "ibr_bio", "ibr_morph", "ibr_combined")

# contaminant indices 
index_vars <- c("chlordane", "ddt", "hch", "pah_lmw", "pah_hmw", "pah_add", "pbde", "pcb", "pesticide", "heavy_metal_ng", "nutrient_metal_ng", "mixture_index_sum", "mixture_index_pca")

# LOOP FOR LOCAL MORAN'S I 

# create output folder
dir.create("lisa_outputs", showWarnings = FALSE)

for (var in c(bio_vars, index_vars)) {
  x <- site_sf[[var]]
  lisa <- localmoran(scale(x)[,1], lw)

  # Add LISA results to spatial dataframe
  site_sf[[paste0(var, "_lisa_I")]] <- lisa[,1]
  site_sf[[paste0(var, "_lisa_p")]] <- lisa[,5]

  # Define cluster types with p-value significance threshold
site_sf[[paste0(var, "_lisa_cluster")]] <- case_when(
  x > mean(x, na.rm = TRUE) & lisa[,1] > 0 & lisa[,5] < 0.05 ~ "High-High",
  x < mean(x, na.rm = TRUE) & lisa[,1] > 0 & lisa[,5] < 0.05 ~ "Low-Low",
  lisa[,1] < 0 & lisa[,5] < 0.05 ~ "Outlier",
  TRUE ~ "Not Significant"
)

  # Save spatial cluster results with p-values included
st_write(site_sf[, c("site_name", paste0(var, "_lisa_cluster"), paste0(var, "_lisa_p"))],
         paste0("lisa_outputs/LISA_", var, ".geojson"), delete_dsn = TRUE)
}

```

## plotting LISA output
### testing p450 to spot check LISA results
```{r}

getwd()
library(sf)
lisa_p450<- st_read("lisa_outputs/LISA_p450.geojson")
names(lisa_p450)
head(lisa_p450)

```

## mapping p450 LISA clusters to visualize the results before moving to the next steps
```{r}

library(tmap)

# basic LISA plot
tm_shape(lisa_p450) +
  tm_symbols(col = "p450_lisa_cluster",
             palette = "Set1",
             size = 0.5,
             title.col = "LISA Cluster") +
  tm_layout(main.title = "LISA Clusters for P450 Biomarker")

# only signficant clusters
tm_shape(lisa_p450) +
  tm_symbols(col = "p450_lisa_cluster",
             palette = c("High-High" = "red",
                         "Low-Low" = "blue",
                         "Outlier" = "purple",
                         "Not Significant" = "grey80"),
             size = 0.5,
             title.col = "Cluster Type") +
  tm_layout(main.title = "Significant LISA Clusters (P450)")

# table of results
table(lisa_p450$p450_lisa_cluster)

# adding WA basemap for another way to see the clusters
library(rnaturalearth)

# grab WA
us_states <- ne_states(country = "united states of america", returnclass = "sf")
wa_outline <- us_states[us_states$name == "Washington", ]

library(tmap)

tm_shape(wa_outline) +
  tm_borders(col = "gray30") +
tm_shape(lisa_p450) +
  tm_symbols(col = "p450_lisa_cluster",
             palette = c("High-High" = "red",
                         "Low-Low" = "blue",
                         "Outlier" = "purple",
                         "Not Significant" = "gray80"),
             size = 0.5,
             title.col = "Cluster Type") +
  tm_layout(main.title = "LISA Clusters for P450 Biomarker")


```

## creating LISA summary table
```{r}

# Directly from Chat GPT

library(stringr)

# Get list of all LISA geojson files
lisa_files <- list.files("lisa_outputs", pattern = "\\.geojson$", full.names = TRUE)

# Create a summary table for each
lisa_summary <- lapply(lisa_files, function(file) {
  data <- st_read(file, quiet = TRUE)
  
  # Extract the variable name from the file name
  var_name <- str_extract(basename(file), "(?<=LISA_).*(?=\\.geojson)")
  
  # Identify cluster column (should be the only one with 'cluster' in name)
  cluster_col <- names(data)[grepl("cluster", names(data))][1]
  
  # Summarize cluster counts
  summary <- data %>%
    st_drop_geometry() %>%
    count(!!sym(cluster_col), name = "n") %>%
    mutate(variable = var_name, cluster = !!sym(cluster_col)) %>%
    select(variable, cluster, n)
  
  return(summary)
})

# Combine all summaries into one dataframe
all_lisa_summary <- bind_rows(lisa_summary)

#write.csv(all_lisa_summary, "/Users/cmantegna/Documents/Github/WDFWmussels/output/lisa_summary.csv", row.names = FALSE) # write it out

```

