---
title: "020- SOD tests for significance and correlation"
output:
  pdf_document: 
    fig_width: 20
    fig_height: 9
  html_document: 
    toc: true
    toc_float:
        collapsed: false
        smooth_scroll: true
    fig_width: 20
---

# Directory and doc rules

```{r, setup, eval=TRUE, include=TRUE}

knitr::opts_chunk$set(
  echo = TRUE,         # Display code chunks
  eval = TRUE,         # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  fig.width = 20,       # Set plot width in inches
  fig.height = 9,      # Set plot height in inches
  fig.align = "center" # Align plots to the center
)

```

# Load packages

```{r}
library(tinytex)
library(tidyr)
library(tidyverse)
library(vegan)

```

# Load data

```{r}

#getwd()
data <- read.csv("/Users/cmantegna/Documents/WDFWmussels/data/soddata.csv")
sdata<- read.csv("/Users/cmantegna/Documents/WDFWmussels/data/avgSOD.csv")
indv<- read.csv("/Users/cmantegna/Documents/WDFWmussels/data/avgSOD_analytes.csv")
summed<- read.csv("/Users/cmantegna/Documents/WDFWmussels/data/avgSOD_analytes2.csv")
smetal<- read.csv("/Users/cmantegna/Documents/WDFWmussels/data/avgSOD_metals.csv")

```

# Adjust SOD individual values to reflect LOQ limitations
```{r}

# Data contains numbers below 0 that must be adjusted.These numbers represent samples whose values were below the limit of quantification using the SOD kit. There was some activity in the raw sample, but it is too far below the limit of the standard curve to be accurately quantified.


#replace any SOD values at or below 0 with half of the lower detection limit of .005 (.005*.5). Lower detection limit determined by assay protocol by the manufacturer, Cayman.
data$sod[data$sod <= 0] <- 0.0025


```
# Check data

```{r}
summary(data)
```

# Shapiro-Wilkes 
## Data is not normally distributed
```{r}

#test for normality 
shapiro.test(data$sod)

```

# Outliers
## z-score
```{r}

#Values that are more than 3 standard deviations away from the mean

library(dplyr)

#
data <- data %>% mutate(z_score = scale(sod))

# Filter out rows where Z-scores are greater than 3 or less than -3 (outliers)
dataZ <- data %>% filter(z_score >= -3 & z_score <= 3)

# View the data without Z-score outliers
head(dataZ)

```

## IQR 
```{r}

# Values that lie outside the range of 1.5 times the interquartile range (IQR) from the first and third quartiles.

# Compute the IQR for SOD
Q1 <- quantile(data$sod, 0.25)
Q3 <- quantile(data$sod, 0.75)
IQR <- Q3 - Q1

# Define outlier thresholds (1.5 * IQR)
lower_bound <- Q1 - 1.5 * IQR
upper_bound <- Q3 + 1.5 * IQR

# Filter the data to remove outliers based on IQR
dataIQR <- data %>% filter(sod >= lower_bound & sod <= upper_bound)

# View the data without IQR outliers
head(dataIQR)

```


# Kruskal-Wallis
## full data
Reporting Areas Are:\
6 - East Juan de Fuca Strait\
7 - San Juan Islands\
8.1 - Deception Pass, Hope Island, and Skagit Bay\
8.2 - Port Susan and Port Gardner\
9 - Admiralty Inlet\
10 - Seattle-Bremerton\
11 - Tacoma-Vashon\
12 - Hood Canal\
13 - South Puget Sound

```{r}

#test for significant interaction

data$PAHgroup8 <- as.character(data$PAHgroup8)

kruskal.test(sod ~ site_name, data = data)
kruskal.test(sod ~ reporting_area, data = data)
kruskal.test(sod ~ PAHgroup8, data = data)

```


# Dunn Test (post hoc)
## full data

```{r}
library(dunn.test)

# Site
dunn_site <- dunn.test(data$sod, data$site_name, method = "bonferroni", list = TRUE)
mc_site <- data.frame(
    Comparison = dunn_site$comparisons,
    Z = dunn_site$Z,
    P.adjusted = dunn_site$P.adjusted
)

# Write results to a table
write.csv(mc_site, "/Users/cmantegna/Documents/WDFWmussels/output/tables/SignificantSODsite.csv", row.names = FALSE)

# PAHgroup8
dunn_pah8 <- dunn.test(data$sod, data$PAHgroup8, method = "bonferroni", list = TRUE)
mc_site <- data.frame(
    Comparison = dunn_pah8$comparisons,
    Z = dunn_pah8$Z,
    P.adjusted = dunn_pah8$P.adjusted
)

write.csv(mc_site, "/Users/cmantegna/Documents/WDFWmussels/output/tables/SignificantSODpah8.csv", row.names = FALSE)
```

# Kruskal-Wallis
## z-score outliers
```{r}

#test for significant interaction, removal of z-score

data$PAHgroup8 <- as.character(data$PAHgroup8)

kruskal.test(sod ~ site_name, data = dataZ)
kruskal.test(sod ~ reporting_area, data = dataZ)
kruskal.test(sod ~ PAHgroup8, data = dataZ)


```

# Dunn Test (post hoc)
## Z-score data

```{r}
library(dunn.test)

# Site
dunn_site <- dunn.test(dataZ$sod, dataZ$site_name, method = "bonferroni", list = TRUE)
mc_site <- data.frame(
    Comparison = dunn_site$comparisons,
    Z = dunn_site$Z,
    P.adjusted = dunn_site$P.adjusted
)

# Write results to a table
write.csv(mc_site, "/Users/cmantegna/Documents/WDFWmussels/output/tables/SignificantSODsiteZ.csv", row.names = FALSE)

# PAHgroup8
dunn_pah8 <- dunn.test(dataZ$sod, dataZ$PAHgroup8, method = "bonferroni", list = TRUE)
mc_site <- data.frame(
    Comparison = dunn_pah8$comparisons,
    Z = dunn_pah8$Z,
    P.adjusted = dunn_pah8$P.adjusted
)

write.csv(mc_site, "/Users/cmantegna/Documents/WDFWmussels/output/tables/SignificantSODpah8Z.csv", row.names = FALSE)
```

# Kruskal-Wallis
## IQR outliers
```{r}

#test for significant interaction, removal of z-score

data$PAHgroup8 <- as.character(data$PAHgroup8)

kruskal.test(sod ~ site_name, data = dataIQR)
kruskal.test(sod ~ reporting_area, data = dataIQR)
kruskal.test(sod ~ PAHgroup8, data = dataIQR)


```

# Dunn Test (post hoc)
## IQR data

```{r}
library(dunn.test)

# Site
dunn_site <- dunn.test(dataIQR$sod, dataIQR$site_name, method = "bonferroni", list = TRUE)
mc_site <- data.frame(
    Comparison = dunn_site$comparisons,
    Z = dunn_site$Z,
    P.adjusted = dunn_site$P.adjusted
)

# Write results to a table
write.csv(mc_site, "/Users/cmantegna/Documents/WDFWmussels/output/tables/SignificantSODsiteIQR.csv", row.names = FALSE)

# PAHgroup8
dunn_pah8 <- dunn.test(dataIQR$sod, dataIQR$PAHgroup8, method = "bonferroni", list = TRUE)
mc_site <- data.frame(
    Comparison = dunn_pah8$comparisons,
    Z = dunn_pah8$Z,
    P.adjusted = dunn_pah8$P.adjusted
)

write.csv(mc_site, "/Users/cmantegna/Documents/WDFWmussels/output/tables/SignificantSODpah8IQR.csv", row.names = FALSE)
```

# Correlation

## sumPAH, lmwPAH, hmwPAH and PAH16
### No correlations
```{r}

# no correlation
correlation_result <- cor.test(summed$avg_value, summed$sumPAH, method = "pearson")
print(correlation_result)

# no correlation
correlation_result <- cor.test(summed$avg_value, summed$lmwPAH, method = "pearson")
print(correlation_result)

# no correlation
correlation_result <- cor.test(summed$avg_value, summed$hmwPAH, method = "pearson")
print(correlation_result)

# no correlation
correlation_result <- cor.test(summed$avg_value, summed$sum16PAH, method = "pearson")
print(correlation_result)

```

## sum42PAH and sumPCB
### No correlations
```{r}

# no correlation
correlation_result <- cor.test(summed$avg_value, summed$sum42PAH, method = "pearson")
print(correlation_result)

# no correlation
correlation_result <- cor.test(summed$avg_value, summed$sumPCB, method = "pearson")
print(correlation_result)

```

## other summed analytes
### No correlation
```{r}

# correlation
correlation_result <- cor.test(summed$avg_value, summed$sum40CB, method = "pearson")
print(correlation_result)

# no correlation
correlation_result <- cor.test(summed$avg_value, summed$sumBDE, method = "pearson")
print(correlation_result)

# no correlation
correlation_result <- cor.test(summed$avg_value, summed$sumCHLD, method = "pearson")
print(correlation_result)

# no correlation
correlation_result <- cor.test(summed$avg_value, summed$sumDDT, method = "pearson")
print(correlation_result)

# no correlation
correlation_result <- cor.test(summed$avg_value, summed$sumHCH, method = "pearson")
print(correlation_result)
```

## mercury, arsenic, cadmium, copper, lead and zinc
### No correlation
```{r}

# no correlation
correlation_result <- cor.test(smetal$avg_value, smetal$mercuryTotal, method = "pearson")
print(correlation_result)

# no correlation
correlation_result <- cor.test(smetal$avg_value, smetal$arsenic, method = "pearson")
print(correlation_result)

# no correlation
correlation_result <- cor.test(smetal$avg_value, smetal$cadmium, method = "pearson")
print(correlation_result)

# no correlation
correlation_result <- cor.test(smetal$avg_value, smetal$copper, method = "pearson")
print(correlation_result)

# no correlation
correlation_result <- cor.test(smetal$avg_value, smetal$lead, method = "pearson")
print(correlation_result)

# no correlation
correlation_result <- cor.test(smetal$avg_value, smetal$Zinc, method = "pearson")
print(correlation_result)

```

