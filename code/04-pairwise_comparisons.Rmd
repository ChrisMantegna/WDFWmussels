---
title: "04- Pairwise Comparisons, KW + Dunn Post Hoc"
output:
  pdf_document: 
    fig_width: 20
    fig_height: 9
  html_document: 
    toc: true
    toc_float:
        collapsed: false
        smooth_scroll: true
    fig_width: 20
---

# Directory and doc rules

```{r, setup, eval=TRUE, include=TRUE}

knitr::opts_chunk$set(
  root.dir = here::here(),
  echo = TRUE,         # Display code chunks
  eval = TRUE,         # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  #fig.width = 15,       # Set plot width in inches
  #fig.height = 9,      # Set plot height in inches
  fig.align = "center" # Align plots to the center
)

```

# Load & Check Data
```{r}

# double check where you are
# *NOTE* see 00-data_cleaned for directory issue
getwd()

# using ALL individual samples, not averages
data<- read.csv("../data/complete_with_nas.csv")

# check it out
#str(data) # checking df structure

#summary(data) #checking df contents

#colnames(data) <- tolower(colnames(data)) # if needed

```

# making groups factors
```{r}
# make analysis groups a factor (reporting area, geographic group, pcb group, site, pah group)
# change to a factor - all data
data$site_number <- as.factor(data$site_number)
data$reporting_area <- as.factor(data$reporting_area)
data$geo_group <- as.factor(data$geo_group)
data$p16 <- as.factor(data$p16)
data$p42 <- as.factor(data$p42)
data$plmw <- as.factor(data$plmw)
data$phmw <- as.factor(data$phmw)
data$pcb <- as.factor(data$pcb)

```

# KW & Post Hoc (individual metrics for each group)
## Site Group
### 
```{r}

library(vegan)
library(FSA)

# p450
kruskal.test(p450 ~ site_name, data = data) # result: p= 
dunn <- dunnTest(data$p450, data$site_name, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # 

# SOD
kruskal.test(sod ~ site_name, data = data) # result: p= 5.669e-6
dunn <- dunnTest(data$sod, data$site_name, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # 

# ci1
kruskal.test(ci_wet_volume ~ site_name, data = data) # result: p= 0.02581
dunn <- dunnTest(data$ci_wet_volume, data$site_name, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # 

# ci2
kruskal.test(ci_wet_shell_weight ~ site_name, data = data) # result: p= 2.832e-8
dunn <- dunnTest(data$ci_wet_shell_weight, data$site_name, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # 

# ci3
kruskal.test(ci_pollution ~ site_name, data = data) # result: p= 0.05444
dunn <- dunnTest(data$ci_pollution, data$site_name, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # 

```

## Reporting Areas
### No significant results
```{r}

library(vegan)
library(FSA)

data$reporting_area <- as.factor(data$reporting_area) # make a factor for analysis

# P450
kruskal.test(p450 ~ reporting_area, data = data) # result: p= 0.2722
dunn <- dunnTest(data$p450, data$reporting_area, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# SOD
kruskal.test(sod ~ reporting_area, data = data) # result: p= 0.01261
dunn <- dunnTest(data$sod, data$reporting_area, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# CI_Wet_Volume
kruskal.test(ci_wet_volume ~ reporting_area, data = data) # result: p= 0.8026
dunn <- dunnTest(data$ci_wet_volume, data$reporting_area, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# CI_Wet_Shell_Weight
kruskal.test(ci_wet_shell_weight ~ reporting_area, data = data) # result: p= 0.3923
dunn <- dunnTest(data$ci_wet_shell_weight, data$reporting_area, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# CI_Pollution
kruskal.test(ci_pollution ~ reporting_area, data = data) # result: p= 0.454
dunn <- dunnTest(data$ci_pollution, data$reporting_area, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

```

## PCB Groups
### No significant results
```{r}

library(vegan)
library(FSA)

data$pcb_group <- as.factor(data$pcb_group) # make a factor for analysis

# P450
kruskal.test(p450 ~ pcb_group, data = data) # result: p= 0.003688
dunn <- dunnTest(data$p450, data$pcb_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# SOD
kruskal.test(sod ~ pcb_group, data = data) # result: p= 0.003041
dunn <- dunnTest(data$sod, data$pcb_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# CI_Wet_Volume
kruskal.test(ci_wet_volume ~ pcb_group, data = data) # result: p= 0.2901
dunn <- dunnTest(data$ci_wet_volume, data$pcb_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# CI_Wet_Shell_Weight
kruskal.test(ci_wet_shell_weight ~ pcb_group, data = data) # result: p= 0.05206
dunn <- dunnTest(data$ci_wet_shell_weight, data$pcb_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# CI_Pollution
kruskal.test(ci_pollution ~ pcb_group, data = data) # result: p= 0.8241
dunn <- dunnTest(data$ci_pollution, data$pcb_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

```

## PAH Group
### No significant results
```{r}

library(vegan)
library(FSA)

data$pah_group <- as.factor(data$pah_group) # make a factor for analysis

# P450
kruskal.test(p450 ~ pah_group, data = data) # result: p= 0.2722
dunn <- dunnTest(data$p450, data$pah_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# SOD
kruskal.test(sod ~ pah_group, data = data) # result: p= 0.01261
dunn <- dunnTest(data$sod, data$pah_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# CI_Wet_Volume
kruskal.test(ci_wet_volume ~ pah_group, data = data) # result: p= 0.8026
dunn <- dunnTest(data$ci_wet_volume, data$pah_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# CI_Wet_Shell_Weight
kruskal.test(ci_wet_shell_weight ~ pah_group, data = data) # result: p= 0.3923
dunn <- dunnTest(data$ci_wet_shell_weight, data$pah_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# CI_Pollution
kruskal.test(ci_pollution ~ pah_group, data = data) # result: p= 0.454
dunn <- dunnTest(data$ci_pollution, data$pah_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

```

## Geo Group
### No significant results
```{r}

library(vegan)
library(FSA)

data$geo_group <- as.factor(data$geo_group) # make a factor for analysis

# P450
kruskal.test(p450 ~ geo_group, data = data) # result: p= 0.0148
dunn <- dunnTest(data$p450, data$geo_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# SOD
kruskal.test(sod ~ geo_group, data = data) # result: p= 0.07454
dunn <- dunnTest(data$sod, data$geo_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# CI_Wet_Volume
kruskal.test(ci_wet_volume ~ geo_group, data = data) # result: p= 0.8462
dunn <- dunnTest(data$ci_wet_volume, data$geo_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# CI_Wet_Shell_Weight
kruskal.test(ci_wet_shell_weight ~ geo_group, data = data) # result: p= 0.09208
dunn <- dunnTest(data$ci_wet_shell_weight, data$geo_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

# CI_Pollution
kruskal.test(ci_pollution ~ geo_group, data = data) # result: p= 0.3182
dunn <- dunnTest(data$ci_pollution, data$geo_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc) # NO significance confirmed

```

# ANOVA - Shell Thickness Only
## All groupings (site, reporting area, pcb group, pah group, geo group)
### Significant results for all groupings, confirmed in post hoc testing
```{r}

library(car)
library(multcomp)

# Define grouping variables
grouping_vars <- c("site_name", "reporting_area", "pcb_group", "pah_group", "geo_group")

# Function to run ANOVA and post hoc test
run_anova_posthoc <- function(group_var, data) {
  # Remove NAs for shell thickness and the grouping variable
  clean_data <- data[!is.na(data$shell_thickness) & !is.na(data[[group_var]]), ]
  
  # Run ANOVA
  anova_model <- aov(shell_thickness ~ get(group_var), data = clean_data)
  anova_summary <- summary(anova_model)

  # Extract p-value from ANOVA table
  p_value <- anova_summary[[1]]["Pr(>F)"][1,1]  

  # Only proceed if ANOVA is significant
  if (p_value < 0.05) {
    cat("\n### Significant ANOVA results for shell thickness by", group_var, "###\n")
    print(anova_summary)

    # Run Tukey's HSD post hoc test
    posthoc_result <- TukeyHSD(anova_model)

    # Convert to data frame for filtering
    posthoc_df <- as.data.frame(posthoc_result[[1]])
    posthoc_df <- cbind(comparison = rownames(posthoc_df), posthoc_df)  # Add comparison column

    # Filter only significant results (p < 0.05)
    significant_posthoc <- posthoc_df[posthoc_df$`p adj` < 0.05, , drop = FALSE]

    if (nrow(significant_posthoc) > 0) {
      cat("\n### Significant Tukey Post Hoc Comparisons for", group_var, "###\n")
      print(significant_posthoc)
    } else {
      cat("\n### No significant post hoc differences for", group_var, "###\n")
    }

    return(list(ANOVA = anova_summary, PostHoc = significant_posthoc))
  } else {
    cat("\n### No significant ANOVA differences for shell thickness by", group_var, "###\n")
    return(NULL)
  }
}

# Run ANOVA + post hoc for each grouping variable and store only significant results
anova_results <- lapply(grouping_vars, function(var) run_anova_posthoc(var, data))
names(anova_results) <- grouping_vars

# Remove NULL results (where ANOVA was not significant)
anova_results <- anova_results[!sapply(anova_results, is.null)]

```












```{r}

#data/all_metrics_avg_all_groups_with_nas.csv
```

