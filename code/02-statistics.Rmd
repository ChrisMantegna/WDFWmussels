---
title: "02- Basic Statistics"
output:
  html_document: 
    fig_width: 8
  pdf_document: 
    fig_width: 8
    fig_height: 5
---


# Directory and doc rules

```{r, setup, eval=TRUE, include=TRUE}

knitr::opts_chunk$set(
  echo = TRUE,         # Display code chunks
  eval = TRUE,         # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  fig.width = 8,       # Set plot width in inches
  fig.height = 5,      # Set plot height in inches
  fig.align = "center" # Align plots to the center
)

```

# Load packages

```{r, eval= FALSE}

library(tidyr)
library(tidyverse)
library(ggplot2)
library(vegan)

```

# Load data

```{r}

getwd()
#data has all sites, coordinates, p450, sod, condition factor, economic factor data
mdata<- read.csv("/Users/cmantegna/Documents/WDFWmussels/data/biomarkerfull.csv")

```

# Review setup

```{r}

str(mdata)

```

# Data type and summary

## Note

Weight = g\
Length, width, height = mm\
p450, SOD = activity/ (mg/protein)\
Condition factor, economic factor = unitless

```{r}
# the data types are based in str() results, make numeric anything with na in the column.
summary(mdata)
```


```{r}

as.numeric("weight_initial", "weight_change", "length", "width", "height", "condition_factor", "economic_index")

```

# 0's and negative number management

SOD values that are negative are changed to 0 signifying that the value was undetectable.\
p450 values that are 0 are missing, not actual 0's.They are thrown out.\
Note: must address the SOD values, 0's skew the data so some kind of replacement or adjustment must be made.

```{r}

#get rid of the p450 values that are 0
mdata <- mdata[mdata$p450 != 0, ]

#change negative numbers to 0 to indicate not detectable
mdata$SOD <- ifelse(mdata$SOD <= 0, 0, mdata$SOD)

```

# Test p450 for data normality

## Interpretation- p450 data is not normally distributed

```{r}
shapiro.test(mdata$p450)

```

# Test SOD for data normality

## Interpretation-SOD data is not normally distributed

```{r}
shapiro.test(mdata$SOD)

```

# Correlation, Pearson Correlation

## Interpretation - slight negative correlation between the biomarkers is not statistically significant

```{r}

#individual correlation test between the biomarkers
cor.test(mdata$p450, mdata$SOD)

```

## the interpretation here is the same as above, just created the table for clear view of biomarkers with the condition_factor

```{r}
#pearson correlation of only biomarkers and condition_factor

# cor.test(df$site_number, df$sod, method = "pearson")
# Convert condition_factor to numeric if it's not already
mdata$condition_factor <- as.numeric(mdata$condition_factor)

# Perform Pearson correlation with NA values ignored
cor(mdata[c("p450", "SOD", "condition_factor")], use = "complete.obs", method = "pearson")
```

# Plot Pearson

```{r}
library(corrplot)

cor.mtest <- function(mat, conf.level = 0.95){
  mat <- as.matrix(mat)
  n <- ncol(mat)
  p.mat <- matrix(NA, n, n)
  diag(p.mat) <- 0
  
  for(i in 1:(n-1)){
    for(j in (i+1):n){
      tmp <- cor.test(mat[,i], mat[,j], conf.level = conf.level)
      p.mat[i,j] <- tmp$p.value
      p.mat[j,i] <- tmp$p.value
    }
  }
  list(p = p.mat, conf.level = conf.level)
}

# Assuming 'mdata' and 'data' are defined and 'data' is used to subset 'mdata'
df2 <- mdata[sapply(mdata, is.numeric)] # Ensure 'mdata' is used here
df2 <- na.omit(df2)
M <- cor(df2)
testRes <- cor.mtest(df2, conf.level = 0.95)

# Visualization with corrplot
corrplot::corrplot(M,
  method = "circle", type = "lower", insig = "blank",
  addCoef.col = "black", number.cex = 0.8, order = "AOE", diag = FALSE
)

#print(cor)
#ggsave(plot=cor, filename="/Users/cmantegna/Documents/WDFWmussels/output/pearson.png", width=15, height=8)

```

# PCA Plot with biomarkers, condition_factor and economic_factor

```{r}

#install.packages("FactoMineR")
#install.packages("factoextra")
library('FactoMineR')
library("factoextra")

# Ensure that condition_factor and economic_index are numeric
mdata$condition_factor <- as.numeric(mdata$condition_factor)
mdata$economic_index <- as.numeric(mdata$economic_index)

# Remove NAs from the dataset
df_clean <- na.omit(mdata)

# Selecting the relevant variables for PCA
pca_data <- df_clean[, c("SOD", "p450", "condition_factor", "economic_index")]

# Performing PCA
pca_res <- PCA(pca_data, scale.unit = TRUE, graph = FALSE)

# Plotting the PCA
pcaplot<- fviz_pca_biplot(pca_res, label = "var", col.var = "contrib",
                gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                repel = TRUE)  # Avoid text overlapping (slow if many points)



print(pcaplot)
#ggsave(plot=pcaplot, filename="/Users/cmantegna/Documents/WDFWmussels/output/pca.png", width=15, height=8)

```

# K-means cluster/ relationship test

## Interpretation- there are three clusters that vary in size and that is an indicator of a significant number of outliers, see the 01-explore code for the plot of the outliers. There are significant outliers for SOD, this may be rendering this test unhelpful. "The means of each cluster give you an idea of the centroid values around which the data points in each cluster are aggregated."

```{r,eval=TRUE}
#fixing data for kmeans
sum(is.na(mdata$p450)) # Checks for NA values in p450
sum(is.nan(mdata$p450)) # Checks for NaN values in p450
sum(is.infinite(mdata$p450)) # Checks for Inf values in p450

sum(is.na(mdata$SOD))
sum(is.nan(mdata$SOD)) 
sum(is.infinite(mdata$SOD)) 

sum(is.na(mdata$condition_factor)) 
sum(is.nan(mdata$condition_factor)) 
sum(is.infinite(mdata$condition_factor)) 

mdata$p450 <- as.numeric(mdata$p450)
mdata$SOD <- as.numeric(mdata$SOD)
mdata$condition_factor <- as.numeric(mdata$condition_factor)

# Remove rows with NA or NaN values in specified columns
clean_data <- mdata[complete.cases(mdata[, c("p450", "SOD", "condition_factor")]), ]

# Ensure all data is numeric for the Inf check to make sense
clean_data <- transform(clean_data,
                        p450 = as.numeric(p450),
                        SOD = as.numeric(SOD),
                        condition_factor = as.numeric(condition_factor))

# Now check for and handle Inf values
clean_data <- clean_data[!is.infinite(clean_data$p450) & !is.infinite(clean_data$SOD) & !is.infinite(clean_data$condition_factor), ]

kmeans_result <- kmeans(clean_data[, c("p450", "SOD", "condition_factor")], centers = 3)

print(kmeans_result)

```
