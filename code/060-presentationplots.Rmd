---
title: "060- Presentation Correlation Plots"
output:
  html_document: 
    toc: true
    toc_float:
        collapsed: false
        smooth_scroll: true
    fig_width: 20
  pdf_document: 
    fig_width: 20
    fig_height: 9
---

# Directory and doc rules

```{r, setup, eval=TRUE, include=TRUE}

knitr::opts_chunk$set(
  echo = TRUE,         # Display code chunks
  eval = TRUE,         # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  fig.width = 20,       # Set plot width in inches
  fig.height = 9,      # Set plot height in inches
  fig.align = "center" # Align plots to the center
)

```

# Load data
```{r}
data<- read.csv("/Users/cmantegna/Documents/WDFWmussels/data/p450correlationMAN.csv")
sdata<- read.csv("/Users/cmantegna/Documents/WDFWmussels/data/sodcorrelationMAN1.csv")
ssdata<- read.csv("/Users/cmantegna/Documents/WDFWmussels/data/sodcorrelationMAN2.csv")

```



```{r}
# Load necessary libraries
library(ggplot2)
library(Hmisc)  # for Spearman correlation with p-values


# Check column names to ensure they match the expected pattern
print("Available columns in the dataset:")
print(names(data))  # Print out the column names to check them

# Get analyte columns and avg columns
# Using grep to select columns that start with 'a' for analytes
analyte_columns <- grep("^a", names(data), value = TRUE)

# Ensure that 'avg_p450' and 'avg_sod' are present in the dataset
if (!('avg_p450' %in% names(data)) || !('avg_sod' %in% names(data))) {
  stop("Columns 'avg_p450' and/or 'avg_sod' are missing from the dataset.")
}

# Create a subset with relevant columns
columns_of_interest <- c('avg_p450', 'avg_sod', analyte_columns)
data_subset <- data[, columns_of_interest]

# Function to calculate Spearman correlations and p-values
get_spearman_corr <- function(data, target_col) {
  corr_results <- sapply(analyte_columns, function(col) {
    result <- rcorr(data[[target_col]], data[[col]], type = "spearman")
    list(correlation = result$r[1, 2], p_value = result$P[1, 2])
  }, simplify = FALSE)
  
  corr_df <- do.call(rbind, lapply(corr_results, as.data.frame))
  rownames(corr_df) <- analyte_columns
  corr_df <- as.data.frame(corr_df)
  
  # Filter for significant correlations (p_value < 0.05)
  significant_corrs <- subset(corr_df, p_value < 0.05)
  return(significant_corrs)
}

# Calculate significant correlations for avg_p450 and avg_sod
significant_corrs_p450 <- get_spearman_corr(data_subset, 'avg_p450')
significant_corrs_sod <- get_spearman_corr(data_subset, 'avg_sod')

# Create the plot for avg_p450
ggplot(significant_corrs_p450, aes(x = correlation, y = rownames(significant_corrs_p450))) +
  geom_bar(stat = "identity") +
  labs(title = "Significant Spearman Correlations with avg_p450",
       x = "Spearman Correlation", y = "Analyte") +
  theme_minimal()

# Create the plot for avg_sod
ggplot(significant_corrs_sod, aes(x = correlation, y = rownames(significant_corrs_sod))) +
  geom_bar(stat = "identity") +
  labs(title = "Significant Spearman Correlations with avg_sod",
       x = "Spearman Correlation", y = "Analyte") +
  theme_minimal()

```
# sod
```{r}

# Load necessary libraries
library(ggplot2)
library(Hmisc)  # for Spearman correlation with p-values


# Check column names to ensure they match the expected pattern
print("Available columns in the dataset:")
print(names(sdata))  # Print out the column names to check them

# Get analyte columns and avg columns
# Using grep to select columns that start with 'a' for analytes
analyte_columns <- grep("^a", names(sdata), value = TRUE)

# Ensure that 'avg_p450' and 'avg_sod' are present in the dataset
if (!('avg_sod' %in% names(sdata))) {
  stop("Columns 'avg_sod' and/or 'avg_sod' are missing from the dataset.")
}

# Create a subset with relevant columns
columns_of_interest <- c('avg_p450', analyte_columns)
data_subset <- data[, columns_of_interest]

# Function to calculate Spearman correlations and p-values
get_spearman_corr <- function(sdata, target_col) {
  corr_results <- sapply(analyte_columns, function(col) {
    result <- rcorr(sdata[[target_col]], sdata[[col]], type = "spearman")
    list(correlation = result$r[1, 2], p_value = result$P[1, 2])
  }, simplify = FALSE)
  
  corr_df <- do.call(rbind, lapply(corr_results, as.data.frame))
  rownames(corr_df) <- analyte_columns
  corr_df <- as.data.frame(corr_df)
  
  # Filter for significant correlations (p_value < 0.05)
  significant_corrs <- subset(corr_df, p_value < 0.05)
  return(significant_corrs)
}

# Calculate significant correlations for avg_p450 and avg_sod
#significant_corrs_p450 <- get_spearman_corr(data_subset, 'avg_p450')
significant_corrs_sod <- get_spearman_corr(data_subset, 'avg_sod')

# Create the plot for avg_p450
#ggplot(significant_corrs_p450, aes(x = correlation, y = rownames(significant_corrs_p450))) +
#  geom_bar(stat = "identity") +
#  labs(title = "Significant Spearman Correlations with avg_p450",
#       x = "Spearman Correlation", y = "Analyte") +
#  theme_minimal()

# Create the plot for avg_sod
ggplot(significant_corrs_sod, aes(x = correlation, y = rownames(significant_corrs_sod))) +
  geom_bar(stat = "identity") +
  labs(title = "Significant Spearman Correlations with avg_sod",
       x = "Spearman Correlation", y = "Analyte") +
  theme_minimal()

```
```

