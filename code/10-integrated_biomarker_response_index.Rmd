---
title: "10- Creating an IBR Index"
output:
  pdf_document: 
    fig_width: 20
    fig_height: 9
  html_document: 
    toc: true
    toc_float:
        collapsed: false
        smooth_scroll: true
    fig_width: 20
---

# Directory and doc rules

```{r, setup, eval=TRUE, include=TRUE}

# libraries
library(knitr)
library(tidyr)
library(tidyverse)
library(dplyr)
library(vegan)
library(cluster)
library(pgirmess)
library(ggplot2)
library(factoextra)
library(FactoMineR)
library(FSA)           
library(rstatix)       
library(car)
library(RVAideMemoire)
library(rcompanion)
library(scales)

knitr::opts_chunk$set(
  root.dir = here::here(),
  echo = TRUE,         # Display code chunks
  eval = TRUE,         # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  #fig.width = 15,       # Set plot width in inches
  #fig.height = 9,      # Set plot height in inches
  fig.align = "center" # Align plots to the center
)

```

# Load & Check Data
```{r}

getwd()

# load data
df<- read.csv("../data/cleaned/all_with_imputation_weights_site_ra.csv")

# check it out
str(df) # checking df structure
summary(df) #checking df contents

```

```{r }

# replace any values below LOQ with imputed LOQ (.5 x LOD), LOD= 0.05
df$sod[df$sod <= 0] <- 0.0025

# check
summary(df)

```

# Normalizing the data
Step 1 - Normalize biomarker values. Use z-scores/ min-max scaling per site or sample to put them on a comparable scale.
Step 2 -Transform morphometrics to reduce scale variability.
Step 3 - Check for outliers. Extreme values may skew integrated scores.
```{r}

# ---- Step 1: Select and scale biomarkers and morphometrics ----
ibr_vars <- df %>%
  select(p450, sod, weight_change_g, weight_final_g, shell, length_mm, height_mm, width_mm, ci1, ci2, ci3)

# Standardize (Z-score)
ibr_scaled <- scale(ibr_vars)

# ---- Step 2: Convert to absolute Z-scores (deviation) ----
ibr_scores <- abs(as.data.frame(ibr_scaled))

# ---- Step 3: Calculate IBR Index (sum of absolute scores) ----
df$IBR <- rowSums(ibr_scores)

# ---- Optional: Inspect IBR scores by site or condition ----
ggplot(df, aes(x = site_name, y = IBR)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Integrated Biomarker Response (IBR) by Site",
       y = "IBR Index", x = "Site") +
  theme(axis.text.x= element_text(angle= 45, hjust= 1))

write_csv(df, "/Users/cmantegna/Documents/GitHub/WDFWmussels/data/cleaned/ibr_output.csv")


```

# Create the IBR
Step 0 - Separate IBRs: IBR biomarkers, IBR morphometrics, IBR both
Step 1 - Score biomarkers and morphometrics. Use grand mean or the reference site - Penn Cove Ref Site.
Step 2 - Find deviation from the reference. A positive deviation is more stressed and a negative deviation is less stress.
Step 3 - Plot it. Radar plots and polygon area plots will support calculations.
```{r}

```

# Stats
PERMANOVA
```{r}

```

# Visualization
PCA/ NMDS
Correlation heatmaps
```{r}

```

