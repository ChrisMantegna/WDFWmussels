---
title: "01- Visual Data Exploration"
---

# Directory and doc rules

```{r, setup, include=FALSE}

knitr::opts_knit$set(root.dir = '/code')

```

# Load packages

```{r}

library(tidyr)
library(tidyverse)
library(ggplot2)
library(vegan)

```

# Load data

```{r}

getwd()
#data has all sites, coordinates, p450, sod, condition factor, economic factor data
data<- read.csv("/Users/cmantegna/Documents/WDFWmussels/data/biomarkerfull.csv")

```

# Review setup

```{r}

str(data)

```

# Data type and summary

## Note

Weight = g\
Length, width, height = mm\
p450, SOD = activity/ (mg/protein)\
Condition factor, economic factor = unitless

```{r}

#the data types are based in str() results, make numeric anything with na in the column.
summary(data)

```

```{r}

as.numeric("weight_initial", "weight_change", "length", "width", "height", "condition_factor", "economic_index")

```

# 0's and negative number management

SOD values that are negative are changed to 0 signifying that the value was undetectable.\
p450 values that are 0 are missing, not actual 0's.

```{r}

#get rid of the p450 values that are 0
data <- data[data$p450 != 0, ]

#change any negative numbers to 0 to indicate not detectable
data$SOD <- ifelse(data$SOD <= 0, 0, data$SOD)

```

# Detect outliers and plot them - code a combo of stack overflow and chat gpt.

```{r}

detect_outliers_mad <- function(data, accuracy = 0.99) {
  # Calculate z-score equivalent for the given accuracy
  z_threshold <- qnorm(accuracy + (1 - accuracy) / 2)

  # Initialize a list to store outlier indices for each numeric column
  outliers_list <- list()

  # Initialize a vector to keep track of rows with outliers
  rows_with_outliers <- rep(FALSE, nrow(data))

  # Loop through each column in the dataframe
  for (col_name in names(data)) {
    # Check if the column is numeric
    if (is.numeric(data[[col_name]])) {
      # Calculate MAD and median for the column
      mad_value <- median(abs(data[[col_name]] - median(data[[col_name]])))
      median_value <- median(data[[col_name]])

      # Calculate the deviation scores (using a modified z-score formula)
      deviation_scores <- 0.6745 * (data[[col_name]] - median_value) / mad_value

      # Identify indices of outliers
      outlier_indices <- which(abs(deviation_scores) > z_threshold)

      # Store the indices in the list
      outliers_list[[col_name]] <- outlier_indices

      # Update rows with outliers
      rows_with_outliers[outlier_indices] <- TRUE
    }
  }

  # Return the list of outliers and rows with outliers
  list(outliers_list = outliers_list, rows_with_outliers = rows_with_outliers)
}

outliers_info <- detect_outliers_mad(data)

# Convert the list of outliers to a named vector of counts
num_outliers_each_col <- sapply(outliers_info$outliers_list, length)
num_rows_with_outliers <- sum(outliers_info$rows_with_outliers)

# Check if there are any outliers
if (all(num_outliers_each_col == 0)) {
  print("There are no outliers in any columns.")
} else {
  # Create a data frame for plotting
  outliers_data_df <- data.frame(
    Column = names(num_outliers_each_col),
    Outliers = as.integer(num_outliers_each_col),
    OutlierPercentage = (as.integer(num_outliers_each_col) / nrow(data)) * 100
  )

  # Plot the number of outliers for all columns
  outlier_plot <- ggplot(outliers_data_df, aes(x = Column, y = Outliers, fill = Column)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = sprintf("%.2f%%", OutlierPercentage)), position = position_dodge(width = 0.9), vjust = -0.25) +
    coord_flip() +
    labs(title = "Number of Outliers by Column", x = "Column", y = "Number of Outliers") +
    scale_fill_brewer(palette = "Set3") +
    theme_minimal()

  print(outlier_plot)
}

ggsave(plot= outlier_plot, filename="/Users/cmantegna/Documents/WDFWmussels/output/outliers.png", width=15, height=8)

```

# p450 histogram

```{r}

#basic histogram + basic density plot
#hist(data$p450)
#plot(density(data$p450), main="Density Plot", xlab="p450 Value")

#ggplot histogram with density curve
library(scales) # Make sure this package is loaded for label_number()

phist<- ggplot(data, aes(x = p450)) +
  geom_histogram(aes(y = after_stat(density)), binwidth = diff(range(data$p450))/30, colour = "black", fill = "white") +
  geom_density(alpha = .2, fill = "#FF6666") +
  labs(x = "P450 Values", y = "Density", title = "Histogram of P450 Values with Density Curve") +
  theme_minimal() +
  scale_x_continuous(labels = label_number()) # This line adjusts the x-axis labels

print(phist)
ggsave(plot=phist, filename="/Users/cmantegna/Documents/WDFWmussels/output/p450histogram.png", width=15, height=8)

```

# SOD histogram

```{r}

#basic histogram + basic density plot
#hist(data$SOD)
#plot(density(data$SOD), main="Density Plot", xlab="SOD Value")

#ggplot histogram with density curve
library(scales) # Make sure this package is loaded for label_number()

shist <- ggplot(data, aes(x = SOD)) +
  geom_histogram(aes(y = after_stat(density)), binwidth = diff(range(data$SOD))/30, colour = "black", fill = "white") +
  geom_density(alpha = .2, fill = "#FF6666") +
  labs(x = "SOD Values", y = "Density", title = "Histogram of SOD Values with Density Curve") +
  theme_minimal() +
  scale_x_continuous(labels = label_number()) # This line adjusts the x-axis labels

print(shist)
ggsave(plot=shist, filename="/Users/cmantegna/Documents/WDFWmussels/output/SODhistogram.png", width=15, height=8)

```

# Plotting both biomarkers in a box plot

```{r}

all<-plot<- ggplot(data) +
  geom_point(aes(x = site_name, y = SOD, color = "SOD")) +
  geom_point(aes(x = site_name, y = p450, color = "P450")) +
  labs(x = "Site Name", y = "Value", color = "Biomarker") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


print(all)
ggsave(plot=all, filename="/Users/cmantegna/Documents/WDFWmussels/output/allBoxPlot.png", width=15, height=8)

```

# Plotting both biomarkers in a box plot with a free y-axis to fix the sod v p450 values. The SOD values all look the same and are all at 0. 

Note that the color for SOD shifts from teal to salmon between the two plots.

```{r}
# First, create a basic ggplot object with SOD data
freey <- ggplot(data, aes(x = site_name)) +
  geom_point(aes(y = SOD, color = "SOD")) +
  labs(x = "Site Name", y = "SOD Value") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Then, add p450 using sec.axis
freey + geom_point(aes(y = p450/100, color = "p450")) + # Example scaling factor, adjust as needed
  scale_y_continuous(sec.axis = sec_axis(~.*100, name = "p450 Value")) # Reverse the scaling for the secondary axis label

print(freey)
#ggsave(plot=freey, filename="/Users/cmantegna/Documents/WDFWmussels/output/allBoxPlotFreeY.png", width=15, height=8)
```

# Plotting both biomarkers in their own box plots with a facet wrap to try to show the difference in values for both biomarkers since SOD looks the same.

```{r}

# Reshape data from wide to long format
long_data <- pivot_longer(data, cols = c(SOD, p450), names_to = "Biomarker", values_to = "Value")

# Plotting with faceting
facetp <- ggplot(long_data, aes(x = site_name, y = Value, color = Biomarker)) +
  geom_point() +
  facet_wrap(~Biomarker, scales = "free_y") + # This allows each biomarker to have its own y-axis scale
  labs(x = "Site Name", y = "Value", color = "Biomarker") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

print(facetp)
# Save the plot
ggsave(plot=facetp, filename="/Users/cmantegna/Documents/WDFWmussels/output/allBoxPlotFacet.png", width=15, height=8)

```

# Plotting separate box plots to investigate the facet, the other options still show the sod values the 'same' when everything is plotted together.

```{r}

# Ensure your data is in the correct format.
# Reshape your dataframe if it hasn't been done correctly.
long_data <- pivot_longer(data, cols = c(SOD, p450), names_to = "Biomarker", values_to = "Value")

# Faceted plot with separate scales.
plotf<- ggplot(long_data, aes(x = site_name, y = Value)) +
  geom_point(aes(color = Biomarker)) +
  facet_wrap(~ Biomarker, scales = "free_y") +
  labs(x = "Site Name", y = "Value", color = "Biomarker") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(plotf)
ggsave(plot=plotf, filename="/Users/cmantegna/Documents/WDFWmussels/output/allBoxPlotFacetPanels.png", width=40, height=25)

```

# Plotting p450 values ranked from smallest to largest

```{r}

# Order the sites by p450 value
data_ordered <- data[order(data$p450),]

# Create a factor with the ordered site names
data_ordered$site_name <- factor(data_ordered$site_name, levels = unique(data_ordered$site_name))

# Plot the SOD values in a boxplot with ordered site names
rankp<- ggplot(data_ordered, aes(x = site_name, y = p450)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) # Rotate x labels if needed

print(rankp)
ggsave(plot=rankp, filename="/Users/cmantegna/Documents/WDFWmussels/output/p450ranked.png", width=15, height=8)
```

# Plotting SOD values ranked from samllest largest

```{r}

# Order the sites by p450 value
data_ordered <- data[order(data$SOD),]

# Create a factor with the ordered site names
data_ordered$site_name <- factor(data_ordered$site_name, levels = unique(data_ordered$site_name))

# Plot the SOD values in a boxplot with ordered site names
ranks<- ggplot(data_ordered, aes(x = site_name, y = SOD)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) # Rotate x labels if needed

print(ranks)
ggsave(plot=ranks, filename="/Users/cmantegna/Documents/WDFWmussels/output/SODranked.png", width=15, height=8)
```
