---
title: "01- Data Exploration"
output:
  html_document:
    df_print: paged
  pdf_document: 
    fig_width: 20
    fig_height: 9
---

# Directory and doc rules

```{r, setup, eval=TRUE, include=TRUE}

knitr::opts_chunk$set(
  echo = TRUE,         # Display code chunks
  eval = TRUE,         # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  fig.width = 20,       # Set plot width in inches
  fig.height = 9,      # Set plot height in inches
  fig.align = "center" # Align plots to the center
)

```

# Load packages

```{r}
library(tinytex)
library(tidyr)
library(tidyverse)
library(vegan)

```

# Load data
Weight = mg\
Length, width, height = mm\
p450, SOD = activity/ (mg/protein)\
Condition factor, economic factor = unitless
```{r}

getwd()
#data has all sites, coordinates, p450, sod, condition factor, economic factor data
data<- read.csv("/Users/cmantegna/Documents/WDFWmussels/data/biomarkerfull.csv")

#alldata has the site names, biomarkers, condition factor, average thickness and analyte data - each row is an individual sample
alldata<- read.csv("/Users/cmantegna/Documents/WDFWmussels/data/alldata.csv")

```

## fix zero's in the data frame and alldata frame

```{r}

# Data contains 0's and must be adjusted in this order to preserve all usable data.

#sod
#replace any SOD values at or below 0 with half of the lower detection limit of .005 (.005*.5). Lower detection limit determined by assay protocol by the manufacturer, Cayman.
data$SOD[data$SOD <= 0] <- 0.0025
alldata$SOD[alldata$SOD <= 0] <- 0.0025
#p450
#remove any p450 values that are 0 - those are true 0's not non-detectable. I am replacing with na so I don't lose the entire row of data, including the SOD values.
data$p450[data$p450 <= 0] <- NA
alldata$p450[alldata$p450 <= 0] <- NA

#write.csv(alldata, "/Users/cmantegna/Documents/WDFWmussels/data/alldata.csv")
```


```{r}
# check the data frame
#summary(alldata)
#str(alldata)
```

# Boxplot of biomarker data, p450 and SOD
```{r}
#p450
pplot<- ggplot(data, aes(x = site_name, y = p450)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 

print(pplot)

#SOD
splot<- ggplot(data, aes(x = site_name, y = SOD)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 

print(splot)
```


# Histograms of p450, SOD, condition_factor and avg_thickness 
### Only avg_thickness looks normally distributed.
```{r}
# p450 basic histogram + basic density plot
hist(alldata$p450)
plot(density(alldata$p450, na.rm= TRUE), main="Density Plot", xlab="p450 Value")

# SOD basic histogram + basic density plot
hist(alldata$SOD)
plot(density(alldata$SOD, na.rm= TRUE), main="Density Plot", xlab="p450 Value")

# Condition_factor basic histogram + basic density plot
hist(alldata$condition_factor)
plot(density(alldata$condition_factor, na.rm= TRUE), main="Density Plot", xlab="p450 Value")

# Avg_thickness basic histogram + basic density plot
hist(alldata$avg_thickness)
plot(density(alldata$avg_thickness, na.rm= TRUE), main="Density Plot", xlab="p450 Value")

```

# Shapiro-Wilkes test for normality
### Only avg_thickness is normally distributed.
```{r}
shapiro.test(alldata$p450)
shapiro.test(alldata$SOD)
shapiro.test(alldata$condition_factor)
shapiro.test(alldata$avg_thickness)

```

# Kruskal-Wallis 
```{r}


```


```{r}


```



```{r}
shapiro.test(alldata$p450)
```

# shapiro wilkes test for normality, SOD: Data is not normally distributed

```{r}
shapiro.test(alldata$SOD)
```

# log transform the data to see if it reaches normality

```{r}
p450log<- log(alldata$p450)
hist(p450log)
shapiro.test(p450log) #doesn't help with normality
```

# log transform the data to see if it reaches normality

```{r}
SODlog<- log(alldata$SOD)
hist(SODlog)
shapiro.test(SODlog) #doesn't help with normality
```

# use the 95% of biomarker data and test for normality

```{r}
#find quartile values for p450
lower_limitp <- quantile(alldata$p450, probs = 0.025, na.rm= TRUE)
upper_limitp <- quantile(alldata$p450, probs = 0.975, na.rm= TRUE)

# Print the lower and upper limits
print(lower_limitp)
print(upper_limitp)

#find quartile values for SOD
lower_limits <- quantile(alldata$SOD, probs = 0.025, na.rm= TRUE)
upper_limits <- quantile(alldata$SOD, probs = 0.975, na.rm= TRUE)

# Print the lower and upper limits
print(lower_limits)
print(upper_limits)


```

## replace values outside of the quartiles with NA

```{r}
# manipulate data frame to analyze on the 95%
#p450
alldata$p450[alldata$p450 <= 1002087] <- NA
alldata$p450[alldata$p450 >= 10831148] <- NA

#SOD
alldata$SOD[alldata$SOD <= .0024] <- NA
alldata$SOD[alldata$SOD >= 51.54] <- NA

```

## test for normality one more time, p450

```{r}
shapiro.test(alldata$p450)
```

## test for normality one more time, SOD

```{r}
shapiro.test(alldata$SOD)
```

# Will move forward with the anova and post- hoc. Data is not normally distributed.

## renaming the individual analytes so that entering data into the anova isn't difficult

```{r}
# Generate the first 26 letters of the alphabet
letters_seq <- letters[1:26]

# Generate additional letters if needed
extra_letters_seq <- character(0)
num_cols <- length(22:57)  # Number of columns you want to rename
if (num_cols > length(letters_seq)) {
  repeats_needed <- num_cols - length(letters_seq)
  # Generate double letters like 'aa', 'bb', 'cc', etc.
  extra_letters_seq <- rep(letters[1:repeats_needed], each=1)
  extra_letters_seq <- sapply(extra_letters_seq, function(x) paste0(x, x))
}

# Combine the original and additional sequences
new_colnames <- c(letters_seq, extra_letters_seq)[1:num_cols]


```

```{r}
# Assuming 'alldata' is your dataframe
colnames(alldata)[22:57] <- new_colnames

# View the updated column names to confirm
print(colnames(alldata))

```

# anovas for p450, no imputation

```{r}
#anova
model <- lm(p450 ~ site_number + SOD + condition_factor + avg_thickness, data = alldata)
#summary(model)
p450anova<- anova(model)
print(p450anova)

#anova1
model1<- lm(p450~ arsenic + cadmium + copper + lead, data = alldata)
p450anova1<- anova(model1)
print(p450anova1)

#anova2
model2<- lm(p450~ mercuryTotal + Zinc, data = alldata)
p450anova2<- anova(model2)
print(p450anova2)

#anova3
model3<- lm(p450~ SumBDEs + SumCHLDs + SumDDTs + SumHCHs, data = alldata)
p450anova3<- anova(model3)
print(p450anova3)

#anova4
model4<- lm(p450~ SumPAHs16 + SumPAHsHMW + SumPCBs2x17, data = alldata)
p450anova4<- anova(model4)
print(p450anova4)

```

## print model results, p450

```{r}
summary(model)
summary(model1)
summary(model2)
summary(model3)
summary(model4)
```

# anovas for SOD, no imputation

```{r}
#anova
smodel <- lm(SOD ~ site_number + p450 + condition_factor + avg_thickness, data = alldata)
#summary(model)
SODanova<- anova(smodel)
print(SODanova)

#anova1
smodel1<- lm(SOD~ arsenic + cadmium + copper + lead, data = alldata)
SODanova1<- anova(smodel1)
print(SODanova1)

#anova2
smodel2<- lm(SOD~ mercuryTotal + Zinc, data = alldata)
SODanova2<- anova(smodel2)
print(SODanova2)

#anova3
smodel3<- lm(SOD~ SumBDEs + SumCHLDs + SumDDTs + SumHCHs, data = alldata)
SODanova3<- anova(smodel3)
print(SODanova3)

#anova4
smodel4<- lm(SOD~ SumPAHs16 + SumPAHsHMW + SumPCBs2x17, data = alldata)
SODanova4<- anova(smodel4)
print(SODanova4)

```

```{r}
summary(smodel)
summary(smodel1)
summary(smodel2)
summary(smodel3)
summary(smodel4)
```

# Results without replacing any missing or purposefully disregarded values.

## p450\~ SOD and average thickness show a statistically significant relationship

## SOD\~ site number, p450, SumDDTs and SumPAHs16 show a statistically significant relationship

## anovas with 0 value replacement for all analytes with an NA. The NA means the value is undetected and this is a simple test to see what the anovas would be - 0 may not be the best option, imputing the data is likely the way to go.

```{r}
#replacing NA with 0
library(dplyr)

# Replace NA values with 0 in columns 9 to 57
alldata <- alldata %>% 
  mutate(across(.cols = 7:57, .fns = ~replace_na(., 0)))

```

# rerun anova with the O's in the analytes

## p450\~ SOD, average thickness, mercuryTotal and SumPCBs2x17 show a statistically significant relationship

```{r}
#anova
model <- lm(p450 ~ site_number + SOD + condition_factor + avg_thickness, data = alldata)
#summary(model)
p450anova<- anova(model)
print(p450anova)

#anova1
model1<- lm(p450~ arsenic + cadmium + copper + lead, data = alldata)
p450anova1<- anova(model1)
print(p450anova1)

#anova2
model2<- lm(p450~ mercuryTotal + Zinc, data = alldata)
p450anova2<- anova(model2)
print(p450anova2)

#anova3
model3<- lm(p450~ SumBDEs + SumCHLDs + SumDDTs + SumHCHs, data = alldata)
p450anova3<- anova(model3)
print(p450anova3)

#anova4
model4<- lm(p450~ SumPAHs16 + SumPAHsHMW + SumPCBs2x17, data = alldata)
p450anova4<- anova(model4)
print(p450anova4)
```

## missing 30/24 values are the p450 values that fall outside of the 95% range

```{r}
summary(model)
summary(model1)
summary(model2)
summary(model3)
summary(model4)
```

# anovas for SOD, with 0's for missing analytes

## SOD\~ site number, p450, SumBDEs, SumDDTs, SumPAHs16 and SumPAHsHMW show a statistically significant relationship

```{r}
#anova
smodel <- lm(SOD ~ site_number + p450 + condition_factor + avg_thickness, data = alldata)
#summary(model)
SODanova<- anova(smodel)
print(SODanova)

#anova1
smodel1<- lm(SOD~ arsenic + cadmium + copper + lead, data = alldata)
SODanova1<- anova(smodel1)
print(SODanova1)

#anova2
smodel2<- lm(SOD~ mercuryTotal + Zinc, data = alldata)
SODanova2<- anova(smodel2)
print(SODanova2)

#anova3
smodel3<- lm(SOD~ SumBDEs + SumCHLDs + SumDDTs + SumHCHs, data = alldata)
SODanova3<- anova(smodel3)
print(SODanova3)

#anova4
smodel4<- lm(SOD~ SumPAHs16 + SumPAHsHMW + SumPCBs2x17, data = alldata)
SODanova4<- anova(smodel4)
print(SODanova4)

```

## missing 30/8 values are the SOD values that fall outside of the 95% range

```{r}
summary(smodel)
summary(smodel1)
summary(smodel2)
summary(smodel3)
summary(smodel4)
```

### don't think I will need this, but just in case I need to come back to it

```{r}
# Convert 'condition_factor' and 'avg_thickness' to numeric
#alldata$condition_factor <- as.numeric(alldata$condition_factor)
#alldata$avg_thickness <- as.numeric(alldata$avg_thickness)
```

# Kruskal Wallis NOT A POST HOC, p450

## p450\~ SOD, average thickness, mercuryTotal and SumPCBs2x17 show a statistically significant relationship

```{r}

kruskal.test(p450 ~ SOD, data = alldata)
kruskal.test(p450 ~ avg_thickness, data = alldata)
kruskal.test(p450 ~ site_name, data = alldata)
kruskal.test(p450 ~ condition_factor, data = alldata)
```

# Kruskal Wallis, SOD

#double check as.numeric for condition factor and average thickness

## SOD\~ site number, p450, SumBDEs, SumDDTs, SumPAHs16 and SumPAHsHMW show a statistically significant relationship

```{r}
kruskal.test(SOD ~ p450, data = alldata)

kruskal.test(SOD ~ condition_factor, data = alldata)
kruskal.test(SOD ~ avg_thickness, data = alldata)
#kruskal.test(SOD ~ SumPAHs16, data = alldata)
#kruskal.test(SOD ~ SumPAHsHMW, data = alldata)
```

# dunn

```{r}
install.packages("dunn.test")
library("dunn.test")
```

```{r}
kruskal.test(SOD ~ site_number, data = alldata)

# Perform Dunn's test
dunn_result <- dunn.test(alldata$SOD, alldata$site_number, method="bonferroni")
print(dunn_result)


```


#SOD kruskalmc
```{r}
# Load necessary library for pairwise comparisons
#install.packages("pgirmess")
library(pgirmess)
# Pairwise comparisons
mc_results<- as.data.frame(kruskalmc(alldata$SOD, alldata$site_name, p.adj = "bonferroni"))
head(mc_results)

```
#p450 kruskalmc
```{r}
library(pgirmess)
# Pairwise comparisons
kruskal.test(p450 ~ site_number, data = alldata)
mc_results2<- as.data.frame(kruskalmc(alldata$p450, alldata$site_name, p.adj = "bonferroni"))
head(mc_results2)

```


# Pearson correlation for SOD

```{r}

selected_data <- alldata[, c("SOD", "site_number", "p450", "SumBDEs", "SumDDTs", "SumPAHs16", "SumPAHsHMW")]

```

```{r}
library(ggplot2)
library(reshape2)

# Calculate the correlation matrix
cor_matrix <- cor(selected_data, use = "complete.obs")  # This option excludes NA values

# Melt the correlation matrix for visualization
melted_cor_matrix <- melt(cor_matrix)

# Plotting
ggplot(data = melted_cor_matrix, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, limit = c(-1,1)) +
  theme_minimal() +
  labs(title = "Pearson Correlation Matrix", x = "", y = "")

```

# PCA, SOD & significant relationships

```{r}
# Load FactoMineR for PCA
library(FactoMineR)

# PCA with FactoMineR, which handles NA by default
pca_result <- PCA(selected_data, scale.unit = TRUE, ncp = 5, graph = FALSE)

# Plotting
plot(pca_result, choix = "ind")

```

# boxplot for SOD

```{r}
plot<- ggplot(data, aes(x = site_name, y = SOD)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) # Rotate x labels if needed

print(plot)
```
