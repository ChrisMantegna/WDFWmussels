---
title: "02- Analysis Groups: Adding the Groupings for Analysis by Site, Reporting Area, PCB Group, Geographic Area and PAH Groups"
output:
  pdf_document: 
    fig_width: 20
    fig_height: 9
  html_document: 
    toc: true
    toc_float:
        collapsed: false
        smooth_scroll: true
    fig_width: 20
---

# Directory and doc rules

```{r, setup, eval=TRUE, include=TRUE}

knitr::opts_chunk$set(
  root.dir = here::here(),
  echo = TRUE,         # Display code chunks
  eval = TRUE,         # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  #fig.width = 15,       # Set plot width in inches
  #fig.height = 9,      # Set plot height in inches
  fig.align = "center" # Align plots to the center
)

```

# Load & Check Data
```{r}

# double check where you are
# *NOTE* see 00-data_cleaned for directory issue
getwd()

# load data
# complete df
p16<- read.csv("../data/sumPah16.csv")
p42<- read.csv("../data/sumPah42.csv")
phmw<- read.csv("../data/sumPahHMW.csv")
plmw<- read.csv("../data/sumPahLMW.csv")
pcb<- read.csv("../data/sumPcbs.csv")
# check it out
#str(data) # checking df structure
# note that sample_id and site_number are integers and may need to be adjusted to characters for analysis

#summary(data) #checking df contents

#colnames(data) <- tolower(colnames(data))

```

## Adding PAH + PCB groups, 5 groups in total
```{r}

library(classInt)
library(dplyr)

# Extract the DryValue column
dry_values <- pcb$DryValue

# Compute Fisher-Jenks breaks for 6 groups
num_classes <- 8
breaks <- classIntervals(dry_values, num_classes, style = "fisher")$brks

# Print the breakpoints
print(breaks)

# Create group assignments based on the breaks
pcb$DryValue_Group <- cut(dry_values, breaks = breaks, labels = 1:num_classes, include.lowest = TRUE)

# Check the first few rows with the new grouping
head(pcb)


# write out new table

write.csv(pcb, "../data/pcb_grouping_for_averages.csv", row.names = FALSE)

```

## Geographic (lat/ long) (n=6)
```{r}

# make geographic clusters based on lat/ long coordinates in 5 groups since it looks like there are 5 distinct areas of sites

data<- read.csv("../data/full_bio_morph_with_groups.csv")

# use k-means clustering 
set.seed(123)
clusters <- kmeans(data[, c("latitude", "longitude")], centers = 6)
data <- data %>%
  mutate(geo_group = as.factor(clusters$cluster))

# lat/long ranges for each group
latlong_ranges <- data %>%
  group_by(geo_group) %>%
  summarize(
    lat_range = paste0(round(min(latitude), 2), " - ", round(max(latitude), 2)),
    long_range = paste0(round(min(longitude), 2), " - ", round(max(longitude), 2))
  ) %>%
  mutate(label = paste0("Group ", geo_group, "\nLat: ", lat_range, "\nLong: ", long_range))

# add lat/long ranges back to the df
data <- data %>%
  left_join(latlong_ranges, by = "geo_group")

#write.csv(data, "../data/full_bio_morph_with_geo_grouping.csv", row.names = FALSE)

```

# Grouping: Stats
### Note: we will proceed with the groupings using the cleaned data with outliers removed

## Set up Data for PERMANOVA/ ANOVA
```{r}

# verify data normality
shapiro.test(data$p450) # not normal
shapiro.test(data$sod) # not normal
shapiro.test(data$ci1) # normal
shapiro.test(data$avg_thickness) # normal

```

# P450
### Reporting Area
```{r}

library(vegan)

# outliers removed
# KW + Post Hoc
kruskal.test(p450 ~ reporting_area, data = pdata) # result: p< 6.616e-5

dunn <- dunnTest(pdata$p450, pdata$reporting_area, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc)
# Outcome: No significant result

# all data
# KW + Post Hoc
kruskal.test(p450 ~ reporting_area, data = data) # result: p= 0.0006252

dunn <- dunnTest(data$p450, data$reporting_area, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc)
# Outcome: No significant result

```

### Geographic Area
```{r}

library(vegan)
library(FSA)

# outliers removed
# KW + Post Hoc
kruskal.test(p450 ~ geo_group, data = data_clean_p450) # result: p= 0.01197

dunn_gg <- dunnTest(data_clean_p450$p450, data_clean_p450$geo_group, method = "bonferroni", list = TRUE)
mc_gg <- data.frame(
    Comparison = dunn_gg$comparisons,
    Z = dunn_gg$Z,
    P.adjusted = dunn_gg$P.adjusted
)
print(mc_gg)
# OUTCOME: No significant result

# all data
# KW + Post Hoc
kruskal.test(p450 ~ geo_group, data = data) # result: p= 0.05459, NO post hoc needed

```

### PCB Group
```{r}

library(vegan)

# KW + Post Hoc

# outliers removed
kruskal.test(p450 ~ pcb_group, data = data_clean_p450) # result: p= 0.004236

dunn <- dunnTest(data_clean_p450$p450, data_clean_p450$pcb_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc)
# Outcome: No significant result

# all data
kruskal.test(p450 ~ pcb_group, data = data) # result: p= 0.006079

dunn <- dunnTest(data$p450, data$pcb_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc)
# Outcome: No significant result
```

# SOD
### Reporting Area
```{r}

# outliers removed
# KW + Post Hoc
kruskal.test(sod ~ reporting_area, data = data_clean_sod) # result: p= 0.1601, NO post hoc needed

# all data
# KW + Post Hoc
kruskal.test(sod ~ reporting_area, data = data) # result: p= 0.07171, NO post hoc needed

```

### Geographic Group
```{r}

# KW + Post Hoc
kruskal.test(sod ~ geo_group, data = data_clean_sod) # result: p= 0.12, NO post hoc needed

# all data
kruskal.test(sod ~ geo_group, data = data) # result: p= 0.1535, NO post hoc needed
```

### PCB Group
```{r}

# KW + Post Hoc

# outliers removed
kruskal.test(sod ~ pcb_group, data = data_clean_sod) # result: p= 0.0895, NO post hoc needed

# all data
kruskal.test(sod ~ pcb_group, data = data) # result: p= 0.011
dunn <- dunnTest(data$sod, data$pcb_group, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc)
# OUTCOME: No significant results

```

# CF
### Reporting Area
```{r}

# ANOVA
# outliers removed
anova_result <- aov(condition_factor ~ reporting_area, data = data_clean_condition_factor)
summary(anova_result) #result: p= 0.063, no post hoc needed

# all data
anova_result <- aov(condition_factor ~ reporting_area, data = data)
summary(anova_result) #result: p< 2e-16
# Post-hoc 
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$reporting_area)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]

# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}

# OUTCOME: 8 significant pairings - all driven by RA 6 (6 is the difference)

```

### Geographic Group
```{r}

# ANOVA
# outliers removed
anova_result <- aov(condition_factor ~ geo_group, data = data_clean_condition_factor)
summary(anova_result) #result: p= 0.073, NO post hoc needed

# all data
anova_result <- aov(condition_factor ~ geo_group, data = data)
summary(anova_result) #result: p= 1.1e-12
# Post-hoc 
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$geo_group)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]

# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}

# OUTCOME: 4 significant pairings - all driven by GG 5 (5 is the difference)

```

### PCB Group
```{r}

# ANOVA
# outliers removed
anova_result <- aov(condition_factor ~ pcb_group, data = data_clean_condition_factor)
summary(anova_result) #result: p= 0.469, NO post hoc needed

# all data
anova_result <- aov(condition_factor ~ pcb_group, data = data)
summary(anova_result) #result: p= 0.000143
# Post-hoc 
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$pcb_group)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]

# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}

# OUTCOME: 4 significant pairings - all driven by PG 3, on the high end and the low end (3 is the difference)

```

# AT
### Reporting Area
```{r}

# ANOVA
# outliers removed
anova_result <- aov(avg_thickness ~ reporting_area, data = data_clean_avg_thickness)
summary(anova_result) #result: p< 1.8e-6
# Post-hoc test if significant
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$reporting_area)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]
# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}
# Outcome: 6 significant pairings, see table below

# all data
anova_result <- aov(avg_thickness ~ reporting_area, data = data)
summary(anova_result) #result: p< 1.09e-6
# Post-hoc 
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$reporting_area)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]
# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}
# Outcome: 6 significant pairings, see table below

```

### Geographic Area
```{r}

# ANOVA
anova_result <- aov(avg_thickness ~ geo_group, data = data_clean_avg_thickness)
summary(anova_result) #result: p< 1.01e-6
# Post-hoc 
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$geo_group)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]
# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}
# Outcome: 4 significant pairings, see table below

# all
anova_result <- aov(avg_thickness ~ geo_group, data = data)
summary(anova_result) #result: p= 2.4e-8
# Post-hoc 
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$geo_group)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]
# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}

# Outcome: 6 significant pairings, see table below

```

### PCB Group
```{r}

# ANOVA
anova_result <- aov(avg_thickness ~ pcb_group, data = data_clean_avg_thickness)
summary(anova_result) #result: p= 0.00194
# Post-hoc
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$pcb_group)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]
# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}
# Outcome: 1 significant pairing, see table below

# All
anova_result <- aov(avg_thickness ~ pcb_group, data = data)
summary(anova_result) #result: p= 0.000955
# Post-hoc
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$pcb_group)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]
# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}
# Outcome: 2 significant pairings, see table below
```

# Site (n=74)
### Note: Statistics (/01-stats.Rmd) confirm this grouping is an ineffective tool of analysis. Box plot added to illustrate difficulties
```{r}

library(vegan)

#p450 - outlier removed
kruskal.test(p450 ~ site_name, data = data_clean_p450) # result: p= 2.026e-5
dunn <- dunnTest(data_clean_p450$p450, data_clean_p450$site_name, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc)
# Outcome: No significant result

#p450 - all
kruskal.test(p450 ~ site_name, data = data) # result: p= 1.248e-5
dunn <- dunnTest(data$p450, data$site_name, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc)
# Outcome: No significant result

#sod - outlier removed
kruskal.test(sod ~ site_name, data = data_clean_sod) # result: p= 0.001075
dunn <- dunnTest(data_clean_sod$sod, data_clean_sod$site_name, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc)
# Outcome: No significant result

# sod - all
kruskal.test(sod ~ site_name, data = data) # result: p= 5.669e-6
dunn <- dunnTest(data$sod, data$site_name, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc)
# Outcome: No significant result

# CF
# ANOVA - outliers removed
anova_result <- aov(condition_factor ~ site_name, data = data_clean_condition_factor)
summary(anova_result) #result: p= 0.0044
# Post-hoc
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$site_name)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]
# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}
# Outcome: No significant pairings

# ANOVA - all
anova_result <- aov(condition_factor ~ site_name, data = data)
summary(anova_result) #result: p<2e-16
# Post-hoc
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$site_name)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]
# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}
# Outcome: 145 significant pairs

# AT
# ANOVA
anova_result <- aov(avg_thickness ~ site_name, data = data_clean_avg_thickness)
summary(anova_result) #result: p= 2.32e-14
# Post-hoc 
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$site_name)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]
# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}
# Outcome: 74 significant pairings, see table below

# AT
# ANOVA
anova_result <- aov(avg_thickness ~ site_name, data = data)
summary(anova_result) #result: p= 5.71e-16
# Post-hoc 
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$site_name)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]
# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}
# Outcome: 104 significant pairings, see table below

```

# PAH Group
```{r}

library(vegan)
library(FSA)

#p450 - outlier removed
kruskal.test(p450 ~ PAHgroup8, data = data_clean_p450) # result: p= 0.0351
dunn <- dunnTest(data_clean_p450$p450, data_clean_p450$PAHgroup8, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc)
# Outcome: No significant result

#p450 - all
kruskal.test(p450 ~ PAHgroup8, data = data) # result: p= 0.07763; NO post hoc needed

#sod - outlier removed
kruskal.test(sod ~ PAHgroup8, data = data_clean_sod) # result: p= 0.05526
dunn <- dunnTest(data_clean_sod$sod, data_clean_sod$PAHgroup8, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc)
# Outcome: No significant result

# sod - all
kruskal.test(sod ~ PAHgroup8, data = data) # result: p= 0.01387
dunn <- dunnTest(data$sod, data$PAHgroup8, method = "bonferroni", list = TRUE)
mc <- data.frame(
    Comparison = dunn$comparisons,
    Z = dunn$Z,
    P.adjusted = dunn$P.adjusted
)
print(mc)
# Outcome: No significant result

# CF
# ANOVA - outliers removed
anova_result <- aov(condition_factor ~ PAHgroup8, data = data_clean_condition_factor)
summary(anova_result) #result: p= 0.731, NO post hoc needed

# ANOVA - all
anova_result <- aov(condition_factor ~ PAHgroup8, data = data)
summary(anova_result) #result: p= 3.42e-7
# Post-hoc
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$PAHgroup8)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]
# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}
# Outcome: 7 significant pairs driven by group 8

# AT
# ANOVA - outliers removed
anova_result <- aov(avg_thickness ~ PAHgroup8, data = data_clean_avg_thickness)
summary(anova_result) #result: p= 0.00425
# Post-hoc 
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$PAHgroup8)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]
# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}
# Outcome: 4 significant pairings driven by group 1

# AT
# ANOVA - all
anova_result <- aov(avg_thickness ~ PAHgroup8, data = data)
summary(anova_result) #result: p= 0.000785
# Post-hoc 
tukey_results <- TukeyHSD(anova_result)
# Convert Tukey results to a data frame
tukey_df <- as.data.frame(tukey_results$PAHgroup8)
# Add row names (comparison groups) as a new column
tukey_df$Comparison <- rownames(tukey_df)
# Filter for significant results (p < 0.05)
significant_tukey <- tukey_df[tukey_df$`p adj` < 0.05, ]
# Print only significant results
if (nrow(significant_tukey) > 0) {
  print(significant_tukey)
} else {
  print("No significant differences found in Tukey's HSD (p < 0.05).")
}
# Outcome: 4 significant pairings driven by group 1

```