---
title: "02- Analysis Groups"
output:
  pdf_document: 
    fig_width: 20
    fig_height: 9
  html_document: 
    toc: true
    toc_float:
        collapsed: false
        smooth_scroll: true
    fig_width: 20
---

# Directory and doc rules

```{r, setup, eval=TRUE, include=TRUE}

knitr::opts_chunk$set(
  root.dir = here::here(),
  echo = TRUE,         # Display code chunks
  eval = TRUE,         # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  #fig.width = 15,       # Set plot width in inches
  #fig.height = 9,      # Set plot height in inches
  fig.align = "center" # Align plots to the center
)

```

# Load & Check Data
```{r}

# double check where you are
# *NOTE* see 00-data_cleaned for directory issue
getwd()

# load data
data<- read.csv("../data/cleaned/all_cleaned.csv")

# check it out
str(data) # checking df structure
# note that sample_id and site_number are integers and may need to be adjusted to characters for analysis

summary(data) #checking df contents

#colnames(data) <- tolower(colnames(data))

```

# Adding Identifiers for Grouping
## PCB (n=6)
### Note: Reporting Area is already in the df
```{r}

library(classInt)
library(dplyr)

df<- read.csv("../data/not_for_analysis/pcb_group_workbook.csv")

# Extract the DryValue column
dry_values <- df$DryValue

# Compute Fisher-Jenks breaks for 6 groups
num_classes <- 6
breaks <- classIntervals(dry_values, num_classes, style = "fisher")$brks

# Print the breakpoints
print(breaks)

# Create group assignments based on the breaks
df$DryValue_Group <- cut(dry_values, breaks = breaks, labels = 1:num_classes, include.lowest = TRUE)

# Check the first few rows with the new grouping
head(df)

# Assign the lowest group number for each site
df <- df %>%
  group_by(SiteName) %>%
  summarise(pcb_group = min(as.numeric(DryValue_Group))) %>%
  ungroup()

df <- df %>%
  rename(site_name = SiteName)

# Check results
print(df)

# Merge while keeping only matching site names
data <- left_join(data, df, by = "site_name")

# Check if each site in data now has a single assigned group
table(data$pcb_group)  # Ensure no duplicates within a site

# Check the first few rows
head(data)

# write out new table

#write.csv(data, "all_cleaned_with_groups.csv", row.names = FALSE)

```

## Geographic (lat/ long) (n=5)
```{r}

# make geographic clusters based on lat/ long coordinates in 5 groups since it looks like there are 5 distinct areas of sites

# reload data
data<- read.csv("../data/cleaned/all_cleaned_with_groups.csv")

# use k-means clustering 
set.seed(123)
clusters <- kmeans(data[, c("latitude", "longitude")], centers = 5)
data <- data %>%
  mutate(geo_group = as.factor(clusters$cluster))

# lat/long ranges for each group
latlong_ranges <- data %>%
  group_by(geo_group) %>%
  summarize(
    lat_range = paste0(round(min(latitude), 2), " - ", round(max(latitude), 2)),
    long_range = paste0(round(min(longitude), 2), " - ", round(max(longitude), 2))
  ) %>%
  mutate(label = paste0("Group ", geo_group, "\nLat: ", lat_range, "\nLong: ", long_range))

# add lat/long ranges back to the df
data <- data %>%
  left_join(latlong_ranges, by = "geo_group")

#write.csv(data, "all_cleaned_all_groups.csv", row.names = FALSE)

```

# Grouping: Stats
### Note: we will proceed with the groupings using the cleaned data with outliers removed

## Set up Data for PERMANOVA/ ANOVA
```{r}

# change to a factor
data$pcb_group <- as.factor(data$pcb_group)
data$geo_group <- as.factor(data$geo_group)
data$reporting_area <- as.factor(data$reporting_area)

# remove outliers
data_clean_p450 <- data %>% filter(!p450_outlier)
data_clean_sod <- data %>% filter(!sod_outlier)
data_clean_condition_factor <- data %>% filter(!condition_factor_outlier)
data_clean_avg_thickness <- data %>% filter(!avg_thickness_outlier)

# verify data normality
shapiro.test(data_clean_p450$p450) # not normal
shapiro.test(data_clean_sod$sod) # not normal
shapiro.test(data_clean_condition_factor$condition_factor) # normal
shapiro.test(data_clean_avg_thickness$avg_thickness) # normal

```

## P450
### Reporting Area
```{r}

library(vegan)
library(RVAideMemoire)

# p450
# PERMANOVA + Dispersion + Post Hoc
dist_matrix_p450 <- vegdist(data_clean_p450$p450, method = "euclidean") # create matrix

permanova_p450_ra <- adonis(dist_matrix_p450 ~ reporting_area, data = data_clean_p450, permutations = 999) # run permanova
print(permanova_p450_ra) # results

dispersion_p450_ra <- betadisper(dist_matrix_p450, data_clean_p450$reporting_area)
permutest_p450_ra <- permutest(dispersion_p450_ra) # dispersion, p> .05; results are valid
print(permutest_p450_ra) # p= 0.001 

pairwise_p450_ra <- pairwise.perm.manova(dist_matrix_p450, data_clean_p450$reporting_area, nperm = 999, p.method = "bonferroni")
pairwise_results <- as.data.frame(pairwise_p450_ra$p.value) # convert df

significant_p450_ra <- pairwise_results[pairwise_results$p.value < 0.05, ] #sig only
print(significant_p450_ra) # results - no significant result

```

## P450
### Geographic Area
```{r}

library(vegan)
library(RVAideMemoire)

# p450
# PERMANOVA + Dispersion + Post Hoc
dist_matrix_p450 <- vegdist(data_clean_p450$p450, method = "euclidean") # create matrix
permanova_p450_ra <- adonis(dist_matrix_p450 ~ reporting_area, data = data_clean_p450, permutations = 999) # run permanova
print(permanova_p450_ra) # results
dispersion_p450_ra <- betadisper(dist_matrix_p450, data_clean_p450$reporting_area)
permutest_p450_ra <- permutest(dispersion_p450_ra) # dispersion, p> .05; results are valid
print(permutest_p450_ra) # p= 0.001 
pairwise_p450_ra <- pairwise.perm.manova(dist_matrix_p450, data_clean_p450$reporting_area, nperm = 999, p.method = "bonferroni")
pairwise_results <- as.data.frame(pairwise_p450_ra$p.value) # convert df
significant_p450_ra <- pairwise_results[pairwise_results$p.value < 0.05, ] #sig only
print(significant_p450_ra) # results - no significant result

```

## P450
### PCB Group
```{r}

library(vegan)
library(RVAideMemoire)

# p450
# PERMANOVA + Dispersion + Post Hoc
dist_matrix_p450 <- vegdist(data_clean_p450$p450, method = "euclidean") # create matrix
permanova_p450_ra <- adonis(dist_matrix_p450 ~ reporting_area, data = data_clean_p450, permutations = 999) # run permanova
print(permanova_p450_ra) # results
dispersion_p450_ra <- betadisper(dist_matrix_p450, data_clean_p450$reporting_area)
permutest_p450_ra <- permutest(dispersion_p450_ra) # dispersion, p> .05; results are valid
print(permutest_p450_ra) # p= 0.001 
pairwise_p450_ra <- pairwise.perm.manova(dist_matrix_p450, data_clean_p450$reporting_area, nperm = 999, p.method = "bonferroni")
pairwise_results <- as.data.frame(pairwise_p450_ra$p.value) # convert df
significant_p450_ra <- pairwise_results[pairwise_results$p.value < 0.05, ] #sig only
print(significant_p450_ra) # results - no significant result

```

## SOD
### Reporting Area
```{r}

library(vegan)
library(RVAideMemoire)

# sod
# PERMANOVA + Dispersion + Post Hoc
dist_matrix_sod <- vegdist(data_clean_sod$sod, method = "euclidean") # create matrix
permanova_sod_ra <- adonis(dist_matrix_sod ~ reporting_area, data = data_clean_sod, permutations = 999) # run permanova
print(permanova_sod_ra) # results
dispersion_sod_ra <- betadisper(dist_matrix_sod, data_clean_sod$reporting_area)
permutest_sod_ra <- permutest(dispersion_sod_ra) # dispersion, p> .05; results are valid
print(permutest_sod_ra)
pairwise_sod_ra <- pairwise.perm.manova(dist_matrix_sod, data_clean_sod$reporting_area, nperm = 999, p.method = "bonferroni")
pairwise_results <- as.data.frame(pairwise_sod_ra$p.value) # convert df
significant_sod_ra <- pairwise_results[pairwise_results$p.value < 0.05, ] #sig only
print(significant_sod_ra) # results - no significant result

# cf
# ANOVA - morphometrics
anova_result <- aov(condition_factor ~ reporting_area, data = data_clean_condition_factor)
summary(anova_result)
# Post-hoc test if significant
TukeyHSD(anova_result)

# at
# ANOVA - morphometrics
anova_result <- aov(avg_thickness ~ reporting_area, data = data_clean_avg_thickness)
summary(anova_result)
# Post-hoc test if significant
TukeyHSD(anova_result)

```

## SOD
### Geographic Group
```{r}

library(vegan)
library(RVAideMemoire)

# sod
# PERMANOVA + Dispersion + Post Hoc
dist_matrix_sod <- vegdist(data_clean_sod$sod, method = "euclidean") # create matrix
permanova_sod_ra <- adonis(dist_matrix_sod ~ reporting_area, data = data_clean_sod, permutations = 999) # run permanova
print(permanova_sod_ra) # results
dispersion_sod_ra <- betadisper(dist_matrix_sod, data_clean_sod$reporting_area)
permutest_sod_ra <- permutest(dispersion_sod_ra) # dispersion, p> .05; results are valid
print(permutest_sod_ra)
pairwise_sod_ra <- pairwise.perm.manova(dist_matrix_sod, data_clean_sod$reporting_area, nperm = 999, p.method = "bonferroni")
pairwise_results <- as.data.frame(pairwise_sod_ra$p.value) # convert df
significant_sod_ra <- pairwise_results[pairwise_results$p.value < 0.05, ] #sig only
print(significant_sod_ra) # results - no significant result

```

## SOD
## PCB Group
```{r}

library(vegan)
library(RVAideMemoire)

# sod
# PERMANOVA + Dispersion + Post Hoc
dist_matrix_sod <- vegdist(data_clean_sod$sod, method = "euclidean") # create matrix
permanova_sod_ra <- adonis(dist_matrix_sod ~ reporting_area, data = data_clean_sod, permutations = 999) # run permanova
print(permanova_sod_ra) # results
dispersion_sod_ra <- betadisper(dist_matrix_sod, data_clean_sod$reporting_area)
permutest_sod_ra <- permutest(dispersion_sod_ra) # dispersion, p> .05; results are valid
print(permutest_sod_ra)
pairwise_sod_ra <- pairwise.perm.manova(dist_matrix_sod, data_clean_sod$reporting_area, nperm = 999, p.method = "bonferroni")
pairwise_results <- as.data.frame(pairwise_sod_ra$p.value) # convert df
significant_sod_ra <- pairwise_results[pairwise_results$p.value < 0.05, ] #sig only
print(significant_sod_ra) # results - no significant result

```

## CF
### Reporting Area


## CF 
### Geographic Group

## CF
### PCB Group

## AT
### Reporting Area

## AT
### Geographic Area

## AT
### PCB Group



## Site (n=74)
### Note: Statistics (/01-stats.Rmd) confirm this grouping is an ineffective tool of analysis. Box plot added to illustrate difficulties
```{r}

# save plot
#ggsave(plot=geopgraphic_boxplot, filename="/Users/cmantegna/Documents/Github/WDFWmussels/output/figures_manuscript/geographic_boxplot_p450.png", width=15, height=12)
```